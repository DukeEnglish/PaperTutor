Potential Based Diffusion Motion Planning
YunhaoLuo1 ChenSun1 JoshuaB.Tenenbaum2 YilunDu2
Abstract
Effective motion planning in high dimensional
spaces is a long-standing open problem in
robotics. One class of traditional motion plan-
ning algorithms corresponds to potential-based
motionplanning.Anadvantageofpotentialbased EnergyA EnergyB EnergyA+B
motionplanningiscomposability–differentmo-
Figure1:IllustrativeExampleofComposingDiffusionEnergy
tionconstraintscanbeeasilycombinedbyadding
Potentials.Ourapproachlearnsdifferentpotentialfunctionsover
corresponding potentials. However, construct- motionplanningtrajectoriesq (orangedashedlines).Different
1:N
ing motion paths from potentials requires solv- potentialscanbecombinedandoptimizedtoconstructnewmotion
ing a global optimization across configuration plansthatavoidobstaclesencodedinbothpotentialfunctions.
spacepotentiallandscape, whichisoftenprone
2011). Arecentbodyofworkshavefurtherexploredhow
tolocalminima. Weproposeanewapproachto-
learnedneuralnetworkscanbeintegratedwithmotionplan-
wardslearningpotentialbasedmotionplanning,
ningforacceleratedperformance (Ichter&Pavone,2019;
wherewetrainaneuralnetworktocaptureand
Qureshietal.,2019;Fishmanetal.,2023;Yamadaetal.,
learnaneasilyoptimizablepotentialsovermotion
2023;Leetal.,2023).
planningtrajectories. Weillustratetheeffective-
nessofsuchapproach,significantlyoutperform- Aclassicalapproachtowardsmotionplanningispotential
ingbothclassicalandrecentlearnedmotionplan- basedmotionplanning(Khatib,1986;Korenetal.,1991;
ning approaches and avoiding issues with local Ratliffetal.,2009;2018;Xieetal.,2020),wherebothob-
minima. Wefurtherillustrateitsinherentcompos- stacles and goals define energy potentials through which
ability, enabling us to generalize to a multitude trajectoriesareoptimizedtoreach. Anadvantageofpoten-
ofdifferentmotionconstraints. Projectwebsite tial based motion planning is that different constraints to
athttps://energy-based-model.github.io/potential- motion planning can be converted into equivalent energy
motion-plan. potentials and directly combined to optimize for motion
plans. However,potentialbasedmethodsrelyongradient
optimization with respect to local geometry, resulting in
1 Introduction thelong-standinglocalminimaissues(LaValle,2006). In
addition,suchmotionplanningtechniquestypicallyrequire
Motionplanningisafundamentalprobleminroboticsand implicitobstaclerepresentations,whichishardtoobtainin
aimstofindasmooth, collisionfreepathbetweenastart real-worldsettings.
andgoalstategivenaspecifiedconfigurationspace,andis
We present a potential based motion planning approach
heavilyusedacrossavarietyofdifferentroboticstaskssuch
leveraging diffusion models (Sohl-Dickstein et al., 2015;
asmanipulationornavigation(Laumondetal.,1998). Ava-
Hoetal.,2020)wherediffusionmodelsareusedtoparam-
rietyofapproachesexistformotionplanning,rangingfrom
eterizeandlearnpotentiallandscapesacrossconfiguration
classicalsamplingbasedapproaches(Kavrakietal.,1996;
spacetrajectoriesbetweenstartandgoalstates.Thesepoten-
Kuffner&LaValle,2000;Karaman&Frazzoli,2011;Gam-
tialfunctionscanbedirectlyinferredfromrawperceptual
melletal.,2015)andoptimizationbasedmethods(Ratliff
inputs, removing the need for implicit object representa-
et al., 2009; Mukadam et al., 2018; Kalakrishnan et al.,
tions. Furthermore, the annealed optimization procedure
1Brown University 2MIT. Correspondence to: Yunhao Luo acrossasequenceofpotentialenergylandscapesindiffusion
<yluo73@cs.brown.edu>.
models(Duetal.,2023)canhelpavoidlocalminimainopti-
mization. Thisoptimizationprocedureisfurtherstochastic,
Proceedings of the 41st International Conference on Machine
Learning,Vienna,Austria.PMLR235,2024.Copyright2024by enablingtheplannertogenerateamultitudeofmotionplans
theauthor(s). with diverse morphology for a specific problem, offering
1
4202
luJ
8
]OR.sc[
1v96160.7042:viXraPotentialBasedDiffusionMotionPlanning
various motion plan candidates for selection in test time. Bencyetal.,2019;Fishmanetal.,2023). Otherworkscom-
Finally, as our potential is defined globally over an envi- bineneuralnetworkwithsampling-basedmethods(Qureshi
ronment,itisguidedbybothlocalandglobalenvironment etal.,2019;Johnsonetal.,2021;Yu&Gao,2021;Lawson
geometry,andthusourmethodprovidesmoreaccurateplans & Qureshi, 2022), or combine trajectory level generative
thatrequiresignificantlylesscollisionchecking,compared modelswithspecificallydesignedcostfunctions(Sahaetal.,
withproblem-independentsampling-basedplanners. 2023;Carvalhoetal.,2023)thatrequiresprivilegedinfor-
mation.Thesemethodscanincreaseplanningspeed,expand
Onemajorhurdleoflearning-basedmotionplannersistheir
the planning horizon, or reduce the access queries to the
generalizabilitytoenvironmentswithunseen,morecomplex
environmentbyleveraginglearnedknowledge. However,
constraints. Forexample,alearnedmodeltrainedonsparse
theperformanceoflearnedmotion-planningapproacheson
obstacleswillperformpoorlyinscenarioswithclutteredob-
out-of-distributionenvironmentsoftensharplydegenerates.
stacles,assuchasettingisoutofdistribution. Ourapproach
In addition, many existing methods are only constrained
addressesthisthroughcompositionality–ourlearnedpoten-
tosimple2Denvironments(Yonetanietal.,2021;Chaplot
tialscanbeadditivelycomposedtogethertojointlysolve
etal.,2021;Tomaetal.,2021;Changetal.,2023;Carvalho
motion planning problems with larger sets of constraints
etal.,2022). Incontrast,wepresentalearning-basedpo-
thanseenattrainingtime.AsillustratedinFigure1,combin-
tentialmotionplanningapproach,requiringnogroundtruth
ingtwopotentialsfromdifferentdiffusionmodelsenables
knowledgeoftheoptimizedcostobjective,whichweillus-
ustooptimizefortrajectoriesthatsatisfybothconstraints,
tratecaneffectivelygeneralizetonewenvironmentsthrough
one to avoid obstacles in a cross, and a second to avoid
composabilityofpotentials.
obstaclesinasquare.Suchflexibilitytoad-hoccomposition
ofconstraintsisespeciallyusefulinroboticswhereagents DiffusionModelsforRobotics. Manyrecentworkshave
willoftenexperiencenewsetsofmotionconstraintsinits exploredtheapplicationofdiffusionmodelforrobotics(Jan-
environmentoverthecourseofexecution. neretal.,2022;Chenetal.,2022;Kapelyukhetal.,2023;
Haetal.,2023). Currentresearchspansavarietyofrobotics
Overall,inthispaper,ourcontributionsarethree-fold. (1)
problems, including action sequence generation (Liang
Wepresentanapproachtolearnedpotentialbasedmotion
etal.,2023;Fangetal.,2023;Lietal.,2023),policy(Wang
planningusingdiffusionmodels. (2)Weillustratetheeffec-
et al., 2023; Kang et al., 2023), grasping (Urain et al.,
tivenessofourapproach,outperformingexistingclassical
2023; Huang et al., 2023), and visuomotor planning or
and learned motion planning algorithms in accuracy and
control (Dalal et al., 2023; Yang et al., 2023a; Chi et al.,
collisionchecks. (3)Weillustratethecompositionalityof
2023), with recent work also exploring their application
motion planner, enabling it to generalize to multiple sets
in solving manipulation constraints (Yang et al., 2023b).
of motion constraints as well as an increased number of
In contrast to these works, we focus on how diffusion
objects.
models can be used to explicitly parameterize and learn
potentialsinpotential-basedmotionplanning. Weillustrate
2 RelatedWork the efficacy of such an approach across motion-planning
settingsanditsabilitytogeneralizetonewenvironments
Motion Planning. Classic sampling-based motion plan-
throughcompositionwithotherlearnedpotentials.
ners(Kavrakietal.,1996;Kuffner&LaValle,2000;Elban-
hawi & Simic, 2014; Gammell et al., 2014; Janson et al.,
3 Method
2015; Choudhury et al., 2016; Strub & Gammell, 2020)
havegainedwideadoptionduetotheirefficiencyandgener-
WefirstintroducepotentialbasedmotionplanninginSec-
alizability. However,problem-independentnatureofthese
tion3.1. Wethendiscusshowpotentialbasedmotionplan-
methodscanresultininefficiencyparticularlywhenplan-
ning can be implemented with diffusion models in Sec-
ningforsimilarproblemsrepetitively. Reactivemethods,
tion3.2. Wefurtherdiscusshowsuchanapproachenables
suchaspotential-basedapproaches(Khatib,1986;Ratliff
ustocombinemultipledifferentpotentialstogetherinSec-
etal.,2018;Xieetal.,2020),velocityobstacles(Fiorini&
tion 3.3. Following this, we discuss how we can refine
Shiller,1998;VandenBergetal.,2008),andsafetybarrier
motionplansgeneratedbydiffusionmodelsincasesofcol-
certificates(Wangetal.,2017)canprovidefastupdatesand
lision in Section 3.4. Finally, we show the probabilistic
havetheguaranteeforobstacleavoidance. However,their
completenessoftheproposedmethodinSection3.5.
performanceistypicallyconstrainedbylocalminimaornu-
mericalinstability(LaValle,2006),andtheyusuallyneedto
3.1 PotentialBasedMotionPlanning
constructobstaclerepresentationsintherobotconfiguration
space,whichishardtoobtainfromrawperception. Toad- Givenaspecifiedstartstateq andendstateq inaconfigu-
st e
dresstheseissues,recentworkshaveproposedmanydeep- rationspaceRn,motionplanningisformulatedasfinding
learning based motion planners (Ichter & Pavone, 2019; a collision-free trajectory q which starts from q and
1:N st
2PotentialBasedDiffusionMotionPlanning
S=100 S=80 S=60 S=40 S=20 S=0
Figure2:TrajectoryDenoisingProcess.ThetrajectoryisrandomlyinitializedfromGaussianintimestepS =100.Noiseisiteratively
removedviathegradientoftheenergyfunctionasgiveninequation5.AfeasibletrajectorycanbeobtainedattimestepS =0.
endsatq . Tosolveforsuchacollision-freetrajectoryq pose to learn an EBM (LeCun et al., 2006; Du & Mor-
e 1:N
in potential based motion planning (Khatib, 1986; Koren datch, 2019) across a dataset of solved motion plan-
etal.,1991), apotentialfunctionU(q) : Rn → Ronthe ning D = {qi,qi,qi ,Ci}, where e−Eθ(q1:T|qst,qe,C) ∝
st e 1:T
configurationspacecomposedof p(q |q ,q ,C). SincethedatasetDisofsolvedmotion
1:T st e
planningproblems,thelearnedenergyfunctionE willhave
U(q)=U (q)+U (q) (1) θ
att repel minimal energy at successful motion plans q∗ and thus
1:T
is defined, where U(q) assigns low potential value to the satisfyourpotentialfunctionU inEquation3.
θ
goalstateq andhighpotentialtoallstateswhichareincol-
e TolearntheEBMlandscapethatenablesustoeffectively
lision.InEquation1,U (q)representsaattractionpotential
att optimize and generate motion plans q∗ , we propose to
thathaslowvaluesatthetheendstateq andhighvalues 1:T
end shapetheenergylandscapeusingdenoisingdiffusiontrain-
awayfromit,andU (q)representsarepulsionpotential
repel ingobjective(Sohl-Dicksteinetal.,2015;Hoetal.,2020).
that has high values near obstacles and low values away
Inthisobjective,weexplicitlytraintheenergylandscape
them. ThefunctionalformofthepotentialfunctionU(q)
sogradientwithrespecttotheenergyfunctioncandenoise
providesaneasyapproachtointegrateadditionalobstacles
andrecoveramotionplanq acrossmanydifferinglevels
inmotionplanningbyaddinganewpotentialU (q)rep- 1:T
new ofnoisecorruption{1,...,S}rangingfrommostlycorrect
resentingobstaclestotheexistingpotentialinEquation1.
motionpathstofullycorruptedGaussiannoisetrajectories.
To obtain a motion plan from a potential function U(q), Byshapingthegradientoftheenergyfunctiontogenerate
a collision-free trajectory q 1:N from q st to q e is obtained motionplansq 1:T fromarbitraryinitializedtrajectories,our
byiterativelyfollowingthescaledgradientofthepotential learnedenergylandscapeisabletoeffectivelyoptimizefor
function motionpaths.
q =q −γ∇ U(q) (2)
t t−1 q
Formally, to train our potential, we use the energy based
with a successful motion plan constructed when the opti- diffusion training objective in (Du et al., 2023), where
mizationprocedurereachestheminimumofthepotential thegradientofenergyfunctionistrainedtodenoisenoise-
function U(q). A major limitation of above approach in corruptedmotionplansqi fromD,
1:T
Equation2islocalminima–iftheoptimizationprocedure
√ √
fallsinsuchaminima,themotionplanwillnolongersuc- L =∥ϵ−∇ E ( 1−β qi + β ϵ,s,qi,qi,Ci)∥2 (4)
MSE q1:T θ s 1:T s st e
cessfullyconstructpathsfromq toq (Yun&Tan,1997;
st e
Teli&Wani,2021;LaValle,2006). where ϵ is sampled from Gaussian noise N(0,1), s ∈
{1,2,...,S} is the denoising diffusion step (we set S =
100), and β is the corresponding Gaussian noise corrup-
3.2 PotentialBasedDiffusionMotionPlanning s
tiononamotionplanningpathqi . WerefertoE asthe
1:T θ
Wenextdiscusshowtolearnpotentialsforpotentialmotion diffusionpotentialfunction.
planning that enables us to effectively optimize samples.
Tooptimizeandsamplefromourdiffusionpotentialfunc-
Given a motion plan q from start state q to end state
1:T st tion, we initialize a motion path qS at diffusion step S
q and a configuration space characterization C (i.e. the 1:T
e
fromGaussiannoiseN(0,1)andoptimizeformotionpath
setofobstaclesintheenvironment),weproposetolearna
followingthegradientoftheenergyfunctionE . Weitera-
trajectory-levelpotentialfunctionU sothat θ
θ tivelyrefinethemotionpathqs acrosseachdiffusionstep
1:T
q∗ =argminU (q ,q ,q ,C) (3) following
1:T θ 1:T st e
q1:T
qs−1 =qs −γϵ+ξ, ξ ∼N(cid:0) 0,σ2I(cid:1) ,
where q∗ is a successful motion plan from q to q . 1:T 1:T s
1:T st e
ϵ=∇ E (q ,s,q ,q ,C) (5)
To learn the potential function in Equation 3, we pro- q1:T θ 1:T st e
3PotentialBasedDiffusionMotionPlanning
Algorithm1CompositionalPotentialBasedPlanning
1: Models: compositional set of N diffusion potential
functionsEi(q ,t,q ,q ,C )
θ 1:T st e i
2: Hyperparameters: trajectory horizon T, number of
denoisingdiffusionstepsS
InitialNoise ProposalPlan Noisy Replanned
3: Input: start position q st, end position q e, N motion denoise addnoise denoise
planningconstraintsC
1:N Figure 3: Visualization of the Motion Refining Scheme. A
4: Initializeq 1S :T ∼N(0,I) proposalplanisfirstgeneratedbydenoisinganinitialGaussian
5: for s=S...1 do noise.Ifcollisionisdetected,asmallnoiseisaddedtotheproposal
6: #CombiningDifferentEnergyPotentialsTogether and the new plan is generated by denoising the partially noisy
7: ϵ
comb
=(cid:80)N i=1∇ q1:TE θi(q 1s :T,s,q st,q e,C i) trajectory.
8: #TransittoNextDiffusionTimeStep
9: qs−1 =qs −γϵ +ξ, ξ ∼N(cid:0) 0,σ2I(cid:1) limit possible configuration space paths. For instance, in
1:T 1:T comb s autonomousdriving,constraintsthatcanarisemayinclude
10: endfor
movingpedestrians,trafficlanes,roadwork,orincoming
11: returnq0
1:T cars. Oftentimes,wecannotenumerateallpotentialcom-
binations,butwewishmotionplanningsystemstobeable
tohandleallpossiblecombinationsofconstraints. Jointly
ToparameterizetheenergyfunctionE (q ,s,q ,q ,C),
θ 1:T st e
learningasinglemotionplanningmodelforallconstraints
weuseclassifier-freeguidancescaleof2.0(Ho&Salimans,
maybedifficult,asattesttime,wemayseenovelcombi-
2022)toformapeakercompositeenergyfunctioncondi-
tioned on C. γ and σ2 are diffusion specific scaling con- nationsthatwedonothavetrainingdatafor. Bylearning
s
stants1. Thefinalpredictedmotionpathq∗ correspondsto separate diffusion potential fields for each constraint, we
theoutputq0 afterrunningS stepsofo1 p:T timizationfrom cancombinetheminanad-hocmannerattesttimetodeal
1:T witharbitrarysetsofconstraints. Weprovidetwoconcrete
thediffusionpotentialfunction.
implementations of composing potentials together below
andadetailedproceduralinAlgorithm1.
3.3 ComposingDiffusionPotentialFunctions
Generalization over More Obstacles. Suppose that the
Given two separate diffusion potential functions E1(·)
θ potential function E is trained on environments with 4
andE2(·),encodingseparateconstraintsformotionplan- θ
θ obstacles|C| = 4. However,intesttime,wewanttogen-
ning,wecanlikewiseformacompositepotentialfunction
eralize to a more complex environment that has 6 obsta-
Ecomb(·) = E1(·)+E2(·) by directly summing the cor-
clesC′ ={o ,o ,o ,o ,o ,o }. Thiscanbeachievedby
respondingpotentials. ThispotentialfunctionEcomb will 1 2 3 4 5 6
adding the potentials evaluated on two sets of obstacles,
have low energy precisely at motion planning paths q
1:T where C = {o ,o ,o ,o } and C = {o ,o ,o ,o }.
whichsatisfybothconstraints,withsamplingcorresponding 1 1 2 3 4 2 3 4 5 6
ThisformulationcanbefurtherextendedtoN setsofobsta-
tooptimizingthispotentialfunction. Tosamplefromthe
clesC andthecompositediffusionpotentialfunctionis
newdiffusionpotentialfunctionEcomb,wecanfollow 1:N
givenby:
qs−1 =qs −γϵcomb+ξ, ξ∼N(cid:0) 0,σ2I(cid:1) , (6) N
1:T 1:T s Ecomb(q ,s,q ,q ,C )= (cid:80) E (q ,s,q ,q ,C ) (7)
ϵcomb =∇ q1:T(E θ1(q 1:T,s,q st,q e,C 1)+E θ2(q 1:T,s,q st,q e,C 2)) θ 1:T st e 1:N i=1 θ 1:T st e i
Generalization over Static and Dynamic Obstacles.
Thiscompositepotentialisthegroundtruthpotentialcom-
Many real-life scenarios involve dynamic real-time inter-
biningconstraintsiftheconstraintsareindependent,which
action. Forinstance, toconstructmotionplansforanau-
issatisfiedifthesetoftrajectoriesgivenconstraintsareuni-
tonomousvehicle,wemustbothavoidstaticlaneobstacles
formlydistributed(seeAppendixC),andotherwiseserves
as well as moving cars. While static obstacles are often
asapproximateproxytooptimizemultipleconstraints.
knownapriori,themotionpatternsofdynamicsobstacles
Applications of Composing Potential Functions. The oftenchangewithtime,makingitadvantageoustobeable
abilitytocombinemultipleseparatepotentialfunctionsfor tocombinedifferentdynamicconstraintswithstaticones.
motionplanningoffersavarietyofdifferentwaystogener- Wecandirectlyimplementthisbyaddingdiffusionpoten-
alizeandextendexistingmotionplanningsystems. First,in tial function Ei that only trained on static obstacles Cs
θs i
manymotionplanningproblems,thereisoftenaheteroge- and diffusion potential function Ej that only trained on
noussetofdifferenttypesofconstraintsorcollisionsthat dynamicobstaclesCd. Inamoregeθ nd eralform,tocondition
j
on a set of N static obstacles Cs with their diffusion
1Arescalingtermateachdiffusionstepisomittedabovefor 1 1:N1
clarity potentialfunctionsE θ1 s:N1 andasetofN 2 dynamicC 1d :N2
4PotentialBasedDiffusionMotionPlanning
Algorithm2RefiningMotionPlans
1: Model: compositional potential denoiser
f (q ,s,q ,q ,C )
θ 1:T st e 1:N
2: Hyperparameters: numberofrefineattemptsR,noise
scalek
3: Input: trajectoryq 1:T,startpositionq st,endposition Maze2D KUKA7D DualKUKA14D
q ,N constraintsC
e 1:N Figure4:EnvironmentDemonstration.Maze2D:apointrobot
4: Z =Get Collision Sections(q) movingin2Dworkspacewiththehighlightedblocksasobstacles.
5: for r=1...R do KUKA:roboticarmwith7DoFoperatingonatabletop.Thegrey
√
6: q 1k :T = α¯ kq 1:T +(1−α¯ k)ξ, ξ ∼N(cid:0) 0,σ t2I(cid:1) cuboidsareobstacles.DualKUKA14D:TwosidebysideKUKA
7: q′ =f θ(q 1k :T,k,q st,q e,C 1:N), armsoperatesimultaneously.
8: forall z i ∈Z do
9: if is section good(q′[z i])then rithm2displaysthecompleterefiningpipelineandFigure3
10: q[z i]=q′[z i]; Z =Z\z i providesacorrespondingvisualization.
11: endif
12: endfor 3.5 ProbabilisticCompleteness
13: endfor
Inthissection,wewillshowtheprobabilisticcompleteness
14: returnq 1:T ofourmethod. Letf (q )denotetheprobabilitydensity
θ 1:T
functionoftheoutputdistributionD ofourdiffusionpo-
o
tentialmodel. Insuchlearnedneuraldistribution,alldata
obstacleswiththeirdiffusionpotentialfunctionsE1:N2,the
θd pointsq 1:T areassignedpositivedensity,thatis,
compositediffusionpotentialfunctioncanbewrittenas:
∀q , f (q )>0 (10)
Ecomb(q ,s,q ,q ,[Cs ,Cd ])= 1:T θ 1:T
θ 1:T st e 1:N1 1:N2
(cid:88)N1
E θi s(q 1:T,s,q st,q e,C
is)+(cid:88)N2
E θj d(q 1:T,t,q st,q e,C jd)
(8) D coe nfi sn tre aiJ ntc Cas
.
t The hea rese at lwo af ya sll ev xa isl ti sd atr sa mje ac lt lor ii ne ts ers vu ab lj ie nct thto
e
i=1 j=1 vicinityofarandomtrajectoryqc ∈J ,suchthat
1:T c
3.4 RefiningMotionPlans [q 1c
:T
−τ,q 1c
:T
+τ]⊆J c, τ >0 (11)
Inpractice,thepredictedmotionplanq 1:T mightoccasion- i.e.,alltrajectoriesintheintervalsatisfythegivenconstraint
ally contains sections that violate the constraints of the C. LetP denotetheprobabilityforourmodeltosamplea
τ
environment (i.e., collide with obstacles). To tackle this trajectoryfromtheinterval,andaccordingtoequation10
issue,bothclassicalandlearnedmotionplanners(Kuffner wehave,
&LaValle,2000;Qureshietal.,2019)providemechanisms (cid:90) qc +τ
1:T
torefinetrajectoriessubjecttocollisionsinconfiguration P τ = f(x)dx>0 (12)
space. Withdiffusionpotentialfields,wecanlikewisere- q 1c :T−τ
fineatrajectory,q 1:T withcollision,bylocallyperturbingit LetA ndenotetheeventthatthereisatleastonetrajectory
intoanoisytrajectoryqk definedbythek-thstepofthe q ∈ J among n sampled trajectories. Clearly, as the
1:T 1:T c
diffusionforwardprocess: numberofsamplesapproachesinfinity,eventAwillhappen
√ almostsurely,i.e.,
qk = α¯ q +(1−α¯ )ξ, ξ ∼N(cid:0) 0,σ2I(cid:1) (9)
1:T k 1:T k t
lim
P(cid:0)
A
(cid:1)
=1 (13)
n
asin(Hoetal.,2020). Anewmotionplanq′ canbeob- n→∞
1:T
tainedbydenoisingthenoisytrajectoryfollowingEquation Hence,ourmethodisprobabilisticallycomplete.
5, where q′ = f (qk ,k,q ,q ,C ) and f (·) is an
1:T θ 1:T st e 1:N θ
iterativediffusionpotentialdenoiserthatoutputsacleantra- 4 Experiments
jectory. Tofixtheproblematictrajectoryq ,thecollision
1:T
sectionsinq willbereplacedbythecorrespondingsec- Inthissection,wefirstdescribeourenvironmentsandbase-
1:T
tionsinq′ ifthesenewsectionsarecoherentandcollision- linesinSection4.1. Next, inSection4.2, wediscussour
1:T
free.Thisrefiningproceduralcanberepeateduntiladesired experimentsonthebaseenvironmentsandthemotionre-
trajectoryisfound. Thewarm-startdenoisingschemecan finingalgorithm. Following,inSection4.3,wepresentthe
enablefasterre-planningandmaintainthemorphologyof compositionalityresultsbyevaluatingourmotionplanner
the original plan, supporting planning on energy-critical on composite environments. Then, we describe the real
mobiledevicesorwhentheplanhasbeenexecuted. Algo- worldmotionplanningperformanceinSection4.4.
5PotentialBasedDiffusionMotionPlanning
Figure5:QuantitativeComparisonsinMotionPlanningEnvironments.Threemetricsofthreeenvironmentsfrom2Dto14Dare
reported.Fromlefttoright:a)numberofcollisionchecks,b)successrate,c)planningtime.
4.1 EnvironmentsandBaselines (a)
Wefirstclassifytheenvironmentsthatweevaluatedonto3
categoriesbythelevelofgeneralizationcapability:
• Base Environment: same number of constraints as in
trainingphase,constraintssampledfromthesamedistri-
butionasintraining.
• CompositeSameEnvironment: moreconstraintsthan
(b)
trainingphase,constraintssampledfromthesamedistri-
butionasintraining.
• Composite Different Environment: more constraints
than training phase, constraints sampled from different
distributions.
Oursimulatedmotionplanningenvironmentsarelistedbe-
Ours M𝜋Net
low and shown in Figure 4. See Appendix A.1 for more
details. Inallenvironments,themotionplanningtaskisto Figure 6: Qualitative Motion Plans in KUKA Environment.
generateafeasibletrajectoryfromthestartstatetothegoal Resultsoftwomotionplanningproblemareshownintworows.
Thelargegreen/pinkballindicatesthestart/goalstate.Ourmethod
state. TheagenttrajectoryisrepresentedinC-space,while
intheleftcolumngeneratessmoothandnear-optimaltrajectories,
obstaclesarerepresentedinworkspace.
whileinrow(a),thetrajectoryofMπNetchoosesalongerroute
from behind and gets stuck in some local regions, and in row
• Maze2D.Apoint-robotmovingina2Dworkspace. The
(b), MπNetcannotpassthroughthenarrowpassageandkeeps
configurationspaceisthex-ycoordinateoftheagent. We
hoveringnearthestartstate.
offertwovariants: StaticMaze2Dwhereobstaclesstayin
thesamelocationsandDynamicMaze2Dwhereobstacles
aremovinginrandomlygeneratedlineartrajectories. Forlearnedmotionplanners,wecompareourmethodwith:
• KUKA.AKUKAarmof7DoFoperatingonatabletop MPNet(Qureshietal.,2019),MπNet(Fishmanetal.,2023),
ina3Dworkspace. Thestart/goalisgivenasthe7Djoint andAMP-LS(Yamadaetal.,2023). MPNetistrainedon
stateoftheKUKAarm. trajectorieswithsparsewaypointsanduseMLPstoencode
environmentconfigurationandpredictthenextrobotstate.
• DualKUKA.TwoKUKAarmsareplacedsidebyside
MπNet is trained on dense trajectory waypoints and pre-
onatabletopandoperatingsimultaneously. Thestart/goal
dictsthemovementvectorinsteadofthenextrobotstate.
isgivenasthejointstatesoftwoKUKAarms(14DoF).
AMP-LSencodestherobotstateintoalatentfeatureand
Baselines. Fornon-learningmotionplanningmethods,our approachesthegoalstatebyiterativelyusingthegradientof
baselinesincludeclassicsampling-basedplanningbaseline severalplanninglossestoupdatethelatent. Asequenceof
RRT*(Karaman&Frazzoli,2011),sampling-basedmethod latentsarethendecodedandformatrajectory. Inevaluation,
withpotentialfunctionsbasedheuristicP-RRT*(Qureshi& allthestart/goalstatesandenvironmentconfigurationsare
Ayaz,2016),advancedsampling-basedmethodBIT*(Gam- unseentothemodels. Foreachexperiment,weevaluateon
melletal.,2015),sampling-basedmethodfordynamicen- 100differentenvironmentswith20randomlysampledstarts
vironmentsSIPP(Phillips&Likhachev,2011),andtradi- andgoalsineachenvironment. Nore-trainingisperformed
tional potential-based method RMP (Ratliff et al., 2018). intesttime.
6PotentialBasedDiffusionMotionPlanning
6 6+1 6+2
RMP BIT* Ours
6+3 6+4 6+5
Figure7:QualitativePerformanceonEnvironmentswithCon-
Figure8:QualitativeCompositionalGeneralizationoverMore
caveObstacles.Potential-basedplanningmethodRMPisprone
Obstacles.Twomodelsthattrainedononly6obstaclesarecom-
tolocalminima. BIT*isabletofindafeasiblesolution,butthe
posedandtestedonout-of-distributionenvironmentswith7,8,9,
trajectoriesareroughandrequiremuchlongerplanningtime,es-
10,11obstacles,respectively.
peciallyfortheharderprobleminthesecondrow. Trajectories
generatedbyourplannerarebothsmoothandshortinlength.
Maze2D–Convex Maze2D–Concave
4.2 PerformanceonBaseEnvironments Method Success Time Success Time
RRT* 98.8 0.95 92.1 2.14
Wefirstevaluatemotionplanningperformanceineachbase
P-RRT* 98.5 1.17 85.9 2.69
environment: randomly generated environments that fol-
BIT* 100.0 0.21 100.0 0.45
lowthesameproceduralgenerationpipelineasthetraining MPNet 88.4 0.21 84.3 0.38
environments. QuantitativeresultsareshowninFigure5 MπNet 97.9 0.07 96.9 0.10
andAppendixB.1. Weincludethefulldetailsofevaluation MPD 77.9 2.99 44.4 3.93
RMP 64.9 0.13 28.0 0.34
setupinAppendixA.2.3.
Ours 100.0 0.12 100.0 0.15
Comparison to Sampling-based Planners. We set the
planning time limit to 5 seconds for all sampling-based Table2:QuantitativePerformanceonConvexandConcaveOb-
stacles.MotionplanningperformanceonMaze2Denvironments
methods. BothRRT*,P-RRT*,andBIT*cansucceedin
with6convexobstacles(left)and7concaveobstacles(right).The
thebaseMaze2Denvironment. However,theirsuccessrates
proposeddiffusionpotentialplanneroutperformsthetraditional
sufferfromasignificantdegradationwhenthedimension potential-basedmethodRMPanddiffusionmotionplanningcoun-
oftheconfigurationspaceincreases. Theplanningtimeof terpartMPDbyamargin.Whilebothourmethodandtheadvanced
thesampling-basedplannersalsorisesdramaticallyasthe sampling-basedmethodBIT*cansolvealltheproblems,oursre-
quiressignificantlylessplanningtimethanBIT*.
dimensionofthespaceincreases. Bycontrast,thesuccess
ratesofourmethodsurpassallbaselinesandareconsistent
allbaselinesinbothsuccessrateandnumberofcollision
across different environments, achieving this in less than
check. InDualKUKA,ourmethodleadsthestate-of-the-art
11%ofBIT*’splanningtimeandrequiringuptotwoorders
learning-based planner MπNet by nearly 35% in success
ofmagnitudefewercollisionchecks.
rate while with less than 40% of its planning time and 7
ComparisontoLearning-basedPlanners. Wealsocom- times less of its collision checks. We also observe that
pare to three learning-based motion planning baselines: theperformanceofotherplannersdropquicklyasthediffi-
MPNet, MπNet, and AMP-LS. Our method outperforms cultyincreases,whileourplannerperformssteadilyacross
R=3 R=5 R=10 allenvironments. ThoughtheplanningtimeofMπNetin
Maze2Disslightlyshorterthanours,thegapisclosingas
Env Before After Before After Before After
thedimensionoftheconfigurationspaceincreases,andin
Maze2D 96.3 99.8 95.3 99.0 95.8 100.0
DualKUKA,ourplannerrequireslessplanningtimethan
KUKA 71.3 90.0 69.5 94.3 69.8 94.8
allbaselines,probablyduetotheexpensivecostofcollision
DualKUKA 45.5 69.8 47.3 77.3 47.0 80.8
checksandhighertaskcomplexity. Qualitativecomparisons
Table1:QuantitativeResultsofMotionPlanRefining.Success areshowninFigure6and18.
ratesbeforeandaftermotionrefiningareshown. Rdenotesthe
numberofrefiningattempts. Theproposedrefiningmethodcan Environments with Concave Obstacles. We construct
consistentlyboostsuccessratesonthreebaseenvironments. additionalMaze2Denvironmentswhereobstaclesarecon-
7PotentialBasedDiffusionMotionPlanning
Baseline
Composed
(a) (b) (c) (d)
Figure10: QualitativeRealWorldMotionPlans,HotelScene.
Thecomposedmodelprovideslong-horizonmotionplanthatavoid
10pedestrians,whileonlytrainedon5pedestrians.Incolumn(a)
and(b),thecomposedplanisawareofP1(cyan)andP6(pink)
andovertakesthemfromabove,whilethebaselinemodelrunsinto
them.Incolumn(c),thecomposedmotionplanchoosestomove
fastersoastopassthroughtheintersectionwithP7(brown)before
P7arrives,butthebaselinemotionplanresultsinacollisiondue
toitsslowerspeed. Incolumn(d),thecomposedplanchooseto
goupwardtoavoidtheoncomingP8(black).
BaseDynamic Static1+Dynamic Static2+Dynamic
Figure9:CompositionalGeneralization.Quantitativecompar- M Suc Time Col Suc Time Col Suc Time Col
isonsofdifferentplanneroncompositeenvironments.Theshaded SIPP 69.9 32.2 1M+ 70.4 185.5 1.7M+ 74.0 98.7 1.3M+
areas represent standard errors. Each graph’s leftmost column Ours 99.5 0.13 168.8 96.6 4.31 828.6 97.5 4.23 646.4
displaysresultsforenvironmentsthatcontainthesamenumberof
obstaclesasencounteredduringtraining.Bycomposingpotentials
Table3: QuantitativeResultsonBaseDynamicandStatic+
attesttime,ourmethod(redline)cangeneralizetoenvironments
DynamiconMaze2D.Static1andStatic2refertotwodifferent
withmuchmoreobstaclesthantrainingtime.
staticMaze2Denvironments.Ourplannercangeneralizetoenvi-
cavetodemonstratethecapabilityofourlearnedpotential ronmentswithbothstaticanddynamicobstacleswhileonlysepa-
ratelytrainedonstaticenvironmentsordynamicenvironments.
motion planner to avoid local minima. As shown in Fig-
ure 7, potential-based method RMP tends to get trapped
motion plan, the diffusion potential model might need to
inlocalminimainenvironmentsfilledwithconcaveobsta-
resampleatrajectoryfrompurenoise.
cles. In addition, we observe that BIT* is able to find a
feasiblemotionplan,butthemorphologyoftheproposed
4.3 PerformanceonCompositeEnvironments
trajectoriesaresharpandirregular. Wefurtherpresentthe
quantitativeresultsonbaseMaze2DenvironmentsinTable ComposingObstacles. Wefirstevaluatethecomposition-
2,whereweincludeanadditionaldiffusion-basedmotion alitybyaddingobstaclestotheenvironments. Qualitative
planningapproach(Carvalhoetal.,2023). Notably,ourdif- results of composite Maze2D environments are given in
fusionpotentialplanneristheonlylearning-basedapproach Figure8,wherewetrainourmodelon6obstaclesandeval-
thatsuccessfullysolveseverymotionplanningproblemsin uateonenvironmentswithupto11obstacles. Eachorange
ourevaluationset. Althoughtheadvancedsampling-based blockrepresentsanextraobstacleaddedtothetesttimeen-
methodBIT*canalsofindallthesolutions,itsaverageplan- vironments. Aswecansee,thecomposedmodeleffectively
ningtimeissignificantlylonger,takingthreetimeslonger proposes different trajectories according to the presented
thanourmethodinMaze2D–Concave. Moreresultsare obstacles by sampling from the composite potential. We
providedinAppendixB.4. reportthequantitativeperformanceonthreeenvironments
withdifferentconfigurationspacedimensionsinFigure9.
MotionRefining. Wepresentquantitativeandqualitative
MoreresultsareshowninAppendixB.2. Inaddition,we
resultsofrefiningmotionplansinTable1andFigure3. The
furtherincludeabaselinewhichdirectlylearnsdemonstra-
gain of refining motion plans increases as the dimension
tionsofdifferentnumbersandtypesofobstaclesinasingle
of the environment increases. As shown in Table 1, the
diffusionpotentialfunctioninAppendixB.6.
successrategenerallyincreasesasweincreasethenumber
ofrefiningattemptsR,butthegaingraduallysaturatesin10 ComposingMultipleConstraints. Wetheninvestigatethe
attempts. Inthiscase,theproposedtrajectoryprobablysuf- compositionalitytocombinetwodifferentdiffusionpoten-
fersfromacatastrophiccollision,andtoobtainasuccessful tialfunctionstogether,i.e.,modelstrainedoncompletely
8PotentialBasedDiffusionMotionPlanning
different environments. Specifically, we separately train andadvantagesovertraditionalpotentialbasedplanner. We
amodelon6smallobstacles(Static1)andamodelon3 illustratethemotionplanningperformanceofourapproach
largeobstacles(Static2)andevaluatethecomposedmodel in terms of success rate, planning time, and the number
onenvironmentswherebothsmallandlargeobstaclesare of collision checks over motion planning problems with
presented. Quantitativeandqualitativeresultsareshownin dimensionof2D,7D,14D.Wefurtherillustratethecompo-
Table13andFigure12. Moreover,wecomposethemodels sitionalityoftheapproach,enablinggeneralizationtoboth
trainedonstaticenvironmentswithanothermodeltrained newobjectsandnewcombinationsofmotionconstraints.
ondynamicenvironments,bywhichthecomposedmodel Finally,weillustratethepotentialofourworkonrealworld
can generalize to environments where both static and dy- sceneswithmulti-agentinteraction.
namicobstaclesarepresented,namelyStatic1+Dynamic
andStatic2+Dynamic. Thecorrespondingquantitativere-
Acknowledgements
sultsareshowninTable3. TheplanningtimelimitforSIPP
issetto60s/300sforbase/compositedynamicenvironments. WeacknowledgesupportfromNSFgrant2214177;from
PleaserefertoFigure14andFigure15inAppendixB.3for AFOSRgrantFA9550-22-1-0249;fromONRMURIgrant
morequalitativeresults. N00014-22-1-2740;fromAROgrantW911NF-23-1-0034;
andfromtheSamsungGlobalResearchOutreachProgram.
4.4 PerformanceonRealWorldDatasets YilunDuissupportedbyaNSFGraduateFellowship. We
thanktheanonymousreviewersfortheircarefulreview. Our
Finally,weevaluatetheeffectivenessofourmethodonthe
researchwasconductedusingcomputationalresourcesat
realworldETH/UCY(Pellegrinietal.,2010;Lerneretal.,
the Center for Computation and Visualization at Brown
2007) dataset. The dataset we used consists of 6 scenes
University.
(ETH, Hotel, Zara01, Zara02, Students01, Students03),
where each scene contains human trajectories in world-
ImpactStatement
coordinates collected by manual annotation from a bird-
eye-viewcamera. Ourfocusistoinvestigateifourmodel
Thispaperpresentsworkwhosegoalistoadvancethefield
canproposesuccessfultrajectoriesgiventhestartandgoal
of Machine Learning. There are many potential societal
locations of an agent in a random, cluttered street-level
consequences of our work, which we believe should be
real-worldinteraction. Specifically,theplanneristrained
similartoagenericmachinelearningpaper. Forexample,if
to predict the trajectory of the agent (highlighted in red),
themotionpatterninthedatasetisbiased,themotionplans
conditionedonthetrajectoriesof5otherpedestrians. The
generated by our model might have similar biases as the
training data contains 5 scenes and the held-out scene is
trainingdataset.Nootherissueswefeelmustbespecifically
usedforevaluation. InFigure17, wepresentthequalita-
highlightedhere.
tive results where 5 other pedestrians are presented. We
also evaluate on 10 presented pedestrians by composing
References
twopotentialfunctionseachconstrainedby5pedestrians,
asillustratedinFigure10. Detailssettingsandqualitative
Ajay, A., Du, Y., Gupta, A., Tenenbaum, J. B., Jaakkola,
resultsarepresentedinAppendixB.5.
T.S.,andAgrawal,P. Isconditionalgenerativemodeling
all you need for decision making? In The Eleventh
5 Discussion InternationalConferenceonLearningRepresentations,
2023.
Limitations. Ourexistingformulationofpotentialbased
diffusionmotionplannerhasseverallimitations. First,al-
Bency,M.J.,Qureshi,A.H.,andYip,M.C. Neuralpath
though our motion trajectory is accurate, it is often sub-
planning: Fixedtime,near-optimalpathgenerationvia
optimal,e.g.,thereexistsashorterpathfromstarttogoal.
oracleimitation. In2019IEEE/RSJInternationalCon-
Thismaybeaddressedbyaddinganadditionalpotentialto
ference on Intelligent Robots and Systems (IROS), pp.
reachthegoalassoonaspossible. Second,ourapproach
3965–3972.IEEE,2019.
tocomposingpotentialsscaleslinearlywiththenumberof
composed models, requiring significantly more computa-
Carvalho,J.,Baierl,M.,Urain,J.,andPeters,J.Conditioned
tionpowerwithadditionalmodels. Thiscanberemedied
score-basedmodelsforlearningcollision-freetrajectory
byhavingdifferentpotentialoperateonsharedfeaturesina
generation. InNeurIPS2022WorkshoponScore-Based
network.
Methods,2022.
Conclusion. Inthiswork,wehaveintroducedapotential
baseddiffusionmotionplanner. Wefirstformulateourdif- Carvalho, J., Le, A. T., Baierl, M., Koert, D., and Peters,
fusionpotentialmotionplanneranddescribeitsconnections J. Motion planning diffusion: Learning and planning
9PotentialBasedDiffusionMotionPlanning
ofrobotmotionswithdiffusionmodels. arXivpreprint Fiorini, P. and Shiller, Z. Motion planning in dynamic
arXiv:2308.01557,2023. environmentsusingvelocityobstacles. Theinternational
journalofroboticsresearch,17(7):760–772,1998.
Chang,J.,Ryu,H.,Kim,J.,Yoo,S.,Seo,J.,Prakash,N.,
Choi,J.,andHorowitz,R. Denoisingheat-inspireddif- Fishman,A.,Murali,A.,Eppner,C.,Peele,B.,Boots,B.,
fusionwithinsulatorsforcollisionfreemotionplanning. andFox,D. Motionpolicynetworks. InConferenceon
arXivpreprintarXiv:2310.12609,2023. RobotLearning,pp.967–977.PMLR,2023.
Gammell,J.D.,Srinivasa,S.S.,andBarfoot,T.D.Informed
Chaplot, D. S., Pathak, D., and Malik, J. Differentiable
rrt: Optimalsampling-basedpathplanningfocusedvia
spatialplanningusingtransformers.InInternationalCon-
directsamplingofanadmissibleellipsoidalheuristic. In
ference on Machine Learning, pp. 1484–1495. PMLR,
2014IEEE/RSJinternationalconferenceonintelligent
2021.
robotsandsystems,pp.2997–3004.IEEE,2014.
Chen,H.,Lu,C.,Ying,C.,Su,H.,andZhu,J. Offlinerein-
Gammell,J.D.,Srinivasa,S.S.,andBarfoot,T.D. Batch
forcementlearningviahigh-fidelitygenerativebehavior
informedtrees(bit*): Sampling-basedoptimalplanning
modeling. arXivpreprintarXiv:2209.14548,2022.
viatheheuristicallyguidedsearchofimplicitrandomgeo-
metricgraphs. In2015IEEEinternationalconferenceon
Chi, C., Feng, S., Du, Y., Xu, Z., Cousineau, E., Burch-
roboticsandautomation(ICRA),pp.3067–3074.IEEE,
fiel, B., and Song, S. Diffusion policy: Visuomotor
2015.
policy learning via action diffusion. arXiv preprint
arXiv:2303.04137,2023. Ha,H.,Florence,P.,andSong,S. Scalingupanddistilling
down: Language-guided robot skill acquisition. arXiv
Choudhury,S.,Gammell,J.D.,Barfoot,T.D.,Srinivasa, preprintarXiv:2307.14535,2023.
S. S., and Scherer, S. Regionally accelerated batch in-
formed trees (rabit*): A framework to integrate local Hendrycks,D.andGimpel,K. Gaussianerrorlinearunits
informationintooptimalpathplanning. In2016IEEE (gelus). arXivpreprintarXiv:1606.08415,2016.
International Conference on Robotics and Automation
Ho,J.andSalimans,T. Classifier-freediffusionguidance.
(ICRA),pp.4207–4214.IEEE,2016.
arXivpreprintarXiv:2207.12598,2022.
Coumans, E. and Bai, Y. Pybullet, a python module for Ho,J.,Jain,A.,andAbbeel,P. Denoisingdiffusionprob-
physicssimulationforgames,roboticsandmachinelearn- abilistic models. In Advances in Neural Information
ing. http://pybullet.org,2016–2021. ProcessingSystems,volume33,pp.6840–6851,2020.
Dalal,M.,Mandlekar,A.,Garrett,C.,Handa,A.,Salakhut- Huang,S.,Wang,Z.,Li,P.,Jia,B.,Liu,T.,Zhu,Y.,Liang,
dinov, R., and Fox, D. Imitating task and motion W.,andZhu,S.-C. Diffusion-basedgeneration,optimiza-
planningwithvisuomotortransformers. arXivpreprint tion, andplanningin3dscenes. InProceedingsofthe
arXiv:2305.16309,2023. IEEE/CVFConferenceonComputerVisionandPattern
Recognition(CVPR),pp.16750–16761,June2023.
Du,Y.andMordatch,I. Implicitgenerationandmodeling
Ichter,B.andPavone,M. Robotmotionplanninginlearned
withenergybasedmodels. AdvancesinNeuralInforma-
latentspaces. IEEERoboticsandAutomationLetters,4
tionProcessingSystems,32,2019.
(3):2407–2414,2019.
Du, Y., Durkan, C., Strudel, R., Tenenbaum, J.B., Diele-
Janner, M., Du, Y., Tenenbaum, J., and Levine, S. Plan-
man,S.,Fergus,R.,Sohl-Dickstein,J.,Doucet,A.,and
ning with diffusion for flexible behavior synthesis. In
Grathwohl,W.S. Reduce,reuse,recycle: Compositional
InternationalConferenceonMachineLearning,2022.
generationwithenergy-baseddiffusionmodelsandmcmc.
In International Conference on Machine Learning, pp. Janson,L.,Schmerling,E.,Clark,A.,andPavone,M. Fast
8489–8510.PMLR,2023. marchingtree: Afastmarchingsampling-basedmethod
foroptimalmotionplanninginmanydimensions. The
Elbanhawi,M.andSimic,M. Sampling-basedrobotmotion Internationaljournalofroboticsresearch,34(7):883–921,
planning: Areview. Ieeeaccess,2:56–77,2014. 2015.
Fang,X.,Garrett,C.R.,Eppner,C.,Lozano-Pe´rez,T.,Kael- Johnson,J.J.,Kalra,U.S.,Bhatia,A.,Li,L.,Qureshi,A.H.,
bling, L. P., and Fox, D. Dimsam: Diffusion models andYip,M.C. Motionplanningtransformers: Amotion
assamplersfortaskandmotionplanningunderpartial planning framework for mobile robots. arXiv preprint
observability. arXivpreprintarXiv:2306.13196,2023. arXiv:2106.02791,2021.
10PotentialBasedDiffusionMotionPlanning
Kalakrishnan,M.,Chitta,S.,Theodorou,E.,Pastor,P.,and Lerner,A.,Chrysanthou,Y.,andLischinski,D. Crowdsby
Schaal,S. Stomp: Stochastictrajectoryoptimizationfor example. InComputergraphicsforum,volume26,pp.
motionplanning. In2011IEEEinternationalconference 655–664.WileyOnlineLibrary,2007.
onroboticsandautomation,pp.4569–4574.IEEE,2011.
Li,W.,Wang,X.,Jin,B.,andZha,H.Hierarchicaldiffusion
Kang,B.,Ma,X.,Du,C.,Pang,T.,andYan,S. Efficientdif- forofflinedecisionmaking. 2023.
fusionpoliciesforofflinereinforcementlearning. arXiv
preprintarXiv:2305.20081,2023. Liang, Z., Mu, Y., Ding, M., Ni, F., Tomizuka, M., and
Luo, P. Adaptdiffuser: Diffusion models as adaptive
Kapelyukh,I.,Vosylius,V.,andJohns,E. Dall-e-bot: In- self-evolvingplanners. InInternationalConferenceon
troducingweb-scalediffusionmodelstorobotics. IEEE MachineLearning,2023.
RoboticsandAutomationLetters,2023.
Liu,N.,Li,S.,Du,Y.,Torralba,A.,andTenenbaum,J.B.
Karaman,S.andFrazzoli,E. Sampling-basedalgorithms Compositionalvisualgenerationwithcomposablediffu-
foroptimalmotionplanning. Theinternationaljournal sionmodels. arXivpreprintarXiv:2206.01714,2022.
ofroboticsresearch,30(7):846–894,2011.
Mukadam,M.,Dong,J.,Yan,X.,Dellaert,F.,andBoots,
Kavraki,L.E.,Svestka,P.,Latombe,J.-C.,andOvermars, B. Continuous-timegaussianprocessmotionplanning
M.H. Probabilisticroadmapsforpathplanninginhigh- viaprobabilisticinference. TheInternationalJournalof
dimensionalconfigurationspaces. IEEEtransactionson RoboticsResearch,37(11):1319–1340,2018.
RoboticsandAutomation,12(4):566–580,1996.
Pellegrini, S., Ess, A., and Van Gool, L. Improving data
Khatib,O. Real-timeobstacleavoidanceformanipulators
associationbyjointmodelingofpedestriantrajectories
andmobilerobots. Theinternationaljournalofrobotics andgroupings. InComputerVision–ECCV2010: 11th
research,5(1):90–98,1986.
European Conference on Computer Vision, Heraklion,
Crete,Greece,September5-11,2010,Proceedings,Part
Kingma,D.P.andWelling,M. Auto-encodingvariational
I11,pp.452–465.Springer,2010.
bayes. arXivpreprintarXiv:1312.6114,2013.
Phillips, M. and Likhachev, M. Sipp: Safe interval path
Koren,Y.,Borenstein,J.,etal. Potentialfieldmethodsand
planning for dynamic environments. In 2011 IEEE in-
theirinherentlimitationsformobilerobotnavigation. In
ternationalconferenceonroboticsandautomation,pp.
Icra,volume2,pp.1398–1404,1991.
5628–5635.IEEE,2011.
Kuffner,J.J.andLaValle,S.M. Rrt-connect: Anefficient
approachtosingle-querypathplanning. InProceedings Qureshi,A.H.andAyaz,Y. Potentialfunctionsbasedsam-
2000ICRA.MillenniumConference.IEEEInternational plingheuristicforoptimalpathplanning. Autonomous
ConferenceonRoboticsandAutomation.SymposiaPro-
Robots,40:1079–1093,2016.
ceedings(Cat.No.00CH37065),volume2,pp.995–1001.
Qureshi,A.H.,Simeonov,A.,Bency,M.J.,andYip,M.C.
IEEE,2000.
Motionplanningnetworks. In2019InternationalConfer-
Laumond,J.-P.etal. Robotmotionplanningandcontrol, enceonRoboticsandAutomation(ICRA),pp.2118–2124.
volume229. Springer,1998. IEEE,2019.
LaValle,S.M. Planningalgorithms. Cambridgeuniversity Ratliff, N., Zucker, M., Bagnell, J. A., and Srinivasa, S.
press,2006. Chomp: Gradientoptimizationtechniquesforefficient
motionplanning. In2009IEEEinternationalconference
Lawson,D.andQureshi,A.H. Controltransformer: Robot onroboticsandautomation,pp.489–494.IEEE,2009.
navigationinunknownenvironmentsthroughprm-guided
return-conditioned sequence modeling. arXiv preprint Ratliff, N. D., Issac, J., Kappler, D., Birchfield, S., and
arXiv:2211.06407,2022. Fox, D. Riemannian motion policies. arXiv preprint
arXiv:1801.02854,2018.
Le,A.T.,Chalvatzaki,G.,Biess,A.,andPeters,J. Accel-
eratingmotionplanningviaoptimaltransport. InIROS Rezende,D.J.andViola,F. Tamingvaes. arXivpreprint
2023WorkshoponDifferentiableProbabilisticRobotics: arXiv:1810.00597,2018.
EmergingPerspectivesonRobotLearning,2023.
Saha,K.,Mandadi,V.,Reddy,J.,Srikanth,A.,Agarwal,A.,
LeCun,Y.,Chopra,S.,Hadsell,R.,Ranzato,M.,andHuang, Sen,B.,Singh,A.,andKrishna,M. Edmp: Ensemble-
F. Atutorialonenergy-basedlearning. Predictingstruc- of-costs-guided diffusion for motion planning. arXiv
tureddata,1(0),2006. preprintarXiv:2309.11414,2023.
11PotentialBasedDiffusionMotionPlanning
Sohl-Dickstein, J., Weiss, E., Maheswaranathan, N., and Yang, M., Du, Y., Dai, B., Schuurmans, D., Tenenbaum,
Ganguli,S. Deepunsupervisedlearningusingnonequi- J.B.,andAbbeel,P. Probabilisticadaptationoftext-to-
libriumthermodynamics. InInternationalConferenceon videomodels. arXivpreprintarXiv:2306.01872,2023a.
MachineLearning,pp.2256–2265.PMLR,2015.
Yang,Z.,Mao,J.,Du,Y.,Wu,J.,Tenenbaum,J.B.,Lozano-
Song, J., Meng, C., and Ermon, S. Denoising diffusion Pe´rez,T.,andKaelbling,L.P. Compositionaldiffusion-
implicitmodels. arXivpreprintarXiv:2010.02502,2020. based continuous constraint solvers. arXiv preprint
arXiv:2309.00966,2023b.
Strub, M. P. and Gammell, J. D. Advanced bit (abit):
Sampling-based planning with advanced graph-search Yonetani,R.,Taniai,T.,Barekatain,M.,Nishimura,M.,and
techniques. In2020IEEEInternationalConferenceon Kanezaki,A. Pathplanningusingneurala*search. In
Robotics and Automation (ICRA), pp. 130–136. IEEE, Internationalconferenceonmachinelearning,pp.12029–
2020. 12039.PMLR,2021.
Yu, C. and Gao, S. Reducing collision checking for
Teli, T.A.andWani, M.A. Afuzzybasedlocalminima
sampling-basedmotionplanningusinggraphneuralnet-
avoidance path planning in autonomous robots. Inter-
works. AdvancesinNeuralInformationProcessingSys-
nationalJournalofInformationTechnology,13:33–40,
tems,34:4274–4289,2021.
2021.
Yun, X. and Tan, K.-C. A wall-following method for es-
Toma,A.-I.,Jaafar,H.A.,Hsueh,H.-Y.,James,S.,Lenton,
capinglocalminimainpotentialfieldbasedmotionplan-
D.,Clark,R.,andSaeedi,S.Waypointplanningnetworks.
ning. In19978thInternationalConferenceonAdvanced
arXivpreprintarXiv:2105.00312,2021.
Robotics. Proceedings. ICAR’97, pp. 421–426. IEEE,
Urain, J., Funk, N., Peters, J., and Chalvatzaki, G. Se 1997.
(3)-diffusionfields: Learningsmoothcostfunctionsfor
joint grasp and motion optimization through diffusion.
In2023IEEEInternationalConferenceonRoboticsand
Automation(ICRA),pp.5923–5930.IEEE,2023.
Van den Berg, J., Lin, M., and Manocha, D. Reciprocal
velocity obstacles for real-time multi-agent navigation.
In2008IEEEinternationalconferenceonroboticsand
automation,pp.1928–1935.Ieee,2008.
Vaswani,A.,Shazeer,N.,Parmar,N.,Uszkoreit,J.,Jones,
L., Gomez, A. N., Kaiser, Ł., and Polosukhin, I. At-
tentionisallyouneed. Advancesinneuralinformation
processingsystems,30,2017.
Wang,L.,Ames,A.D.,andEgerstedt,M. Safetybarrier
certificatesforcollisions-freemultirobotsystems. IEEE
TransactionsonRobotics,33(3):661–674,2017.
Wang,Z.,Hunt,J.J.,andZhou,M. Diffusionpoliciesasan
expressivepolicyclassforofflinereinforcementlearning.
InTheEleventhInternationalConferenceonLearning
Representations,2023.
Xie,M.,VanWyk,K.,Li,A.,Rana,M.A.,Wan,Q.,Fox,
D., Boots, B., and Ratliff, N. Geometric fabrics for
theacceleration-baseddesignofroboticmotion. arXiv
preprintarXiv:2010.14750,2020.
Yamada, J., Hung, C.-M., Collins, J., Havoutis, I., and
Posner, I. Leveraging scene embeddings for gradient-
based motion planning in latent space. arXiv preprint
arXiv:2303.03364,2023.
12PotentialBasedDiffusionMotionPlanning
A Appendix
Inthisappendix,wefirstpresentourdatasetdetailsinSectionA.1. Next,weprovideimplementationdetailsinSectionA.2,
suchasmodelarchitecture,trainingandevaluationsetups,hyperparameters. Further,Weshowadditionalquantitativeand
qualitativeresultsinSectionB,includingbaseenvironments,compositeenvironments,andreal-worlddatasets. Lastly,in
SectionC,wegiveaproofontheoptimalityofcomposingpotentialsofsetsofconstraints.
A.1 DatasetDetails
Inthissection,wepresentdetailsofthethreebaseenvironments. Eachdatasetconsistsoffeasibletrajectoriesofrandomly
sampledstartandgoalstates. AlldatasetsarecollectedbyBIT*(Gammelletal.,2015). AllenvironmentsexceptMaze2D
aresimulatedviaPyBullet(Coumans&Bai,2016–2021).
Maze2D.Theworkspaceisa5×5squareandtheagentisapoint-robotwhosestateisitsx-ycoordinateintheworkspace.
InthebaseMaze2Denvironment(Static1),theobstaclesare6squareblocksofsize1×1. WeconstructanotherMaze2D
environment(Static2)whereobstaclesare3squareblocksofsize1.4×1.4.Inaddition,weconstructaMaze2Denvironment
with7concaveobstacles. Forsimplicity,thevolumeoftherobotagentisignored–collisionhappenswhenthelocationis
insidetheregionofanobstacle. Thetrainingdatacontains3,000differentenvironmentconfigurationsand25,000statesfor
eachenvironments(approximately500trajectories).
KUKA.OneKUKALBRiiwaroboticarmisplacedatthecenter(0,0,0)inworldcoordinateandobstaclesaregiven
ascubicoflength0.40meterandarerandomlyplacedinthesurroundingoftherobot. Thetrainingdatacontains2,000
differentenvironmentconfigurationsand25,000statesforeachenvironments.
Dual KUKA. Two KUKA LBR iiwa robotic arms are placed side by side on a tabletop. One is at world coordinate
(−0.5,0,0)andtheotherisat(0.5,0,0). Obstaclesaregivenascubicoflength0.44metersandarerandomlyplacedinthe
surroundingoftherobots. Thetrainingdatacontains2,500differentenvironmentconfigurationsand25,000statesforeach
environment.
ETH/UCY. The dataset we used contains 6 scenes, where in each scene there are hundreds of street-level pedestrians
trajectories. Ineachscene,avideoisrecordedusingafixedbird-eye-viewcamerafacingthestreet,andthecoordinates
ofeachpedestrianaremanuallyannotatedaccordingtotherecordedvideo. Weusereal-worldpedestriantrajectoriesof5
scenestotrainourmodelandevaluateontheoneheld-outscene.
A.2 Implementationdetails
Software:. ThecomputationplatformisinstalledwithRedHat7.9,Python3.8,PyTorch1.10.1,andCuda11.1
Hardware:. Foreachofourexperiments,weused1RTX3090GPU.
A.2.1 ENERGY-BASEDDIFFUSIONMODEL
ModelArchitecture. Thediffusionpotentialmodelf consistsofaCNNtrajectorydenoiserbasedonU-Netsimilarto
θ
(Ajayetal.,2023)andaconstraint(i.e.,environmentconfiguration)encoder. TheU-Netcontainsrepeatedresidualblocks
whereeachblockconsistsoftwotemporalconvolutionsfollowedbyGroupNormandSiLUnonlinearity(Hendrycks&
Gimpel,2016). TheconstraintencoderusestheTransformerencoderstructure(Vaswanietal.,2017),whoseinputisaset
ofobstaclelocationsforstaticenvironmentsorobstacletrajectoriesfordynamicenvironments. Weremovethepositional
embedding,sincetheobstaclesinformationshouldbepermutationinvariancewitheachother. Weconcatenatethelearned
classtokenfromtransformerwiththetimeembeddingandfeedtheconcatenatedtensortotemporalconvolutionblocksin
U-Netfordenoising. MoredetailsofthemodelsareshowninTableA.2.1andTableA.2.1. Notethatwedonotfurther
exploretheselectionoftheconcretemodelarchitecture,butwebelievethatsomemoreadvancedarchitecturescouldfurther
improveourperformance.
13PotentialBasedDiffusionMotionPlanning
Hyperparameters Value Hyperparameters Value
BaseFeatureChannels 64 BaseEmbeddingChannel 64
FeatureDimensionScale (64,256,512) TransformerLayers 3
GroupsinGroupNorm 8 AttentionHeads 1
Nonlinearity SiLU Nonlinearity SiLU
Table4:HyperparameterofU-Net. Table5:HyperparameterofConstraintEncoder.
EnergyParameterization. ToencodetheenergyE(·)ofasinequation4,weuseL2energy-parameterizationasgivenin
equation14. FormoredetailsonEnergy-basedDiffusionModel,pleasereferto(Duetal.,2023).
1
EL2(x,t)= ||f (x,t)||2 (14)
θ 2 θ
A.2.2 TRAININGDETAILS
TrainingPipeline. Intraining,thedataloaderrandomlysamplestrajectoriesoflengthequaltothetraininghorizonfromthe
wholedataset. WeprovidedetailedhyperparametersfortrainingourmodelinTable6. Wedonotapplyanyhyperparameter
searchnorlearningratescheduler. Thetrainingtimeofourmodelisapproximatelytwodays, butweobservethatthe
performanceisclosetosaturationwithinoneday.
Hyperparameters Value
Horizon 48
DiffusionTimeStep 100
ProbabilityofConditionDropout 0.2
Iterations 2M
BatchSize 512
Optimizer Adam
LearningRate 2e-4
Table6:HyperparametersofDiffusionPotentialMotionPlanner(Training)
A.2.3 EVALUATIONDETAILS
OurEvaluationPipeline.Theinputoftheplanneristhestartstate,goalstate,andtheenvironmentconstraints(e.g.,obstacle
locationsrepresentedinworkspace),andtheoutputistheproposedtrajectory. Intesttime,thenumberofdenoisingtimestep
issetto10byusingDDIM(Songetal.,2020). TheintermediatenoisescaleetainDDIMissetto0forbaseenvironments
and1forcompositeenvironments. Theevaluationpipelineofourmodelconsistsofthreephases: ProposeMotionPlan
Candidates,CandidateSelection,andMotionRefining. Theplannerfirstgeneratesmultiplecandidatetrajectoriesusing
Algorithm 1. It then accesses the environment and performs collision check to select a successful trajectory from the
candidates. Finally,ifnodesiredcandidateisfound,itwillexecutethemotionrefiningasinAlgorithm2. Hyperparameters
usedinevaluationisdetailedinTable7andTable8. Weobservethatourplannercandirectlysolvealltheproblemsin
Maze2D,hencewedonotusereplanningduringtheevaluationofMaze2Denvironments.
BaselinesEvaluationPipeline. Wetryourbesttore-implementeverybaselineandfollowtheiroriginalsettings. For
MPNet(Qureshietal.,2019),wefollowtheirimplementationandusebi-directionalpathgenerationintesttime. Asfor
AMP-LS,weimplementaVariationalAuto-Encoder(VAE)(Kingma&Welling,2013)toencodetherobotposestateand
leverageGECOloss(Rezende&Viola,2018)inpathoptimization. MπNetdoesnotprovideareplanschemeintheirdesign.
Forfaircomparison,weboostMπNetwithreplanbybacktracingtoprevioustimestepandaddingasmallrandomnoisefor
restartwhenanycollisionsaredetected.
B AdditionalResults
Inthissection,weprovidemorequantitativeandqualitativemotionplanningresults. InSectionB.1,wepresentadditional
planningresultsonthebaseenvironments. InSectionB.2,weshowplanningperformanceoncompositesameenvironments.
14PotentialBasedDiffusionMotionPlanning
Hyperparameters Value Hyperparameters Value
Horizon 48 Horizon 52
DDIMTimeStep 8 DDIMTimeStep 10
DDIMeta 0.0 DDIMeta 0.0
GuidanceScale 2.0 GuidanceScale 2.0
#ofTrajectoryCandidate 20 #ofTrajectoryCandidate 20
#ofRefineAttemptsR 0 #ofRefineAttemptsR 5
RefineNoiseScalek – RefineNoiseScalek 3
Table7:HyperparametersofDiffusionPotentialMotionPlan- Table8:HyperparametersofDiffusionPotentialMotionPlan-
ner(EvaluationonMaze2D) ner(EvaluationonKUKAandDualKUKA)
InSectionB.3,weprovideplanningperformanceoncompositedifferentenvironments,includingcomposingtwodifferent
staticmodelsandcomposingastaticmodelandadynamicmodel. InSectionB.4,weshowmotionplanningperformance
onamorechallengingMaze2Denvironmentwithconcaveobstacles. InSectionB.5,wepresentmorequantitativeand
qualitativeevaluationresultsonthereal-worlddataset.
B.1 PerformanceonBaseEnvironment
WeprovidedetailednumericalmotionplanningresultsonthreebaseenvironmentsinTable9. Thecorrespondingbarplot
visualizationisgiveninFigure5. Besides,weprovideanadditionalGNN-basedmotionplanningbaseline(Yu&Gao,2021)
inthetablebelow. Wereportthemeanandstandarderroronthreemainmotionplanningmetrics: successrate,planning
timeandnumberofcollisionchecks. Ourmethodconsistentlyoutperformsallotherbaselinesonsuccessrate. Especially,in
thehardestDualKUKAenvironment,ourplanneroutperformsotherlearning-basedbaselineby40-50%onsuccessrate,
andevenoutperformstheadvancesampling-basedmethodBIT*by15%whilewithoneorderofmagnitudelessplanning
timeandcollisionchecks.
Maze2D KUKA DualKUKA
Method Success Time Check Success Time Check Success Time Check
RRT* 98.8±0.3 0.95±0.02 10453.4±156.8 59.4±1.9 3.15±0.06 19508.6±278.6 39.5±1.6 4.16±0.04 18560.5±112.6
P-RRT* 98.5±0.3 1.17±0.02 14158.9±225.8 58.0±1.9 3.44±0.06 21471.4±269.1 35.0±1.6 4.54±0.02 18117.7±78.8
BIT* 100.0±0.0 0.21±0.00 2067.4±24.4 96.5±0.7 0.86±0.04 6047.6±364.7 82.1±1.6 2.37±0.08 8925.4±365.0
AMP-LS 86.3±0.9 1.41±0.11 1025.4±30.2 27.2±4.3 3.89±0.35 4176.4±131.0 40.9±3.2 7.38±0.72 12091.3±230.0
MPNet 85.6±0.9 0.41±0.01 6315.7±203.0 76.0±3.9 0.10±0.02 885.4±135.5 42.0±4.1 0.35±0.04 1750.2±195.6
MπNet 97.9±0.3 0.07±0.00 178.7±7.8 88.7±0.8 0.22±0.01 232.5±11.6 63.9±1.4 0.72±0.02 875.2±26.7
GNN 100.0±0.0 0.11±0.00 1043.3±5.5 98.9±0.4 0.38±0.01 2207.4±153.6 94.6±0.6 1.22±0.03 6269.1±344.7
Ours 100.0±0.0 0.12±0.00 97.0±0.3 99.7±0.0 0.13±0.00 75.5±3.1 97.7±0.5 0.27±0.01 122.4±6.1
Table9:QuantitativeMotionPlanningPerformance.Evaluatedon100unseenenvironmentswith20motionplanningproblemsineach
environment.Wereportthemeanoverallenvironmentsandthestandarderroracrossdifferentenvironments.Thetableisthenumerical
resultscorrespondingtothebarplotvisualizationinFigure5.
Inaddition,wepresent4qualitativecomparisonswiththestate-of-the-artlearning-basedmotionplannerMπNetonthe
KUKAenvironmentsinFigure18attheendofthissection. InFigure19,wedemonstratetheversatilemorphologyofour
motiontrajectoriesonthesamemotionplanningproblem.
B.2 PerformanceonCompositeSameEnvironment
Weconstructcompositesameenvironmentswithmoreobstaclesofthesametypethantrainingphaseenvironments. Since
moreobstaclesarepresented,theseevaluationenvironmentsareoutoftrainingdistributionandhencemorechallenging.
Thelocationsofeachobstacleintheevaluationenvironmentsarerandomandunseentothemodel. Wefurtherprovide
abaselineDiffusioninwhichwedonotcomposepotentials. ThequantitativeresultsareshowninTable10,11,12,and
qualitativeresultsareshowninFigure11. Ourcomposedmodeldemonstratessuperiorperformanceoverallbenchmarks,
whichisconsistentwiththeexpectationthatcompositionenablesmoreeffectivegeneralizationtomoreobstacles.
15PotentialBasedDiffusionMotionPlanning
AspresentedinSection3.3,whengeneralizingtomoreobstacles,wemightsplittheobstaclesintoseveralgroupsbefore
composition. In our experiments, the splitting of obstacles is random, and we do not observe correlations between
performanceandthewaysofsplitting.
6 6+1 6+2 6+3 6+4 6+5
Figure11:CompositionalGeneralizationoverIncreasingObstacles.Thegreen/pinkstarindicatesthestart/goalstate.Ourplanneris
trainedwithadatasetwithonly6obstaclesandcangeneralizetoscenarioswithmoreobstaclesbydirectlycomposingpotentialsintest
time(withoutanyre-training).Thegeneratedtrajectoriesdemonstratevariousmorphologyandreachthegoalswithnearoptimalpaths.
6+1 6+2 6+3
Method Success Check Success Check Success Check
RRT* 98.5±0.3 11467.3±176.8 97.7±0.4 12675.6±238.9 96.7±0.5 14247.8±302.1
P-RRT* 97.5±0.3 15308.9±257.3 96.8±0.5 17176.1±324.3 92.8±0.7 19280.9±429.9
BIT* 100.0±0.0 2340.0±35.4 100.0±0.0 2635.7±40.6 100.0±0.0 2942.3±53.7
Maze2D AMP-LS 74.1±6.4 2845.2±247.0 66.7±6.2 3357.6±298.0 56.5±7.0 3973.5±290.0
MπNet 92.6±0.8 349.7±23.3 88.0±1.1 481.2±30.1 81.2±1.5 685.3±45.5
Diffusion 99.9±0.1 126.1±5.6 99.2±0.2 229.7±11.8 95.4±0.9 454.8±34.2
Composed 100.0±0.0 102.8±2.6 99.9±0.1 147.9±6.4 99.5±0.3 218.8±15.1
6+4 6+5 6+6
Method Success Check Success Check Success Check
RRT* 93.3±0.6 15729.8±307.4 88.7±1.1 18508.4±449.0 84.7±1.3 18598.5±416.9
P-RRT* 89.0±0.9 21280.1±398.9 78.2±1.7 24471.1±526.0 76.7±1.5 24491.8±501.8
BIT* 100.0±0.0 3220.2±59.7 100.0±0.1 3563.4±79.2 100.0±0.1 3580.7±61.1
Maze2D AMP-LS 45.1±7.2 4560.4±310.0 37.8±7.7 4928.6±361.0 33.5±7.0 5107.2±341.0
MπNet 75.6±1.5 860.7±47.3 65.0±1.8 1154.3±50.8 66.2±1.6 1120.9±48.0
Diffusion 85.2±1.4 769.7±41.4 71.9±1.8 997.0±38.1 64.0±1.8 1080.1±31.9
Composed 98.8±0.3 308.2±22.1 97.0±0.5 393.9±23.0 97.0±0.5 392.7±25.7
Table10:CompositionalGeneralizationoverIncreasedObstaclesinMaze2D.Inthetoprow,theleftdigitrepresentsthenumberof
obstaclesthatthemodelistrainedon;therightdigitdenotesthenumberofextraobstaclesaddedtotheevaluationenvironments.Unlike
otherlearning-basedplanners,whoseperformancesignificantlydeclinesasthenumberofobstaclesincreases,ourmethodsustainsa
near-optimalsuccessrateevenwhenthequantityofobstaclesdoubles.
16PotentialBasedDiffusionMotionPlanning
4+1 4+2 4+3
Method Success Check Success Check Success Check
RRT* 58.1±2.1 18920.7±281.3 56.5±2.0 17964.2±230.7 59.5±2.3 17339.7±261.3
P-RRT* 55.7±2.1 20356.2±254.2 55.0±2.1 19420.8±216.0 56.8±2.3 18287.8±203.3
BIT* 93.4±1.1 7045.6±483.9 91.5±1.2 8055.9±505.9 92.0±1.2 7176.8±477.9
KUKA AMP-LS 28.8±2.0 6767.0±154.0 35.0±1.6 7461.5±401.0 37.0±1.7 7277.4±150.0
MπNet 85.7±1.2 262.6±16.0 82.2±1.4 314.7±19.3 84.0±1.3 301.7±18.6
Diffusion 92.7±1.5 273.3±45.1 83.9±6.1 425.5±99.6 82.8±5.1 430.8±79.8
Composed 97.0±0.8 171.5±35.3 92.4±1.5 283.4±43.2 93.4±1.2 259.9±39.4
Table11:CompositionalGeneralizationoverIncreasedObstaclesinKUKA.Inthetoprow,theleftdigitrepresentsthenumberof
obstaclesthatthemodelistrainedon;therightdigitdenotesthenumberofadditionalobstacles.Bycomposingpotentials,ourplanner
surpassesallthebaselinesbyamargin.
5+1 5+2 5+3 5+4
Method Success Check Success Check Success Check Success Check
RRT* 36.2±1.9 17843.8±110.8 33.2±1.7 17311.8±93.9 33.9±1.8 16847.9±81.1 30.4±1.7 16355.9±72.6
P-RRT* 30.4±1.8 16921.2±75.2 24.6±1.4 16029.4±74.3 23.1±1.5 15387.9±69.0 17.3±1.3 14667.8±81.9
BIT* 76.2±1.9 9470.5±376.1 69.0±2.2 9631.7±284.6 57.9±2.7 9034.9±256.0 44.0±3.0 8290.1±176.1
Dual
AMP-LS 0.1±0.0 17512.0±180.0 0.3±0.1 17107.4±219.0 0.1±0.1 16725.1±233.0 0.3±0.1 16419.1±210.0
KUKA
MπNet 60.5±1.4 919.4±27.5 55.1±1.5 1034.9±27.6 51.0±1.7 1106.4±30.3 48.8±1.5 1134.0±27.2
Diffusion 91.7±1.5 305.6±29.8 80.9±2.2 497.1±35.5 69.0±2.9 624.0±35.8 58.1±3.0 761.0±31.0
Composed 97.3±0.7 250.4±26.2 95.2±1.1 373.9±37.1 90.8±1.3 545.7±43.7 87.8±1.5 648.4±47.2
Table12:CompositionalGeneralizationoverIncreasedObstaclesinDualKUKA.Inthetoprow,theleftdigitrepresentsthenumber
ofobstaclesthatthemodeltrainedon;therightdigitdenotesthenumberofadditionalobstacles. InthismostdifficultDualKUKA
environment,ourplanneroutperformsotherbaselinesbyalargermargin.From5+1to5+4,theadvancedsampling-basedmethodBIT*
dropsby32%,withasuccessrateof44%,whileourmethodonlydropsbylessthan10%,achieving87.8%insuccessrate.
B.3 PerformanceonCompositeDifferentEnvironment
Wepresentextraexperimentresultsoncomposingtwodifferentmodels. Eachmodelisseparatelytrainedononesingle
obstacletypeandweevaluatethemonmorecomplexenvironmentswithmultipleobstacletypes.
Static1+Static2. InTable13,wepresentquantitativegeneralizationresultsofcomposingtwodifferentstaticMaze2D
models. Static1isamodelonlytrainedonobstaclesofsize1×1andStatic2isamodelonlytrainedonobstaclesofsize
1.4×1.4. ThecompositeenvironmentStatic1+Static2containssix1×1obstaclesandthree1.4×1.4. Asthesettingin
theevaluationofthebaseenvironments,weevaluateon100differentenvironmentswith20randomlygeneratedstartand
goalineachenvironment. Obstaclesinallenvironmentsarerandomlyplaced. Noextratrainingisrequired. Wealsopresent
qualitativeresultsoverincreasingobstaclesinthecompositedifferentenvironment(Static1+Static2)inFigure12.
Static1+Static2
Method Success Check
RRT* 90.3 18495.1
P-RRT* 82.8 24959.9
BIT* 100.0 3486.9
Ours 98.9 304.7
Table13:QuantitativeResultsonMaze2DCompositeDifferentEnvironments.Static1isamodelonlytrainedonobstaclesofsize
1×1andStatic2isamodelonlytrainedonobstaclesofsize1.4×1.4.Thetestingenvironmentscontainsix1×1obstaclesandthree
1.4×1.4obstacles.Thoughtrainedondifferentenvironmentsseparately,thecomposedmodelreachesnearoptimalsuccessratewhile
requiringoneorderofmagnitudelesscollisionchecksthanBIT*.
17PotentialBasedDiffusionMotionPlanning
3 3+1 3+2 3+3
3+4 3+5 3+6
Figure12:CompositionalGeneralizationoverDifferentObstacles.Thegreen/pinkstarindicatesthestart/goalstate.Twoseparately
trainedmodelsarecomposed:amodelonlytrainedonlargeblocks(blue)ofsize1.4×1.4andamodelonlytrainedonsmallerblocks
(orange)1×1. Bycomposingtwomodels,ourplannercangeneralizetomorecomplexscenarioswithvariousobstaclesintesttime
(withoutanyre-training).Thegeneratedtrajectoriesdemonstratevariousmorphologyandreachthegoalwithsmoothandshortpaths.
Static1+Concave. InFigure13,weprovidequalitativeresultsoncompositeenvironmentsofsquareobstaclesandconcave
obstacles. Intheleftmostcolumn,weshowageneratedmotiontrajectoryonabaseenvironmentwith6squareobstacles
only. Followingthis,wegraduallyaddconcaveobstaclestothebaseenvironment,from6+1to6+6. Ourplannercanplan
smoothandcoherenttrajectoriesaccordinglybycomposingthecorrespondingpotentials.
6 6+1 6+2 6+3
6+4 6+5 6+6
Figure13: CompositionalGeneralizationoverSquareandConcaveObstacles. Thegreen/pinkstarindicatesthestart/goalstate.
Twoseparatelytrainedmodelsarecomposed:amodelonlytrainedonsquareblocks(blue)ofsize1.0×1.0andamodelonlytrained
onconcaveblocks(orange).Ourplannercanadaptivelyproposemotiontrajectoriesaccordingtotheenvironmentsbycomposingthe
potentialsofsquareobstaclesandconcaveobstacles.
18PotentialBasedDiffusionMotionPlanning
Static1+DynamicEnvironment. Weevaluateourmethodoncompositedifferentenvironmentswhichcontainbothstatic
anddynamicobstacles. Notethatourmethodisonlytrainedonenvironmentsthatpurelyconsistofstaticobstaclesor
dynamicobstacles. Static1isamodelthatisonlytrainedonsix1×1staticobstaclesandDynamicisamodelthatonly
trainedononemoving2×2obstacle. Thecompositeenvironmentscontainsix1×1staticobstaclestogetherwithone
moving2×2obstacle. ThequantitativeresultsareshowninTable3andtwoqualitativeresultsareshowninFigure14.
T=1 T=13 T=19 T=35 T=48
T=1 T=20 T=35 T=40 T=48
Figure14: QualitativeCompositionalityGeneralizationoverStatic1+DynamicObstacles. Thecurrentpositionoftheagentis
showninthepinkasterisk.Thegreylineindicatesthemovingtrajectoryofthedynamicobstacle(thelargeblueblock).Inthefirstrow,
theplannedtrajectorygoesfurtherleftinordertoavoidthemovingobstaclefromtheupperright.AtT=19,thetrajectoryistraveling
rightwhilecanstillavoidtheotherorangestaticobstacles.Inthesecondrow,thedynamicobstacleisfirstmovingtowardthebottom
rightcornerandthengoingbacktotheupperleft.AtaroundT=35,thetrajectorytakesseveralextramoves,waitingfortheblueblock
passingthroughthegoalposition.
Static2+DynamicEnvironment. Static2isamodelthatisonlytrainedon1.4×1.4staticobstaclesandDynamicisa
modelthatonlytrainedononelargemoving2×2obstacle. Thecompositeenvironmentscontainthree1.4×1.4static
obstaclesandonemoving2×2obstacle. ThequantitativeresultsareshowninTable3andtwoqualitativeresultsareshown
inFigure15.
19PotentialBasedDiffusionMotionPlanning
T=1 T=10 T=20 T=35 T=48
T=1 T=10 T=35 T=40 T=48
Figure15: QualitativeCompositionalityGeneralizationoverStatic2+DynamicObstacles. Thecurrentpositionoftheagentis
showninthepinkasterisk. Thegreylineindicatesthemovingtrajectoryofthedynamicobstacle(thelargeblueblock). Twomotion
plansareshown.Inthefirstrow,theplannedtrajectoryveersfurtherlefttocircumventtheapproachingmovingobstaclewhilestillbeing
awareoftheotherorangestaticobstacles.Inthesecondrow,thedynamicobstaclefirstmovesupwardsandthengoesdownwards.Both
phrasesoftheobstacle’smotioncanpotentialblocktheagent’spath,especiallywhenitisgoingdownwards.Theplannedtrajectoryfirst
navigatesthroughthegapbetweentheblueblockandtheorangeblock,andthenreservesenoughspaceandtravelnearthebottomofthe
environmenttopreventanycollisions.
B.4 PerformanceonConcaveObstacles
WeconstructMaze2Denvironmentswith7concaveobstaclesandhaveshownthequalitativeandquantitativeresultsin
Figure7andTable2inthemainpaper.
Specficially,inTable2,weshowthemotionplanningperformanceonConvexandConcaveobstaclessidebyside,where
RMP (Ratliff et al., 2018) is a traditional potential-based motion planner and MPD is a recent diffusion-based motion
planner(Carvalhoetal.,2023). Similartootherexperiments,allobstaclesarerandomlyplacedandnopost-training/fine-
tuningisrequired. Wecanseethatallmethodssubjecttoacertaindeclineinenvironmentswithconcaveobstacles. Notably,
ourlearneddiffusionpotentialmotionplannercanstillsolvealltheproblems,surpassingthepurepotential-basedmethod
byamarginwhilerequiringsignificantlylessplanningtimethanthestate-of-the-artsampling-basedplannersBIT*. In
Figure16,wepresentmorequalitativeresultsofRMP,RRT*,BIT*,MPNet,andourmethodonenvironmentswithconcave
obstacles.
20PotentialBasedDiffusionMotionPlanning
RMP RRT* BIT* MPNet Ours
Figure16:QualitativePerformanceonEnvironmentswithConcaveObstacles.Thegreenstarindicatesthestartposeandthered
starindicatesthegoalpose.RMPtendstostuckinlocalminimaandfailstoreachthegoals;RRT*isslowinspeedandmayreachthe
planningtimelimitinsomedifficultproblems;trajectoriesbyMPNetmayoccasionallygothroughobstaclesintheenvironments;our
methodisabletogeneratesmoothandlow-costtrajectorieswithoutcollisionwhilebeingupto10timesfasterthanBIT*.
B.5 PerformanceonReal-WorldDataset
Currentroboticpathplanningproblemisusuallylimitedtosimulationenvironmentsandthereisnowidely-usedreal-world
benchmark. Sincepedestriantrajectoryisnaturallyakindofdemonstrationsofhumanplanning,weleveragetheETH/UCY
Datasettoevaluatereal-worldmotionplanningcapability. Specifically,theentiredatasetiscomprisedof6scenes: ETH,
Hotel,Zara01,Zara02,Students01,Students03,wherethemodelsaretrainedon5scenesandtestedontheheld-outscene.
Similartooursimulationenvironments, themodeltakesasinputthepositionofstart, goal, andotherpedestrians, and
outputsapredictedmotionplan. Thepredictedmotionplanisdesiredtobeascloseaspossibletotherealhumantrajectory
andthuswereporttheAverageDisplacementError(ADE)asdefinedinequation15:
(cid:80) (cid:80) ||qi−qˆi||
t t 2
i∈Nt∈T
ADE= (15)
N ×T
whereqˆi ∈R2isthesteptintheithpredictedpathandqiisthecorrespondinggroundtruth. ADEmeasurethesimilarity
t t
betweenthepredictedtrajectoriesandhumantrajectories. AsmallerADEvalueindicatesthepredictionsareclosertothe
realhumanbehavior.
21PotentialBasedDiffusionMotionPlanning
ETH Hotel Zara01 Zara02 Students01 Students03
Method ADE↓ Time ADE Time ADE Time ADE Time ADE Time ADE Time
MPNet 18.11 0.12 28.60 0.11 11.06 0.12 17.22 0.11 10.37 0.12 8.93 0.11
MπNet 37.70 0.26 44.49 0.29 1.14 0.22 13.66 0.23 12.76 0.18 1.54 0.22
Ours 0.94 0.17 5.20 0.17 0.35 0.17 0.38 0.17 0.52 0.17 0.89 0.17
Table14: QuantitativeResultsonreal-worldETH/UCYDataset. WeadopttheADEmetrictoshowthesimilaritybetweenthe
predictedmotionplansandrealhumanmotiontrajectoriesonunseenscenarios.Allmotionplansareintheworldcoordinateasgivenin
thedataset.Ourmethodcanmimichumanmotionbehaviorsmorepreciselyinmostscenes,whilebothMPNetandMπNetcausedrastic
errorcomparedtorealhumantrajectories.
Theper-scenequantitativeperformanceisshowninTable14. Eachsceneiscapturedatdifferenttimeofadayordifferent
location,resultingindifferentdatadistribution. TheADEisrelativelysmallerinZaraandStudentsbecausethemodel
canseeasimilarcounterpartsceneattraining,e.g.,trainsetincludesZara01whentestedonZara02. Bycontrast,ETHor
Hotelaremoreuniquetootherscenes(e.g.,containdifferentscenelayoutandhumanbehaviorpatterns)andthuscausing
higher evaluation error. As shown in Table 14, MPNet consistently falls short of the ADE, though with slightly faster
speed. WeobservethatMπNetcanproducereasonablemotionplansinmanycases,butitoccasionallypredictsrandom
values,whichcausessignificantdeviationfromthetargetandleadstothenotbalylargerADE.Ourmethoddemonstrates
bettergeneralizabilityandstabilitybypreciselymimicingthehumantrajectoriesinmostheld-outscenes. Wealsonotice
that in Hotel, all methods suffer from a severe surge in ADE. Our speculation is that the Hotel has different walkable
world-coordinationandinaddition,itcontainsvariousunseentypesofpedestriansmotionpattern,suchasslowlypacing
peoplethatarechattingorwaiting,peoplesteppingonoroffthetrain.
BaseRealWorldMotionPlanning. WevisualizethemotiontrajectoryplannedbyourmodelinZara02scenewherefive
otherpedestriansarepresentedinFigure17. Theplanneristrainedontheother5scenesandevaluatedonthisheld-out
scene. Inthegivenscenario,ouragent(highlightedinred)isheadingtowardsthebottomrightcornerwhereP2(yellow)is
onitsway. Also,theagentisabouttoenteranintersectionwithmultipleoncomingpedestrians. Inthiscomplexdynamic
scene,thetrajectoryplannedbyourmodelfirstchoosestofollowP2(showninT=10)andadjustitspacetoletother
pedestrianspassthroughfirst. AsshownininT=22,ouragentsuccessfullycrossestheintersectionwithoutinterrupting
anyotherpedestrians.
T=10 T=22 T=50
Figure17: QualitativeRealWorldMotionPlan,Zara02Scene. Eachstarrepresentsapedestrianonthestreet. Redindicatesthe
trajectoryplannedbyourmodel,whileothercolorsrepresent5pedestriansinthesurrounding.Ourmotionplansmoothlypassesthrough
theintersectionwithoutanycollisionordiscontinuity.
22PotentialBasedDiffusionMotionPlanning
(a)
(b)
(c)
(d)
Ours M𝜋Net
Figure18:ComparisonwithMπNetonKUKA.Trajectoriesof4motionplanningproblems.Thelargegreen/pinkballindicatesthe
locationoftheendeffectorofthestart/goalstate. Ourplannercangeneratesmoothlong-horizonmotiontrajectoriesandavoidbeing
stuckinlocalgeometry. Forexample,in(a),ourplannerisabletoselectafeasibleandshorterpathpassingthroughthecenterofthe
workspacetoreachthegoalstate;andin(c),thetrajectorybyourplannernavigatesthroughnarrowpassagewayswithoutcollision,e.g.
travelbetweenthegreenandpurpleblocks.
23PotentialBasedDiffusionMotionPlanning
Trajectory1,Viewa Trajectory2,Viewa
Trajectory1,Viewb Trajectory2,Viewb
Figure19: FlexibleTrajectoryMorphology. Ourmethodcangeneratetrajectorieswithvariousmorphologicalshapes. Thelarge
green/pinkballindicatesthelocationoftheendeffectorofthestart/goalstate.Viewaandbrepresenttwodifferentviewinganglesofthe
sametrajectory.Inthefigure,Trajectory1andTrajectory2aregeneratedunderthesameconstraints(e.g.,startstate,goalstate,obstacles
locations)butwithdifferentstartingnoise,resultingindifferentrouteselection.Trajectory1routesthroughthecentralnarrowpassage
betweenthetwopurpleblocksandarrivesthepinkballfromabove. Trajectory2avoidstheobstaclesbygoingundertheblocksand
finallyarrivesthesamegoalstatefrombelow.
B.6 ComparisontoTrainingonMultipleTypesandNumbersofObstacles
Inthissection,wetrainanadditionalbaselinewhichlearnsalldatawithdifferentnumbersandtypesofobstaclesinasingle
diffusionpotentialfunction. Thus,trainingthisbaselinerequiresadditionalmotionplanningdemonstrationsofvarious
obstaclecombinations. Notethatforourproposedcompositionalmotionplanningmethod,modelsareonlytrainedona
limitednumberortypeofobstacles,whilecaneffectivelygeneralizetovariouscombinationsthroughcomposition.
WeuseMaze2Denvironmentasthetestbed. Letsdenoteobstacleoftype1andl denoteobstacleoftype2,sothats6
indicates6obstaclesoftype1. WekeepallthetrainingandevaluationsetupsthesameasinpreviousexperimentsinB.2. In
Table15,DirectTrainingreferstoamodeldirectlytrainedonvariousnumbers/typesofobstacles,andComposedrefersto
themodeltrainedonafixednumberofobstaclesandgeneralizestonovelobstaclecombinationsviacomposingpotentialsin
test-time. Forfurthercomparison,weincludeanotherbaselineProcessAllObstaclesinthetable,whichisalsotrainedona
fixednumberofobstacles,butisdirectlypassedindifferentnumbersofobstaclesattest-time(Thisbaselineisequivalentto
DiffusionshowninTable10).
Shown in Table 15, we observe that composing models obtains a comparable performance to the Direct Training and
substantiallyoutperformsProcessAllObstacles. NotethatthetrainingandevaluatingdistributionissimilarforDirect
Training,whileverydifferentforComposed,forexample,thetrainingdatainDirectTrainingincludesthescenarioswith12
obstacles,whileComposedisonlytrainedon6obstacles,highlightingtheeffectivenessofcompositionforgeneralization.
24PotentialBasedDiffusionMotionPlanning
s6 s7 s8 s9 s10
Method Success Check Success Check Success Check Success Check Success Check
ProcessAllObstacles 100.0 97.0 99.9 126.1 99.2 229.7 95.4 454.8 85.2 769.7
DirectTraining 100.0 99.5 100.0 86.3 100.0 95.7 100.0 118.4 99.9 140.5
Composed 100.0 97.0 100.0 102.8 99.9 147.9 99.5 218.8 98.8 308.2
s11 s12 s6+l1 s6+l2 s6+l3
Method Success Check Success Check Success Check Success Check Success Check
ProcessAllObstacles 71.9 997.0 64.0 1080.1 – – –
DirectTraining 98.8 227.4 98.2 264.1 100.0 90.4 99.9 133.8 99.8 172.4
Composed 97.0 393.9 97.0 392.7 99.9 184.2 99.2 304.1 98.9 304.7
Table 15: Quantitative Comparison with Model Directly Trained on various Types/Number of Obstacles. Motion planning
performanceontheMaze2Denvironmentswithcombinationsofdifferenttypesandnumbersofobstacles,e.g.,s6+l2denotesan
environmentwithsixobstaclesoftype1andtwoobstaclesoftype2. Incolumnswith–, ProcessingAllObstaclesbaselineisnot
applicableasdifferentmodelsarecomposed.NotethatinDirectTraining,themodelistrainedonall10obstaclecombinationsshown
above;whileforComposed,weonlytrainamodelonenvironmentswithsixobstaclesoftype1andamodelonenvironmentswiththree
obstaclesoftype2.
C ProofofConditionalIndependenceforComposingPotentials
InSection3.3,wepresentawaytogeneralizetomultipleunseenout-of-training-distributionconstraintsbycomposing
correspondingpotentials. Specifically,inEquation6,weassumethatconstraintC andC areconditionalindependent. In
1 2
thissection,wewillshowhowourassumptionholdsinageneralcase,andthusthecompositionalityofourplannercanbe
achievedasin(Liuetal.,2022).
Assume that two set of constraints are given, C = {o ,o ,o ,o } and C = {o ,o ,o ,o }. Let f (q ) denote a
1 1 2 3 4 2 3 4 5 6 Ci 1:T
probabilitydensityfunctionovertrajectories,wherepositivelikelihoodisuniformlyassignedtothetrajectoryq ifit
1:T
satisfiestheconstraintC ;otherwise,thelikelihoodissetto0. LetJ denotethesetoftrajectoriesthatsatisfiesconstraint
i ci
C . Then,wehave
i
(cid:40)
ρ ifq ∈J
f (q )= i 1:T ci (16)
Ci 1:T
0 ifq ∈/ J
1:T ci
whereρ isasmallconstant. Similarly,wecandefinef astheprobabilitydensityfunctionoftrajectoriesthatsatisfy
i C1∪C2
bothC andC . Clearly,givenanytrajectoryq ,theprobabilitydensityofq ispositiveifandonlyifbothf (q )
1 2 1:T 1:T C1 1:T
andf (q )arepositive. Morespecifically,wehave
C2 1:T
f (q )=γf (q )f (q ) (17)
C1∪C2 1:T C1 1:T C2 1:T
whereγ isaconstant(notetheproportionalityconstantinthepreviousequation). Wecanseethatthejointprobability
densityfunctionequalstothescaledproductoff andf . Whiletheaboveequationdoesn’tindicateindependence,
C1 C2
samplingusingthescorefunctionfortheleftsideoftheequationisthesameassamplingfromthesummedscorefunction
fortherightsideoftheequation,becausethescorefunctionisthegradientofthelogprobabilityandisinvarianttothe
constantmultiplier. Therefore,theconstantγ herewillnotaffectthetest-timesamplingprocessandtheproposedprocedure
ofcomposingpotentialsforgeneralizationcanbeachievedintheory.
25
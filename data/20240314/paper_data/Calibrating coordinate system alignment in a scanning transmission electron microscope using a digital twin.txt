Microscopy and Microanalysis,2023,pp.1–9
doi:
Paper
PAPER
Calibrating coordinate system alignment in a scanning
transmission electron microscope using a digital twin
Dieter Weber ,1, ∗ David Landers ,2, 3 Chen Huang ,4 Emanuela Liberti ,4
Emiliya Poghosyan ,5 Matthew Bryan ,3 Alexander Clausen ,1 Daniel G. Stroppa ,6
Angus I. Kirkland ,4, 7 Elisabeth Mu¨ller ,5 Andrew Stewart 2
and Rafal E. Dunin-Borkowski 1
1ErnstRuska-CentreforMicroscopyandSpectroscopywithElectrons,ForschungszentrumJu¨lich,52425Ju¨lich,Germany,2Departmentof
Chemistry,UniversityCollegeLondon,20GordonStreet,London,WC1H0AJ,UK,3LETI,CEA,17Av.desMartyrs,38054Grenoble,
France,4RosalindFranklinInstitute,HarwellScienceandInnovationCampus,Didcot,OX110QX,UK,5ElectronMicroscopyFacilityat
PSI,PaulScherrerInstitute,5232Villigen,Switzerland,6DECTRISAG,Taefernweg1,5405Baden-Daettwil,Switzerlandand
7DepartmentofMaterials,UniversityofOxford,Oxford,OX13PH,UK
∗Correspondingauthor.d.weber@fz-juelich.de
Abstract
In four-dimensional scanning transmission electron microscopy (4D STEM) a focused beam is scanned over a specimen
andadiffractionpatternisrecordedateachpositionusingapixelateddetector.Duringtheexperiment,itmustbeensured
that the scan coordinate system of the beam is correctly calibrated relative to the detector coordinate system. Various
simplifiedandapproximatemodelsareusedimplicitlyandexplicitlyforunderstandingandanalyzingtherecordeddata,
requiring translation between the physical reality of the instrument and the abstractions used in data interpretation.
Here,weintroduceacalibrationmethodwhereinteractivelivedataprocessingincombinationwithadigitaltwinisused
to match a set of models and their parameters with the action of a real-world instrument.
Key words: scanning transmission electron microscopy, 4D STEM, metadata
Introduction a) b)
For several 4D scanning transmission electron microscopy
(STEM) data analysis methods such as differential phase con-
trast (DPC) (Hamilton & Sheppard, 1984; Lazi´c et al., 2016)
orcenterofmass(CoM)(Lazi´c&Bosch,2017),strain(Usuda
et al., 2005; Ozdol et al., 2015) and orientation (Viladot
et al., 2013; Rollett & Barmak, 2014) mapping, and ptychog-
raphy (Hoppe, 1969; Yang et al., 2017) it is essential that the
relativeorientationbetweenthescancoordinatesystemandthe
detector coordinate system is known so that directions on the
detectorcanbeputintocorrespondencewithdirectionsinthe
scancoordinatesystem(Ningetal.,2022).Figure1showsthe Figure1.ImpactoftherotationcalibrationonanintegratedCoM(Lazi´c
impact of an incorrect rotation calibration on integrated CoM
&Bosch,2017)reconstructionofa4DSTEMdatasetofSmB6,recorded
withaDECTRISARINAonaThermoFisherSpectra200: a)Thecal-
reconstruction for illustration. This calibration is surprisingly ibrationofthescanrotationisoffby90°. b)Correctcalibrationofthe
difficult and error-prone in practice, and it was often not re- scanrotation.
quired in STEM previously, since conventional detectors such
asthoseusedforbrightfieldandannulardarkfieldSTEMare
rotationallysymmetric.Consequently,therehasbeensubstan-
tialrecentworkinboththeoryandpracticalimplementationto
calibrate a microscope’s coordinate system as well as validate atomic-resolution STEM can be analyzed. Since the deflec-
thecalibrationofagiven4DSTEMdataset. tion is, in a thin specimen approximation, proportional to the
Three methods are established to perform this alignment. projectedlocalfield,abeamofnegativeelectronsshouldbeat-
First, the deflection distribution around atom columns in tractedtothepositivelychargedatomcolumns(Shibataetal.,
2012).Furthermore,anelectrostaticfieldshouldbefreeofcurl.
©TheAuthor2023.PublishedbyOxfordUniversityPress.Allrightsreserved.Forpermissions,pleasee-mail:
journals.permissions@oup.com
1
4202
raM
31
]ted-sni.scisyhp[
1v83580.3042:viXra2 Calibrating coordinate system alignment in a scanning transmission electron microscope using a digital twin
The coordinate system alignment that minimizes curl and en-
suresanegativedivergenceatatompositionsisassumedtobe
thecorrectoneforthismethod(Savitzkyetal.,2021).
Second, the self-consistency of the data in a ptychography Y, X (scan) Overfocus
reconstruction can be analyzed, such as described in (Ning
Scan Rotation
etal.,2022). Camera Length
Z
In practice, however, real-world specimens are usually not
Y, X (detector)
thinenoughtoassumeasimpledirectdependencebetweendis-
placement and field without multiple scattering. In particular,
slight misalignments between the atom column axis and the Flip Y Y, X center
beamaxisaswellasopticalaberrationsmightleadtoapparent
distortions (Bu¨rger et al., 2020). Furthermore, atom columns
areonlyreliablyresolvediftheinstrumentaberrationsarevery Figure2.AbstractmodeloftheprojectionwithoverfocusedSTEMwith
theparametersandcoordinateaxeslabeled.
low and a high spatial resolution is achieved. Not every scan-
ning transmission electron microscope is capable of this, and
it is not always desirable to tune and operate the microscope
in this mode. Additionally, methods based on analyzing field by the digital twin matches the actual transformation by the
distribution around atom columns are only applicable to thin microscope, a sharp image is obtained. In case of a mismatch
crystallinespecimens. betweenmicroscopeandtwin,theimagesarenotsuperimposed
Thethirdandmoreconventionalapproachreliesonover-or correctlyandtheresultisblurred.Thisblurringisindependent
underfocusingthebeamsothatthecrossoveraboveresp.below ofsymmetriesinthespecimen,sincethetranslationofthepro-
the specimen acts as a point source. In this configuration, a jected images on the detector caused by scanning the beam
shadow image of the specimen is projected onto the detector. breaksanysymmetry.
If this shadow image is compared with a STEM image, the
transformation between STEM image coordinates and shadow
Methods
image, i.e. detector coordinates, can be determined. Instead
of a separate STEM image, a virtual detector image can be
Theshadowimagingintheoverfocusedstateismodeledwitha
generated from a 4D STEM dataset using a very small virtual
linearraytracingapproximation.Allraysareassumedtoorig-
detector, for example a single detector pixel, so that it has a
inatefromafocuspointabovethespecimen,passthroughthe
highdepthoffield.Inthatcasebothdetectorshadowimageand
specimen, and then hit the detector plane. Underfocus, where
STEM image are taken from the same 4D STEM dataset (Hu
the focus point is below the specimen, is represented with a
etal.,2023).Underfocuscanbeusedinsteadofoverfocus,which
negative overfocus value that leads to the correct result with-
leadstoaninverteddetectorimagecomparedtooverfocus.
outseparateadaptationofthismodel.Scanningthebeamshifts
This method relies on finding a field of view on the speci-
thepositionofthefocuspointlaterallyrelativetothespecimen,
men without mirror or rotational symmetry and adjusting the
but doesn’t shift the beam position on the detector or lead to
microscopesothatitisclearlyrecognizable,includingexposing
a beam tilt in the specimen plane. The specimen is assumed
with sufficient dose. However, the matching procedure can be
to be thin and oriented orthogonal to the optical axis, i.e. not
error-prone if performed manually without the help of a dedi-
tilted or warped. All coordinate systems are right-handed by
cated software stack. As an example, the direction of rotation
default.
is easily reversed if the procedure is performed manually, an
Withtheseassumptionsinplace,theelectron-opticalsetup
additional handedness change could be missed, and different
of this imaging mode is described with the following parame-
software or hardware uses different coordinate system conven-
ters:
tions. If conventional STEM and 4D STEM use a different
acquisition software and/or scan generator on the same mi- • OverfocusVirtualverticaldistanceofthebeamfocusover
croscope, which is often the case, the coordinate system of the specimen plane under the assumption of straight prop-
a conventional STEM image might differ from the coordinate agation between focus point and specimen. Underfocus is
systemofa4DSTEMdataset. specifiedasanegativeoverfocusvalue.
Furthermore,differentsoftwaremightinterpretanddisplay • ScanPixelSizeLateraldistancebetweenscanpoints.The
thedatadifferently.Asanexample,somesoftwaredisplaysthe scanisassumedtoberectangularwithuniformstepsizein
first pixel of a detector frame in the lower left corner with the bothdirections.
yaxispointingupwards,whileotherimageprocessingsoftware • Camera Length Virtual vertical distance between spec-
shows the first pixel in the upper left with the y axis pointing imen and detector under the assumption of straight ray
downwards. That may introduce inadvertent errors if data is propagationbetweenspecimenanddetector.Inrealmicro-
inspectedvisuallywithonesoftwaretocalibratethealignment, scopestheelectronspassthroughasetofprojectionlenses
butthenprocessednumericallywithanother. thatallowadjustingthisvirtualdistance.
To eliminate such error sources, the calibration should be • Detector Pixel Size Size resp. pitch of detector pixels.
performed with the same acquisition system and software as Thedetectorisassumedtoberectangularwithequidistant
the actual acquisition to ensure consistency. Furthermore, the squarepixelswithoutgaps.
calibration method and analysis methods should be validated • Y and X Center Pixel position on the detector that is
togethertointerpretdataandparametersinaconsistentway. definedasthebeamcenter,i.e.wheretherayfromthefocus
Here we present a method that is derived from the defo- pointstraightdownorthogonalthroughthespecimenplane
cus method. It uses automated data processing and a digital hitsthedetector.
twinofthemicroscopetosuperimposeallshadowimagesinan • Scan RotationRotationbetweenthescancoordinatesys-
over-orunderfocused4DSTEMdataset.Ifthetransformation tem in scan pixel units and the detector pixel coordinate3
a) b)
c) d)
Figure 3.Visualizationoftheraypathsinthedigitaltwin.Thefigure
isgeneratedusingTEMGYM’svisualizationroutinefromthemodelused
e)
inthecalculationswiththeactualdataset(Figures5-9). Theoverfocus
andthescanstepareexaggeratedbyafactorof104 tomakethemvis-
ible. Notehowthismodelisclosertothephysicalrealityofascanning
transmission electron microscope than the abstract model in Figure 2.
TEMGYMBasictranslatestheparametersoftheabstractmodelintopa-
rametersforsimulatedopticalelementssuchasdeflectorsandlensesto
yieldresultsequivalenttotheabstractmodel.
f)
system in pixel units. Physically, this is composed of three
components: Actual rotation of the scan, rotation imposed
by the projection system, and rotation of the detector.
In the simple model used here these three rotations are
cumulativeandcanbedescribedwithasingleparameter.
• FlipYInvertthedetectorrowindex(y)axis.Thisencodes
ahandednesschangebetweendetectorandscan.Anycom-
Figure 4.Illustrationofthesuperpositionofprojectedshadowimages:
binationofaxisinversionandrotationforbothdetectorand
a)Projectionatfirstscanposition.b)Projectionatsecondscanposition.
scancanbedescribedwithacombinationofScanRotation c)Projectedimagefroma).d)Projectedimagefromb).e)Incorrectsu-
andFlipY. perpositionoftheprojectedimages: Thefeaturesdon’talign. Thiswill
leadtoblurringifmanyimagesfromdifferentscanpositionsaresuper-
Figure2showsaschematicofthismodeloftheexperiment imposedincorrectly.f)Correctsuperposition:Thefeaturesalignandthe
withlabelsfortheparameters. superpositionofmanyimagesfromdifferentscanpositionscreatesasharp
Theparametersarechosentocorrespondwiththeusualpa- imageoftheobject.
rameters that are available from a microscope’s user interface.
However,itisnotguaranteedthattheyarealsointerpretedin
the same way. As an example, for Thermo Fisher microscopes
theparameter“ScanRotation”describesaclockwiserotationof TEMGYM Basic (Landers et al., 2023c) was used to con-
theSTEMimageonthescreen,whileourimplementationinter- struct a digital twin for a STEM instrument (Figure 3) that
prets it as a clockwise rotation of the scan coordinate system can accept these parameters and interprets them in a consis-
around the beam (Z) axis, following the convention (Clausen tent way to match the abstraction shown in Figure 2. This
etal.,2019)intheLiberTEMsoftware(Clausenetal.,2023b). digital twin can calculate both the detector pixel position and
Thatmeanstheparameter“ScanRotation”rotatesinopposite the specimen pixel position of rays as a function of diffraction
directionbetweentheThermoFishersoftwareandLiberTEM. angleandscanposition.Withthisinformation,theshadowim-
“Flip Y” was chosen to describe a handedness difference ageprojectedontothedetectorcanbetransformedintoimages
since it makes it easy to account for an inverted Y axis of a in scan pixel coordinates. This model assumes that changing
detector. thefocusdoesn’taffectrotationandhandedness.
The parameters Overfocus o, Scan Pixel Size s, Camera If the digital twin describes the action of the microscope
Length l and Detector Pixel Size d are not independent, but correctly, superimposing the images from an overfocused 4D
theirratiosdefineasinglescalingfactorM = sl betweenscan STEM experiment after transforming into scan pixel coordi-
do
pixel coordinates and detector pixel coordinates. Since Scan nateswillformasharpimageofthespecimen(Figure4).This
Pixel Size, Camera Length and Detector Pixel Size are typi- superimposedimagewillalsocorrespondtoavirtualSTEMde-
callycalibratedbyothermeansorarefixedphysicaldistances, tector image formed from a single detector pixel, for example
Overfocusisanaturalchoicetoadjustthescalingfactor. the central ray like described in (Hu et al., 2023). However, if4 Calibrating coordinate system alignment in a scanning transmission electron microscope using a digital twin
thetransformationofthedigitaltwindiffersfromtheactualmi- 1998). The returned function accepts only the Scan Rotation
croscope,theimageswillnotbesuperimposedcorrectly,leading andOverfocusasasinglevectoroftwovalues,andmapsthem
toablurredresult. from a range of [(-10, 10), (-10, 10)] to a sensible interval of
By adjusting the parameters of the digital twin while con- ±10deg resp. ±25% around their starting value for condition-
tinuously performing the superposition operation, a user or ing.Thisensuresthattheparametersareinaconvenientrange
algorithm can optimize the model parameters until the result for numerical optimizers and have roughly the same impact
is as sharp as possible. A possible metric for sharpness resp. on blurriness. That way, common optimizer implementations
blurriness was described by Crete et al. (2007). The process workwiththeirdefaultparameters.Seesection“Dataandcode
ofoptimizingsharpnessissimilartoconventionalfocusingand availability”foralinktothesourcecodeandexamples.
two-fold astigmatism adjustment, meaning it is intuitive for The test dataset presented in Figures 5 - 9 was obtained
microscopeusers. usingagoldcross-gratingreplicasample.Dataacquisitionwas
The data processing routine is implemented as a conducted on a JEOL GRANDARM2 equipped with a Mer-
LiberTEM(Clausenetal.,2023b)user-definedfunction(UDF) linEM 4R (quad-chip Medipix) system. The physical pixels on
called “OverfocusUDF” that performs the superposition and the detector chip are 55 µm wide. The scanning coils of the
extracts the additional control images. This allows for fast of- microscope are synchronized with the detector through TTL
fline and live processing together with live visualization and signals via a BNC cable. The scan array consists of 64 by 64
dynamicparameterupdates. steps, with each step measuring 12.5 nm. The frames, each
For a smooth user interaction the superposition should be comprising 512 by 512 pixels, were each exposed for 1ms,
performed very quickly. TEMGYM Basic does trace rays at culminating in a total acquisition time of approximately 4
highspeed,butitisstilltooslowtodeterminethetargetscan seconds.
coordinates for each data point in a 4D STEM dataset in real The Supplementary Material (Weber et al., 2023) contains
time. For that reason a linear transformation from detector a full screen capture video with explanation of the very first
pixel position and scan position to specimen pixel position is live adjustment using this method. The test specimen was a
derivedfromasetofsampleraysusingaleastsquareoptimiza- semiconductor heterostructure in the bump-bonding region of
tion. This transformation is applied using an optimized kernel a PCB, where a random area was selected for the preparation
writteninNumba. ofaTEMlamellausingafocusedionbeam(FIB)instrument.
Inmanycasestheinitialparameterswillbefarofftheirideal A prototype of the DECTRIS ARINA detector mounted on a
values, resulting in a featureless superposition image. Since probe corrected JEOL JEM-ARM200F transmission electron
multiple parameters have to match at least approximately in microscope was used to record the live data. The microscope
order to form an image with recognizable features, two helper wasoperatedat200kVaccelerationvoltageinSTEMmodewith
tranformationswereimplemented: aprobeof28.2mradsemi-convergenceangleand116pAbeam
Byselectingasingledetectorpixelandplottingitsvalueas current. The ARINA detector was operated at 50 kHz frame
afunctionofscanposition, avirtualdetectorimagewithvery rate with (2x2) binning which resulted in 96x96 detector pix-
largedepthoffocuscanbeobtained,asdescribedin(Huetal., els (detector pixel size: 100 um). This was performed using a
2023) (Figures 5 - 8, label “OverfocusUDF: point”). As long prototypeimplementationofthemethoddescribedhere. Most
as the dose and detector resolution is sufficient, this will be a notably,itdidn’tuseTEMGYMandacceleratedraytracingyet,
recognizableimageofthespecimeninscancoordinates.Second, but a preliminary manual ray tracing implementation of the
a single shadow image on the detector can be transformed to model described above. The detector data was not recorded
scancoordinateswithoutsuperimposingitwithshadowimages duetotheephemeralnatureofliveprocessing.
fromotherscanpositions(Figures5-8label“OverfocusUDF:
selected”).
Iftheparametersareadjustedwithsufficientaccuracy(Fig-
ures8and9),thesetwoimageswilllookthesame.Byvisually Results
comparingthem,ausercanroughlyadjusttheoverfocusvalue
by comparing the scale, and the rotation and handedness by Areliablemanualalignmentcouldbefoundinlessthan15min
observing a unique feature on the specimen (Figures 5 – 7). ontheveryfirstattemptwiththisapproachusingaprototype
Thiscoarseadjustmentwillusuallybeaccurateenoughtoob- implementation. See the Supplementary Material at (Weber
serve features in the superimposed image (Figure 7), allowing etal.,2023)forascreencapturevideoofthisfirstattemptwith
forfurtherincrementaloptimizationofallparametersfollowing explanations,andadetaileddescription.Notehowliveprocess-
aprotocolsimilartooptimizingfocusandastigmatism. ingallowedadjustmentofmicroscopeparametersandspecimen
Themodelcurrentlydoesn’taccountfordescanerror.How- movementinteractively.Observingspecimenmovementallowed
ever, the presence of descan error is checked by summing up rough calibration of scale, rotation and handedness even on a
detectorimageswithouttransformation.Withoutdescanerror, detector with a low number of pixels such as the DECTRIS
the beam should have the same position on the detector in- ARINA, which can only show a small region of interest at
dependent of the scan position. That means that a sum of all coarse spatial resolution. We also note that the high frame
detectorimagesshouldyieldasharpimageoftheaperturethat rate of the ARINA detector gave a sufficient scan repetition
formstheprimarybeam. rate to observe the effect of changes in near real time. The
Additionally,alossfunctionsuitablefornumericaloptimiza- rotation and handedness parameters obtained with the digital
tioncanbederivedfromthecalculationoftheblurrinessofthe twin were validated to correspond to the parameters of Lib-
superimposedimage as afunction of ScanRotation and Over- erTEM’scenterofmass(CoM)analysis(Clausenetal.,2023a)
focus.Autilityfunctionisincludedwiththe“OverfocusUDF” andthesinglesideband(SSB)implementationinthePtychog-
thatcreatessuchalossfunctionbywrappingotherparameters raphy4.0project(Weberetal.,2021).Thisenabledsuccessful
forexecutingit,suchasLiberTEMContext,datasetandthere- ptychographicreconstructionusingthisSSBimplementationin
mainingmodelparameters,inaclosure(Sussman&SteeleJr., unrelated experiments following the adjustment in the screen5
Figure 5. Starting condition with scale and alignment miscalibrated. Figure 6. Compared to Figure 5, the “Overfocus” parameter was ad-
Control interfaces for the calibration parameters are shown at the bot- justed so that “OverfocusUDF: point” and “OverfocusUDF: selected”
tom.Thefield“Blurmetric”showstheblurrinessofthe“OverfocusUDF: haveapproximatelythesamescale.
shiftedsum”imageascalculatedbythealgorithmbyCreteetal.(2007).
The plot “OverfocusUDF: point” shows the trace of a single detector
pixel as a function of scan position. “OverfocusUDF: shiftedsum” is
the main adjustment plot that shows all detector images superimposed
in specimen coordinates according to the transformation calculated by
TEMGYMthatisderivedfromtheinputparametersbelowtheplots.If
thetransformationbyTEMGYMmatchestheactualtransformationby
the microscope, this plot is a sharp image of the specimen. Note that
itisblurredhereanddoesn’tshowanyspecimenfeatures, meaningthe
parametersarenotcorrectyet.“SumUDF:intensity”showsasumofall
untransformed diffraction patterns. The plot “OverfocusUDF: selected”
showsthediffractionpatternatthecenterofthescangridrotatedand
scaledtoscancoordinatesaccordingto thecurrentsettings. Structures
of the specimen are only recognizable in “OverfocusUDF: point”, while
“OverfocusUDF:selected”magnifiestheframesomuchwiththecurrent
settings that only a few pixels are in the field of view. The sharp im-
ageofthebeam-formingapertureshowsthatthepivotpointisadjusted
correctlysincetheapertureisatthesamepositionforeachscanpoint.
“OverfocusUDF:sum”showsthesumofpartiallytransformeddiffraction
patternswhereonly“ScanRotation”and“FlipY”areapplied, incon-
trastto“SumUDF:intensity”thatshowsthesumoftheuntransformed
diffractionpatternswherethepositionofthebeamonthedetectorcan
bejudged.
Figure 7. Compared to Figure 6, the “Scan Rotation” and “Flip Y”
parameterswereadjustedsothat“OverfocusUDF: point”and“Overfo-
capturevideo.TheresultsforOverfocus,ScanPixelSize,Cam-
cusUDF:selected”showapproximatelythesameimage.Blurredspecimen
era Length and Detector Pixel Size have not been validated
featuresarestartingtoappearin“OverfocusUDF:shiftedsum”.
experimentallyyet.
TheFigures5-8showthemanualadjustmentprocedurewith
the test dataset described in the previous section using the
mostrecentsoftwareversion.Thedatasetisavailableat(Weber asspecimenregion,magnificationandfocus,andmodelparam-
etal.,2023). eters. However, many repeated scans may degrade a specimen
The processing takes 1.5s for a single pass over the test throughradiationdamageorcontamination.
file used in Figures 5-9, a MIB 4D STEM dataset of size 64 A loss function using the blurriness metric (Crete et al.,
× 64 × 512 × 512 with 16 bits per pixel, corresponding to a 2007)asimplementedintheScikit-Image(vanderWaltetal.,
data rate of about 1.4GB/s or 2730 frames per second, on an 2014) function skimage.measure.blureffect was created us-
AMD EPYC 7F72 with 24 physical cores and 256 GB RAM ing the helper function described in the previous section.
using LiberTEM 0.13 and the default Dask executor. Process- It was minimized numerically using the “simplicial homol-
ingtakes1.38s,correspondingtoanuncompresseddatarateof ogy global optimization” (SHGO) algorithm (Endres et al.,
about 3.5GB/s or 47,000 frames per second, for a file of size 2018)with“constrainedoptimizationbylinearapproximation”
256×256×192×192with16bitsperpixelinthecompressed (COBYLA, Powell (1994)) for local search, as implemented in
HDF5formatgeneratedbytheDECTRISARINA.Thisisfast theSciPy(Virtanenetal.,2020)functionscipy.optimize.shgo.
enough to follow typical 4D STEM data rates live. Live pro- The result is shown in Figure 9. The fast processing of Lib-
cessingallowsadjustmentofbothmicroscopeparameters,such erTEM and the OverfocusUDF allows numerical optimization6 Calibrating coordinate system alignment in a scanning transmission electron microscope using a digital twin
onlyworksatlowormediummagnification,notatatomic
resolution,sinceitdoesn’ttakediffractionintoaccount.
2. SettheScanPixelSize,CameraLengthandDetectorPixel
Sizetotheircorrectvalues,asfarasknown.
3. Adjust the focus of the microscope so that specimen fea-
turesarerecognizableonthedetector.Ideally,thefeatures
on the detector have roughly the same scale as in the
“OverfocusUDF:point”plot.
4. SettheOverfocusvalueaccordingtotheoverfocusgivenby
the microscope. Specimen features should be recognizable
in both the “OverfocusUDF: point” and “OverfocusUDF:
selected”plotsnow.
5. If possible, adjust Overfocus so that features in “Over-
focusUDF: point” and “OverfocusUDF: selected” have
roughly the same scale. This works well on grids, for
example.
6. AdjustScanRotationandFlipYsothatmovementsofthe
specimenorlow-symmetryspecimenfeaturesareconsistent
between “OverfocusUDF: point” and “OverfocusUDF: se-
lected”.Ablurredimageofthespecimenshouldappearin
Figure 8. Compared to Figure 7, the “Overfocus” and “Scan Rota-
“OverfocusUDF:shifted sum”now.
tion” parameters are fine-tuned so that “OverfocusUDF: shiftedsum”
appearssharp.Notehowasmallchangein“Overfocus”and“ScanRota- 7. Confirm that the scale is approximately the same between
tion”comparedtoFigure7causesalargedifferencein“OverfocusUDF: “OverfocusUDF:point”and“OverfocusUDF:selected”.
shiftedsum”,demonstratingthesensitivityofthismethod. 8. Fine-tune Scan Rotation and Overfocus until “Overfo-
cusUDF:shifted sum”issharp. ConfirmthatFlipYisset
correctlyiftheimageremainsblurred.
9. Optionally,refinewithnumericaloptimization.Thisworks
once “OverfocusUDF: shifted sum” appears only moder-
atelyblurred,meaningthestartingvaluesarealreadyclose
enough.
Discussion
Live processing was helpful for finding a suitable specimen re-
gion and microscope parameters as well as coarse adjustment
ofScanRotationandFlipY,sinceobservingtheeffectofspec-
imen movement interactively helps to orient the user. For fine
adjustmentsitisadvantageoustorecordadatasetaftercoarse
adjustmentofmicroscopeandalignmentparametersthatshow
recognizablefeaturesinthesuperpositionimage.Theusercan
then continue to adjust on such an offline dataset. LiberTEM
allows using offline and live data interchangeably, which helps
the implementation of such a workflow. This avoids excessive
exposureofthespecimen.Furthermore,recordingsuchanover-
focusedcalibrationdatasetbeforerealmeasurementscanallow
Figure9.ComparedtoFigure8,the“Overfocus”and“ScanRotation”
latervalidationoftheparametersfordatainterpretation.
parametersarenumericallyoptimizedbyminimizingtheblurmetricusing
Currently,theimplementationusesTEMGYMBasicforthe
globaloptimizationwithinanintervalaroundthevaluesinFigure8.
digital twin, i.e. a matrix optics approximation. However, the
method is not limited to this: The ray tracing engine is ex-
changeableaslongasitacceptsthesameparameters,meaning
amoreadvancedmodelsuchasTEMGYMAdvanced(Landers
within about 12s from Figure 8 to Figure 9 on the system
et al., 2023a,b) could be used. This software traces electron
described above. The optimization converged reliably to near
trajectories through electromagnetic fields and enables the in-
optimalvaluesfromvariousstartingvalues,providedtheopti-
clusion of 3rd order and higher aberration effects from the
mum was within the optimization bounds around the starting
objectivelens.Iftheinternalinterpolationforquickmappingof
value as described in the previous section. The optimization
detectorframesisadaptedtoallownon-linearrelationsbetween
wasimplementedtoupdatetheplotslive,whichallowsobserv-
detectorpixel,scanpositionandspecimenpixel,thisapproach
ing the convergence behavior and checking if the optimization
could also be extended to take aberrations into account. Fur-
resultissensible.
thermore, the digital twin could be extended to match each
Thefollowingworkflowturnedouttobepractical:
optical element of the electron microscope exactly, as already
1. Select a specimen region, scan pixel size and other micro- demonstratedinLandersetal.(2023c).
scopeparametersthatshowgoodcontrastandrecognizable Themethodprovidesaclearvalidationforparametersthat
features in the “OverfocusUDF: point” plot. The method leaves little room for error or interpretation: If the resulting7
image is sharp, the parameters of microscope and digital twin any simplified abstract model, such as the STEM model here.
are consistent. It can be performed as part of a 4D STEM It also allows transformation of parameters between different
acquisition workflow without switching detector or scan en- models,forexampletodeterminetheparametersonadifferent
gine.Furthermore,itissufficientlyfasttoperformmanychecks microscope to perform an equivalent projection. A set of com-
duringa session, for example after achange of microscopepa- prehensivemodel,parametersandcalibrationcandescribethe
rameters. In particular if a good initial guess is available, fine actionoftheinstrumentineverydetailandineverystateina
adjustment is quick and intuitive, and can even be performed reproducible way, provided the model is sophisticated enough.
automatically.Sincetheimageusedforfinecalibrationiscom- Atthesametime,correspondingparametersforanysimplified
posed of many detector frames, it has a better signal to noise model can be derived using, for example, a numerical solver.
ratiothanindividualdetectorframesortheplotofthecentral Thatallowstousethesamemetadataschemaandmodelframe-
pixel, allowing quick fine calibration at a higher scan rate and workforanyanalysisperformedwithanyTEM.Thatmeansa
lowbeamcurrentifagoodstartingvalueisknown. comprehensive digital twin constitutes a potential foundation
ThecurrentuserinterfaceinaJupyternotebookworksasa foruniversalmetadataforelectronmicroscopy.
proofofconcept.Inthefuture,astand-alonetoolcouldbede-
velopedorthemethodcouldbeintegratedintothemicroscope
Code and data availability
control software. In particular, the actual microscope parame-
terscouldbereadoutdigitallyandappliedtothedigitaltwin.
The source code for the adjustment code as well as the
Ifmicroscopecalibrationvaluesinsteadofmodelparametersare
Jupyter notebook to run it on offline data can be found
optimized,itwouldallowthemicroscopetooperatedirectlyin
at https://github.com/LiberTEM/Microscope-Calibration/tree/
unitsthatcorrespondtothedigitaltwin.
37066766ab446153ec2ebb3370cb879905cc410b.
The approach is also extensible to other parameters of the
The TEMGYM Basic version used here is https://github.
microscopethatchangethedetectorimageinasystematicway
com/TemGym/TemGym/tree/bc28049225489b6ca75bc3377a4c64f53d77eb31.
andallowsuperpositionoftransformeddetectorimagestoform
The dataset used in the figures for offline calibration, a
a sharp image of an object in the beam, such as a specimen
screen capture video and additional explanation, as well as
or aperture. As a disadvantage, it only works with 4D STEM
a runnable Apptainer image with the complete software stack
detectors,notconventionalorsegmentedSTEMdetectors.
for reproducibility can be found at https://doi.org/10.5281/
It should be investigated if changing the focus strongly
zenodo.10418769.
in real microscopes can affect the observed rotation or other
parameters.
Inthispaperwealreadyshowhowparameterscanbetrans- Acronyms
formed between three different models or digital twins that
describe the projection performed by the microscope: TEM- STEM scanningtransmissionelectronmicroscopy
GYMBasicusesraytracingthroughasimplifiedSTEMmodel DPC differentialphasecontrast
based on a linear approximation for an objective lens and CoM centerofmass
doublebeamdeflectors(Figure3).Theparametersexposedto- SSB singlesideband
wardstheuser(controlsinFigure5-9)describeasimplermodel UDF LiberTEM(Clausenetal.,2023b)user-defined
wherethebeamisnotdeflectedbydoubledeflectorsorfocused function
byalens,butwherethespecimencoordinatesystemissimply
shifted and a focus position is specified (Figure 2). Internally,
Financial support
the“OverfocusUDF”usesasimpleraytransfermatrixthatdi-
rectlyperformsamappingfromdetectorcoordinatesandscan Swiss National Science Foundation is kindly acknowledged
positiontospecimenpixelcoordinatesforoptimalperformance. for co-funding the electron microscope (R’Equip Project
Since each model is linear, and provides a good approxi- 206021 177020)usedherein.
mation of the actual instrument’s behaviour under the chosen WegratefullyacknowledgesupportbytheAIDASproject.
conditions,theseareequivalentdescriptionsofthesametrans- This project has received funding from the European
formation that are specified in different ways to match the Union’s Horizon 2020 research and innovation programme
context in which they are used. It also allows matching them undergrantagreementNo823717–ESTEEM3.
exactly using computational methods. The user interface aids We gratefully acknowledge support by DECTRIS for pro-
theuserinfindingapproximateparametersthatmatchtheac- vidingaccesstoaprototypeoftheARINAdetectoratPSI.
tualprojectionbytheinstrument.Numericaloptimizationcan
thenbeusedtofine-tunethisresultfurther. Ineffect, thisde-
termines the instrument parameters in a reliable and precise Competing interests
way.
Theauthorsdeclarenocompetinginterests.
Currently,thecommonlyusedimplicitmodelsandparame-
tersformetadataschemasanddataanalysisonlyapproximate
the action of the instrument in specific optical modes such as References
transmission electron microscopy (TEM), STEM, electron en-
ergy loss spectroscopy (EELS), etc. The model in Figure 2 Bu¨rger, J., Riedl, T. & Lindner, J. (2020). Influence of
can describe strongly defocused STEM, but can’t model the lens aberrations, specimen thickness and tilt on differential
projection for in-focus STEM since it doesn’t consider diffrac- phasecontrastSTEMimages,Ultramicroscopy 219,113118.
tion,forexample.Ifamorecomprehensiveorevenfullphysical Clausen, A., Weber, D., Bryan, M., Ruzaeva, K., Mi-
modelisusedtodescribetheprojectionbythemicroscope,the gunov, V., Baburajan, A., Bahuleyan, A., Caron,
approach described here can allow transformation of physical J., Chandra, R., Dey, S., Halder, S., Katz, D.S.,
parameters,suchasobjectivelenscurrent,intoparametersfor Levin, B.D., Nord, M., Ophus, C., Peter, S.,8 Calibrating coordinate system alignment in a scanning transmission electron microscope using a digital twin
Pusk´as, L., Schyndel van, J., Shin, J., Sunku, Ozdol,V.B.,Gammer,C.,Jin,X.G.,Ercius,P.,Ophus,
S., ˚Anes, H.W., Mu¨ller-Caspary, K. & Dunin- C., Ciston, J. & Minor, A.M. (2015). Strain mapping
Borkowski, R.E. (2019). LiberTEM concepts: Coordi- atnanometerresolutionusingadvancednano-beamelectron
nate system, URL https://libertem.github.io/LiberTEM/ diffraction,Applied Physics Letters 106.
concepts.html#coordinate-system. Powell, M.J.D. (1994). A Direct Search Optimization
Clausen, A., Weber, D., Bryan, M., Ruzaeva, K., Mi- Method That Models the Objective and Constraint Func-
gunov, V., Baburajan, A., Bahuleyan, A., Caron, tions by Linear Interpolation,51–67,SpringerNetherlands.
J., Chandra, R., Dey, S., Halder, S., Katz, D.S., Rollett, A.D. & Barmak, K.(2014).Orientation Mapping,
Levin, B.D., Nord, M., Ophus, C., Peter, S., Pusk´as, 1113–1141,Elsevier.
L., Schyndel van, J., Shin, J., Sunku, S., ˚Anes, Savitzky, B.H., Zeltmann, S.E., Hughes, L.A., Brown,
H.W., Mu¨ller-Caspary, K. & Dunin-Borkowski, R.E. H.G., Zhao, S., Pelz, P.M., Pekin, T.C., Barnard,
(2023a). LiberTEM API reference: ComUDF.with params, E.S., Donohue, J., DaCosta, L.R., Kennedy, E., Xie,
URL https://libertem.github.io/LiberTEM/reference/udf. Y., Janish, M.T., Schneider, M.M., Herring, P.,
html#libertem.udf.com.CoMUDF.with_params. Gopal, C., Anapolsky, A., Dhall, R., Bustillo, K.C.,
Clausen, A., Weber, D., Bryan, M., Ruzaeva, K., Mi- Ercius, P., Scott, M.C., Ciston, J., Minor, A.M. &
gunov, V., Baburajan, A., Bahuleyan, A., Caron, J., Ophus,C.(2021).py4DSTEM:Asoftwarepackageforfour-
Chandra, R., Dey, S., Halder, S., Katz, D.S., Levin, dimensionalscanningtransmissionelectronmicroscopydata
B.D., Nord, M., Ophus, C., Peter, S., Pusk´as, L., analysis,Microscopy and Microanalysis 27,712–743.
Schyndel van, J., Shin, J., Sunku, S., ˚Anes, H.W., Shibata, N., Findlay, S.D., Kohno, Y., Sawada, H.,
Mu¨ller-Caspary,K.&Dunin-Borkowski,R.E.(2023b). Kondo, Y. & Ikuhara, Y. (2012). Differential phase-
LiberTEM/LiberTEM:0.13.1. contrastmicroscopyatatomicresolution,Nature Physics 8,
Crete, F., Dolmiere, T., Ladret, P. & Nicolas, M. 611–615.
(2007). The blur effect: perception and estimation with a Sussman, G.J. & Steele Jr., G.L.(1998).Scheme:Ainter-
newno-referenceperceptualblurmetric,B.E.Rogowitz,T.N. preterforextendedlambdacalculus,HigherOrderSymbolic
Pappas & S.J. Daly (eds.), Human Vision and Electronic Computation 11,405–439.
Imaging XII,SPIE. Usuda, K., Numata, T., Irisawa, T., Hirashita, N.
Endres, S.C., Sandrock, C. & Focke, W.W. (2018). & Takagi, S. (2005). Strain characterization in SOI and
A simplicial homology algorithm for Lipschitz optimisation, strained-Si on SGOI MOSFET channel using nano-beam
Journal of Global Optimization 72,181–217. electrondiffraction(NBD),MaterialsScienceandEngineer-
Hamilton, D.K. & Sheppard, C.J.R. (1984). Differential ing: B 124–125,143–147.
phase contrast in scanning optical microscopy, Journal of van der Walt, S., Sch¨onberger, J.L., Nunez-Iglesias, J.,
Microscopy 133,27–39. Boulogne, F., Warner, J.D., Yager, N., Gouillart, E.
Hoppe, W. (1969). Beugung im inhomogenen & Yu, T.(2014).scikit-image:imageprocessinginPython,
Prim¨arstrahlwellenfeld. I. Prinzip einer Phasenmessung von PeerJ 2,e453.
Elektronenbeungungsinterferenzen, Acta Crystallographica Viladot, D., V´eron, M., Gemmi, M., Peiro´, F., Por-
Section A25,495–501. tillo, J., Estrad´e, S., Mendoza, J., Llorca-Isern, N. &
Hu, Y., Gao, S., Wu, X., Pei, X., Huang, F., Mao, Nicolopoulos, S. (2013). Orientation and phase mapping
W., Zhang, W., Horne, A., Gu, Z. & Wang, P.(2023). in the transmission electron microscope using precession-
4D-Explorer:Avisualsoftwarefor4D-STEMdataprocessing assisted diffraction spot recognition: state-of-the-art results,
andimagereconstruction,arXiv . Journal of Microscopy 252,23–34.
Landers,D.,Clancy,I.,Dunin-Borkowski,R.E.,Weber, Virtanen, P., Gommers, R., Oliphant, T.E., Haber-
D. & Stewart, A. (2023a). TEMGYM advanced: Software land, M., Reddy, T., Cournapeau, D., Burovski, E.,
for electron lens aberrations and parallelised electron ray Peterson, P., Weckesser, W., Bright, J., van der
tracing,Ultramicroscopy 250,113738. Walt, S.J., Brett, M., Wilson, J., Millman, K.J.,
Landers, D., Clancy, I., Dunin-Borkowski, R.E., We- Mayorov, N., Nelson, A.R.J., Jones, E., Kern, R.,
ber, D. & Stewart, A.A. (2023b). TEMGYM advanced – Larson, E., Carey, C.J., Polat, I˙., Feng, Y., Moore,
NanoMilenscharacterisation,Micron 169,103450. E.W.,VanderPlas,J.,Laxalde,D.,Perktold,J.,Cim-
Landers, D., Clancy, I., Weber, D., Dunin-Borkowski, rman,R.,Henriksen,I.,Quintero,E.A.,Harris,C.R.,
R.E. & Stewart, A. (2023c). TEMGYM basic: transmis- Archibald, A.M., Ribeiro, A.H., Pedregosa, F., van
sion electron microscopy simulation software for teaching Mulbregt, P., Vijaykumar, A., Bardelli, A.P., Roth-
and training of microscope operation, Journal of Applied berg, A., Hilboll, A., Kloeckner, A., Scopatz, A.,
Crystallography 56,1267–1276. Lee, A., Rokem, A., Woods, C.N., Fulton, C., Mas-
Lazi´c, I. & Bosch, E.G. (2017). Analytical review of di- son, C., H¨aggstr¨om, C., Fitzgerald, C., Nicholson,
rect STEM imaging techniques for thin samples, Advances D.A., Hagen, D.R., Pasechnik, D.V., Olivetti, E.,
in Imaging and Electron Physics,75–184,Elsevier. Martin, E., Wieser, E., Silva, F., Lenders, F., Wil-
Lazi´c, I., Bosch, E.G. & Lazar, S. (2016). Phase con- helm, F., Young, G., Price, G.A., Ingold, G.L., Allen,
trast STEM for thin samples: Integrated differential phase G.E., Lee, G.R., Audren, H., Probst, I., Dietrich,
contrast,Ultramicroscopy 160,265–280. J.P., Silterra, J., Webber, J.T., Slaviˇc, J., Noth-
Ning, S., Xu, W., Ma, Y., Loh, L., Pennycook, T.J., man, J., Buchner, J., Kulick, J., Sch¨onberger, J.L.,
Zhou, W., Zhang, F., Bosman, M., Pennycook, S.J., deMirandaCardoso,J.V.,Reimer,J.,Harrington,J.,
He, Q. & Loh, N.D. (2022). Accurate and robust cali- Rodr´ıguez, J.L.C., Nunez-Iglesias, J., Kuczynski, J.,
bration of the uniform affine transformation between scan- Tritz, K., Thoma, M., Newville, M., Ku¨mmerer, M.,
camera coordinates for atom-resolved in-focus 4D-STEM Bolingbroke, M., Tartre, M., Pak, M., Smith, N.J.,
datasets,Microscopy and Microanalysis 28,622–632. Nowaczyk, N., Shebanov, N., Pavlyk, O., Brodtkorb,9
P.A., Lee, P., McGibbon, R.T., Feldbauer, R., Lewis, transmission electron microscope using a digital twin., URL
S., Tygier, S., Sievert, S., Vigna, S., Peterson, S., https://doi.org/10.5281/zenodo.10418769.
More, S., Pudlik, T., Oshima, T., Pingel, T.J., Ro- Weber, D., Lesnichaia, A., Strauch, A., Clausen,
bitaille,T.P.,Spura,T.,Jones,T.R.,Cera,T.,Leslie, A., Bangun, A., Melnyk, O., Meissner, H., Ehrig,
T., Zito, T., Krauss, T., Upadhyay, U., Halchenko, S., Wendt, R., Sukumaran, M., Wollgarten, M.,
Y.O. & V´azquez-Baeza, Y.(2020).SciPy1.0:fundamen- zu Castell, W. & Mu¨ller-Caspary, K. (2021). Ptychog-
tal algorithms for scientific computing in Python, Nature raphy4.0:0.1.0.
Methods 17,261–272. Yang,H.,MacLaren,I.,Jones,L.,Martinez,G.T.,Sim-
Weber, D., Landers, D., Huang, C., Liberti, E., son, M., Huth, M., Ryll, H., Soltau, H., Sagawa, R.,
Poghosyan, E., Bryan, M., Clausen, A., Stroppa, Kondo, Y., Ophus, C., Ercius, P., Jin, L., Kov´acs, A.
D.G., Kirkland, A.I., Mu¨ller, E., Stewart, A. & &Nellist,P.D.(2017).Electronptychographicphaseimag-
Dunin-Borkowski, R.E. (2023). Supplementary material ing of light elements in crystalline materials using Wigner
for: Calibrating coordinate system alignment in a scanning distributiondeconvolution,Ultramicroscopy 180,173–179.
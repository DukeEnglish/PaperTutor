HistoKernel: Whole Slide Image Level Maximum
Mean Discrepancy Kernels for Pan-Cancer
Predictive Modelling
Piotr Keller1*†, Muhammad Dawood1, Brinder Singh Chohan1,2,
Fayyaz ul Amir Afsar Minhas1
1*Tissue Image Analytics Centre, University of Warwick, Coventry ,
CV4 7AL, United Kingdom.
2*Department of Cellular Pathology, Royal Derby Hospital, Derby,
DE22 3NE, United Kingdom.
*Corresponding author(s). E-mail(s): Piotr.Keller@warwick.ac.uk;
Contributing authors: Muhammad.Dawood@warwick.ac.uk;
b.chohan@nhs.net; Fayyaz.Minhas@warwick.ac.uk;
†First Author.
Abstract
Machine learning in computational pathology (CPath) often aggregates patch-
level predictions from multi-gigapixel Whole Slide Images (WSIs) to generate
WSI-levelpredictionscoresforcrucialtaskssuchassurvivalpredictionanddrug
effectprediction.However,currentmethodsdonotexplicitlycharacterizedistri-
butional differences between patch sets within WSIs. We introduce HistoKernel,
anovelMaximumMeanDiscrepancy(MMD)kernelthatmeasuresdistributional
similarity between WSIs for enhanced prediction performance on downstream
prediction tasks.
OurcomprehensiveanalysisdemonstratesHistoKernel’seffectivenessacrossvar-
ious machine learning tasks, including retrieval (n = 9,362), drug sensitivity
regression(n=551),pointmutationclassification(n=3,419),andsurvivalanal-
ysis(n=2,291),outperformingexistingdeeplearningmethods.Additionally,His-
toKernelseamlesslyintegratesmulti-modaldataandoffersanovelperturbation-
based method for patch-level explainability. This work pioneers the use of
kernel-based methods for WSI-level predictive modeling, opening new avenues
for research. Code is available at https://github.com/pkeller00/HistoKernel.
1
4202
guA
9
]GL.sc[
1v59150.8042:viXraKeywords:ComputationalPathology,MutationPrediction,ImageRetrieval,Drug
Sensitivity,SurvivalAnalysis
1 Introduction
Advances in Computational Pathology (CPath) have demonstrated that machine
learningcaneffectivelyutilizeWholeSlideImages(WSIs)toaddressvariousclinically
relevant problems [1, 2]. Due to their large size and high memory demands, WSIs are
divided into smaller patches for model training using weakly supervised approaches
to perform patch-level predictions. These are then aggregated into a single slide-level
prediction. The development of patch-level foundation models has further increased
the need for efficient aggregation techniques [3].
Three main branches of aggregation techniques have emerged [4]. Heuristic meth-
ods generate predictions for each patch independently and aggregate them using
fixed statistics, such as majority voting [5, 6]. These methods assume equal contribu-
tion from all patches, which fails to capture complex relationships and dependencies,
and can lead to sensitivity to outliers and the overshadowing of significant patches
if they are in the minority. Clinically driven aggregations use domain-specific rules,
like calculating overall WSI tumor cell percentage based on patch-level counts [4].
While interpretable, they require established clinical rules, limiting their appli-
cability. Data-driven methods, including attention mechanisms and graph neural
networks (GNNs) [7], can weigh patches based on relevance and context, but their
learnedparametersaretask-specific,makingthemlessgeneralizablewithoutextensive
retraining, and are computationally intensive.
Crucially, existing aggregation approaches cannot explicitly quantify the differ-
encesorsimilaritiesinthemulti-variabledistributionsofpatchesintwoWSIs,limiting
theireffectiveness.ThisgapisaddressedbyournovelWSI-levelMaximumMeanDis-
crepancy (MMD) kernels. These kernels act as statistical tests to determine if two
WSIs,modeledassetsofpatches,aredrawnfromdifferentdistributionsbycomparing
infinite statistical moments [8]. This capability allows us to define pairwise simi-
larity between WSIs, facilitating numerous downstream tasks such as visualization,
clustering, regression, classification, and survival analysis [9, 10].
2 Results
At its core, the proposed approach allows calculation of the degree of similarity
between two WSIs in the form of a kernel function (henceforth called HistoKernel)
based on patche feature embeddings. These patch-level feature embeddings can be
obtainedfromanypre-trainedembeddingorfoundationmodel(SeeMethods:4.3and
Fig 1 part (a)). Intuitively, if the kernel score between two WSIs is high then, with
high probability, patches in these WSIs come from the same underlying distribution.
Conversely, if the kernel score between two WSIs is small then that implies there is a
substantial difference between the statistical distributions of patches comprising the
two WSIs. This provides a principled way for identifying relationships between WSIs
2and allows the use of any kernel-based approaches for modelling downstream predic-
tiontasks.Furthermore,foragivendataset,thekerneliscomputedonlyonceandcan
be used for several tasks without re-computation leading to significant computational
savings.Weemphasisethekernelcomputationispurelyunsupervised,notargetlabels
are required for computing HistoKernel.
Below,wedemonstratetheversatilityandeffectivenessofHistoKernelacrossmul-
tiple tasks in CPath such as visualization and clustering, WSI retrieval, regressing
(a)
𝐊
𝐈
𝐗 𝐈 𝑁# 𝐾 !’,’$ = 𝑥 !’,𝑥 !’$ Ma Dx isim cru em pa M nce ya n
𝑝 !"
𝑝 !#
𝑁 !𝑋#*=𝒙𝑰𝒊∈ℝ) , ( KM eM rnD el)
⋱ 𝑁# Matrix
𝑋 ! 𝑝 !$! 1024 𝑑 𝐊 𝐊𝑾𝑺𝑰=𝒆$𝜸𝑫𝑴𝑴𝑫
Patch Feature 𝐈𝐉
Wh Imol ae
g
S el side P Pr ae t- cp hr o Ec xe trs as cin tig
o
&
n
Extraction via 𝑁# 𝐾 !’ %,*= 𝑥 !’,𝑥 %* 𝐾’(= 𝑋’,𝑋( 𝑁
RetCCLEncoder
, ,
𝑋 % 𝑑 𝑁% 𝑁
𝑝 %" 𝐗 𝑱 𝐊 𝐉
𝑝 %# ⋱ 𝑝$" 𝑁 % 𝑋 %&=𝒙 𝑱𝒋∈ℝ) 𝑁%𝐾 %*,*$ = 𝑥 %*,𝑥 %*$
% ,
𝑁%
(b) (c)
Cancer Type
0.0 1.0
Fig. 1 (a) Workflow of Whole Slide Image (WSI) level Maximum Mean Discrepancy (MMD) ker-
nel computation. Each WSI is processed by extracting 1024×1024 patches after applying a tissue
mask [11]. Patch features are then extracted using a feature encoder, and Equation 4 computes the
pairwiseMMDkernelbasedonthesefeatures.ThisresultsinapairwiseMMDkernelmatrixforthe
dataset with entries KWSI showing the similarity between any two WSIs. The pairwise MMD ker-
IJ
nelmatrixforalln=12,186WSIsinTCGAresultinginmorethan74millionWSIpairsisshown
in (b), with each entry representing WSI similarity (blue to red in intensity). Unsupervised hier-
archical clustering of the kernel matrix reveals distinct clusters corresponding to cancer types (see
legend), indicating the kernel captures expressive and meaningful information despite the method’s
unsupervisednature.UnsupervisedUMAPvisualizationin(c)furthercorroboratesthisbyshowing
meaningfulclustering,witheachdotrepresentingaWSI.TheWSI-levelMMDkernelmatrixisthen
used for downstream tasks such as classification, regression, retrieval and survival prediction with
mutltimodaldataintegration.
3
1024
noitatupmoC
lenreK
DMM
esiwriaPcancerdrugsensitivity,classificationofpointmutationclassificationsandmulti-modal
data integration for survival analysis.
2.1 Visualization and Clustering
Fig 1 (b) shows HistoKernel for the entire TCGA dataset comprising more than 74
million pairs of WSIs. The degree of similarity between any two WSIs is expressed
as a single number leading to the interpretation of the kernel matrix as an affinity
matrix that can be used for hierarchical clustering or two-dimensional visualization
through UMAP (see Fig 1 (b) and (c)). These visualizations clearly show WSIs of
the same cancer type are clustered closer to each other in comparison to those from
other types. Thus, HistoKernel is able to capture meaningful similarities between
WSIs based on cancer type despite the fact that no cancer type labels or any other
type of target labels are used in kernel computation. The kernel matrix visualization
provides useful insights into similarities and differences in WSIs of different cancer
types which typical patch-based approaches cannot do. For example, the UMAP plot
shows some cancer types are very distinguishable such as brain and prostate whilst
others are more closely clustered such as liver and endocrine tumours. It also allows
for identification of cancer sub-populations such as the two predominant sub-clusters
in endocrine tumours. Investigating the reasons for these patterns can help broaden
our understanding of cancer. Dataset visualization can also be used for identifying
potential noise or outliers, allowing interactive quality control in a CPath pipeline.
2.2 Whole Slide Image Retrieval
WeutaliseHistoKernelforWSIretrieval.Here,weareinterestedinretrievingthetop
k most similar WSIs for a given query image, X . Effective retrieval can be used to
q
aidinclinicaldiagnosisfornewpatientsbasedondiagnosisofsimilarpatients.Itmay
also help train new histopathologists by showing them similar images with the same
diagnosis to help identify common histology patterns such as gland shape often used
for prostate cancer grading [12].
To perform WSI retrieval we directly query HistoKernel matrix to find the
most similar images (see Methods: 4.8). We compared performance of the proposed
approach with current State of the art (SOTA), RetCCL, under the same validation
protocol [13].
Table 1 shows the majority vote at the top five search results (mMV@5) achieved
by HistoKernel and SOTA [13] for each cancer sub-type. The mMV@5 measures the
percentageofsamplesintestsetforwhichthemajoritycancersub-typeinthetop−k
retrievedsamplesisthesameasthequeryimage.WeseeHistoKernelconsistentlyout-
performedRetCCL,12%highermMV@5macro-averageacrossallsub-types.Further,
HistoKernel’s results are statistically significantly higher than comparative method
(Wilcoxon paired signed rank test found p≪0.01). Thus, overall we can be confident
HistoKernel has significantly outperformed the SOTA for WSI retrieval.
4Table 1 Theresultsofcancersub-typeretrieval.Thetableshowsthemajorityvoteatthetop5
searchresults(mMV@5)achievedbyHistoKernelandcomparativemethod[13]foreachcancer
sub-typeconsideredintheTCGA.ThemMV@5metricmeasuresthepercentageofsamplesintest
setforwhichthemajoritycancersub-typeinthetop−k retrievedsamplesisthesameasthequery
image.FromthistableitisclearthatHistoKernelsignificantlyoutperformedthecomparative
methodformajorityofcancertypessuggestingHistoKernelhaslearnedamoremeaningful
representationthanthecomparativemethod.
WSIType #WSIs #Patients mMV@5
RetCCL HistoKernel
Pulmonary
LUAD 531 468 53.86 73.44
LUSC 512 478 75.20 88.28
LUSC 512 478 75.20 88.28
MESO 73 67 41.10 46.58
Urinary
BLCA 457 386 91.68 98.47
KIRC 519 513 86.32 92.68
KICH 121 109 49.59 74.38
KIRP 297 273 50.51 81.48
Gastrointestinal
COAD 551 452 90.20 85.48
ESCA 157 155 50.96 74.52
READ 183 161 5.46 12.02
STAD 400 375 69.00 73.75
Melanocytic
UVM 68 68 92.65 100.0
SKCM 473 431 98.73 98.73
Brain
GBM 842 378 68.76 90.50
LGG 843 491 92.41 80.66
Liver
CHOL 39 39 5.13 35.90
LIHC 372 364 97.58 96.51
PAAD 209 183 96.17 99.04
Gynecologic
UCEC 566 505 93.64 89.22
CESC 279 269 62.37 84.23
UCS 72 45 29.17 59.72
OV 107 106 41.12 83.18
Endocrine
ACC 227 56 85.02 92.95
PCPG 192 173 76.56 91.15
THCA 447 437 96.42 97.09
Prostate/Testis
TGCT 215 138 93.49 97.21
PRAD 379 343 97.89 98.68
Hematopoiesis
DLBC 36 36 27.78 63.89
THYM 157 107 98.09 99.36
Themacro-averagemMV@5ofRetCCLandHistoKernelare69.55and81.35,respectively.
52.3 Regressing Cancer Drug Sensitivities
Next, we demonstrate HistoKernel’s capability for regression tasks by predicting can-
cer drug sensitivity from WSIs. We want to predict if a patient will respond to a
drug using only a WSI. The target drug sensitivity values are inferred as real num-
bers by aligning patients gene expression profile with cell line expression profile for
which drug sensitivity values of drugs exist [14]. This is an important task as drug
sensitivities can be used to optimise a patient’s treatment, many studies supporting
this approach [15]. Predicting drug sensitivities just from images is particularly inter-
esting as histopathological assessment is considered routine and may be more readily
available than genetic molecular tests which have high costs.
We can utilise the pre-computed HistoKernel to train a Support Vector Regressor
(SVR)toperformpredictions.WecompareperformanceofHistoKernelwiththeexist-
ing SOTA approach in this domain by Dawood et al.’s SlideGraph∞ under the same
evaluation protocol [16] with spearman rank correlation between true and predicted
sensitivities for each drug as a performance metric.
Fig 2 part (a) shows the comparison between Spearman correlation coefficient
(SCC)ofpredictedsensitivityforHistoKernel(y-axis)andthecomparativemethod(x-
axis)[16]foreachcompound.HistoKerneloutperformedcomparativemethodinterms
of SCC for 94% of compounds clearly showing its superiority. HistoKernel’s results
arestatisticallysignificantlyhigherthancomparativemethod(Wilcoxonpairedsigned
ranktestfoundp≪0.01)indicatingagenuineincreaseinperformancethatwasnota
result of chance. Finally, in Supplementary Figure 1 we see HistoKernel produced 1.5
times as many statistically significant predictors (p-value ≤ 1e−3) compared to com-
parativemethodindicatinggreaterreliabilityofHistoKernel.Fig2part(b)showsthe
distribution of HistoKernel’s top 10 models which can have numerous advantages for
patientstreatmentsuccess.Forexample,Vincristine(SCC=0.65±0.05)andPaclitaxel
(SCC=0.69 ± 0.06) are not effective for all patients [17]. Consequently, HistoKer-
nel provides a potential mechanism for early identification of patients for alternative
therapies leading to improved treatment efficacy and minimising side effects [18].
2.4 Classification of Point Mutations
To illustrate the efficacy of HistoKernel for slide-level classification problems, we per-
formpointmutationclassification.Pointmutationsaregeneticmutationsthatinvolve
achangeinasinglenucleotidebasewithintheDNAorRNAsequence[19].Numerous
studies reported associations between various genetic mutations and tumour progres-
sion and therapeutic response, highlighting the tasks importance [20]. WSI-based
point mutation predictors can act as alternatives to genetic test leading to reduced
turnaround times and costs [21].
HistoKernel was used as a precomputed kernel to train a Support Vector Machine
(SVM)toperformgenepointmutationclassification.Wecomparedperformanceofthe
proposed approach with the current SOTA under the same validation protocol [22].
Comparison results in Fig 3 part (a) show the number of genetic point mutations
for a given cancer type that were predicted with high, moderate or weak confidence
6(a) (b)
Fig. 2 Results of regressing drug sensitivities in breast cancer for Histokernel and the SlideGraph
GNN comparative method [16]. In (a) each blue dot in the plot represents the mean Spearman
correlation coefficient (SCC) achieved for a given compound by our Histokernel (y-axis) and the
comparativemethod(x-axis).ThisplotclearlyshowsthatHistoKernelhasoutperformedcomparative
method as it produced better drug sensitivity predictors for 407 out of 427 compounds. As such
HistoKernelwasbetterabletoidentifyhistopathologybasedpattersassociatedwithdrugsensitivity
compared to comparative method. In (b) we see the distribution of SCC across the 5 folds for the
top 10 drugs predicted by HistoKernel. Boxes depict quartile values and the whiskers extend to
1.5 times the interquartile range. The black line and white dot represent the median and mean of
the distribution respectively. Being able to identify drug sensitivity only from WSI with high SCC
for drugs such as Paclitaxel means we can identify which patients would most likely benefit from
Paclitaxel thus helping improve patient quality of care. Further we can see thse drugs have narrow
distributionsacrossthe5-foldsstrengtheningthereliabilityofthesemodels.
by HistoKernel and current SOTA [22]. We see HistoKernel produced 48 weak classi-
fiers whilst SOTA produced 51 thus suggesting HistoKernel performed slightly better
even without any training of the underlying patch feature extractor. Further, in Fig 3
part (b) we see direct pairwise comparison of each gene where again HistoKernel
performed marginally better (outperforming SOTA for 56% of genes). Overall, this
suggests HistoKernel is comparable or even slightly better than current SOTA which
shows its ability in a clinically relevant classification task. Two genes to note are
CDH1 in breast adinocarcinoma (AUC-ROC 0.88 ± 0.02) and PTEN (AUC-ROC
0.80±0.04)inendometrialcancerforwhichHistoKerneloutperformedSOTA.Strong
predictors for these genes can help identify patients who may benefit from targeted
therapy [23, 23, 24]. Finally, Fig 3 part (c) and (d) show heatmaps of HistoKernel’s
and SOTA’s [22] patch-level predictions respectively for TP53 point mutation predic-
tion in breast cancer. To generate HistoKernel’s patch-level predictions we utilize our
novelpatchsensitivitymethod(SeeMethods:4.5).Thesevisualisationsarepromising
as HistoKernel is identifying similar regions to current SOTA method [22] thus giving
HistoKernel predictions credibility.
2.5 Survival Analysis
Thirdly, we use HistoKernel for survival analysis. Here we use WSIs to predict the
expected time until a clinically important event occurs, for example, disease progres-
sion or death, given other patients survival data. Accurate survival predictions can
be used by pathologists to make data-driven decisions about best treatment course,
improving overall patient care. Using WSI-based deep learning we can reduce human
7(a) Predictor Strength (b) CDH1
Cancer Type
PTEN
CTNNB1TP53
NF1
Compari Hs io stn oKernel Compari Hs io stn oKernel Compari Hs io stn oKernel Compari Hs io stn oKernel Compari Hs io stn oKernel Compari Hs io stn oKernel
Comparative Method AUC-ROC
(c) Mutated Wild Type (d) Mutated Wild Type
Wild Type Mutated
Fig.3 TheresultsofgenepointmutationpredictioninsixcancertypesforHistoKernelandanSOTA
attention-basedneuralnetwork[22].Part(a)showstheresultsofgenepointmutationintermsofof
AUC-ROCbyHistoKernelandtheSOTA[22].Individualgeneclassifiersforeachmethodarebinned
into 3 groups based on their strength where blue represents weak classifiers, orange are moderate
classifiersandgreenaregoodclassifiers.HereHistoKernelproduces9goodand19moderatepredictors
in contrast to SOTA which produced 7 good and 18 moderate. This suggests HistoKernel slightly
outperformstheSOTAsuggestingthetwomethodsarecomparableincapturingmorphologicalpatters
associated with point mutations. This idea is strengthened by part (b) which shows the pairwise
comparison of comparative method and HistoKernel for each gene where either approach achieved
an AUC-ROC ≥ 0.6 (34 genes). We see HistoKernel outperformed comparison for 19 out of 34
filteredgenessuggestingitisamarginallybettermethodforpointmutationprediction.Part(c)the
heatmapofHistoKernelforaTP53mutatedWSIandawildtypeimageisshown.Part(d)weshowa
comparisonofcomparativemethod’sheatmapforthesameslidesasinpart(c).Theseheatmapsshow
thatourapproachisidentifyingsimilarpatternsasawellestablishedmethodthusgivingHistoKernel
credibilityinitspredictions.
subjectivity associated with analysing tissue visually [25] as well as the identification
of significant prognostic patterns.
HistoKernelcanbeutilisedasaprecomputedkernelforakernelizedsurvivalSVM
(KSSVM) [26] allowing us to perform survival analysis. We compare the performance
ofHistoKernelwithacomparativemodelbyMackenzieetal.’s(asurvivalGNN)under
the same evaluation protocol [27].
TheperformanceoversixdifferentsurvivalpredictiontasksiscomparedusingCon-
cordanceindex(C-index)whichmeasurestheextenttowhichtherankingsofpatients
generated by the model align their actual survival times. These scores are reported
for both methods along with the standard deviation across the five folds with the
8
tnioP
eneG
fo
rebmuN
srotciderP
noitatuM
COR-CUA
lenrekotsIHassociatedp-valueinFigure4(a).ThisshowsthatHistoKerneloutperformsthecom-
parative method for all considered cancer types. The Kaplan-Meier plots for Kidney
Renal Clear Cell Carcinoma (KIRC) produced by HistoKernel is shown in Fig 4 (b).
A clear separation between high and low risk patients is shown which medical practi-
tioners can use to select a patients’ appropriate treatment. To provide explainability
to HistoKernel we utilised our perturbation-based approach. To do this we assign all
patchesapatch-levelscoreandthenperformclusteringtoidentityrepresentativepoor
andgoodprognosispatchesasshowninFig4(c).Atrainedpathologistidentifiedclear
differences between morphology of the two patch sets. Specifically, patches predicted
tohavegoodprognosisallshowbenigntissue(mainlyrenalparenchyma).Conversely,
those predicted to have poor prognosis mostly contain clear cell renal cell carcinoma
showing chronic inflammatory cells, mainly lymphocytes. To provide a slide-level per-
spective a pathologists took a deeper look at 5 WSIs that were associated with 5 of
theserepresentativepatches.Theseslide-levelvisualisationsinFig4(d)supportedthe
idea that low risk regions mostly showed benign tissue. High risk regions contained
various patterns such as the pressure effect of tumours, tumour interface to stroma
and tumour in the vicinity of large caliber vessels. This improves trustworthiness of
Histokernelasithaspickedupclinicallyrelevantinformationthathasbeenassociated
with prognosis in current literature [28, 29].
2.6 Multi-Modal Integration with Kernels
Finally,weshowtheeaseofintegratingmultipledatamodalitieswithHistoKernel.As
aproofofconcept,wedemonstrateresultsformulti-modalsurvivalanalysisinBRCA.
Here we want to combine information from different data sources such as histological
imagedataandtranscriptomicsinordertocapturecomplementaryinformationabout
patient survival.
We build on Multiple Kernel learning to combine the pre-computed HistoKernel
withakernelbasedonpatienttranscriptomicprofilesortopics(seemethods:4.11)[30].
We can then utilise this combined kernel as a precomputed kernel for a KSSVM (as
explainedinResults:2.5).Specifically,weuseadditiveandmultiplicativecombinations
of kernels from the two modalities.
Figure5(a)showstheresultsofsurvivalpredictionintermsofC-indexforBRCA
for two multi-modal kernels. We see that both multi-modal kernels perform better
than their single-modal counterparts. A clear increase in C-index as well as a smaller
standarddeviationclearlyshowsamulti-modalapproachbettercapturespattersasso-
ciated with survival whilst being more robust. Part (c) and (d) support this idea
as Kaplan–Meier curves produced for both multi-modal kernels show a clear sepa-
ration between high and low risk patients. Further analysis of the best performing
KTOPIC+KWSI kernel shows that unsupervised hierarchical clustering of the kernel
(b) finds clear clusters forming with respect to BRCA subtypes. For example, basal-
like breast cancer forms a clear cluster and is known to be associated with worse
prognosis [31]. These results show the ease with which imaging and transcriptomic
data can be integrated.
9(a) * (b)
*
*
*
KIRC
(d) (c)
Low Risk High Risk
Fig. 4 (a) Results of survival modelling achieved by Histokernel and a GNN based comparative
method [27] for six different cancer types. Kidney Renal Clear Cell Carcinoma (KIRC), Uterine
CorpusEndometrialCarcinoma(UCEC),Astrocytoma,Glioblastoma,BladderUrothelialCarcinoma
(BLCA)andLungAdenocarcinoma(LUAD)areconsideredinthisstudy.Foreachcancertype,we
reportbothmodel’sC-indexalongwiththerespectivestandarddeviation(theblackline)acrossthe
five folds. The asterisk indicates that the results are statistically significant, p-value < 0.05. This
bar chart clearly shows that HistoKernel outperformed comparative method as it achieved a higher
C-index for all cancers considered. This suggests HistoKernel predictors are better for these cancer
types and have greater potential for clinical applications than comparative method. Part (b) shows
theKaplan-MeiersurvivalcurveofHistoKernelforKidneyRenalClearCellCarcinoma(p=0.000).
High-riskandlow-riskpatientsarerepresentedbyblueandorangerespectively.Fromthisfigureitis
clearthatsampleshavebeensuccessfullystratifiedintohighandlowriskpatients.Suchastratification
may be useful to doctors in deciding the best course of treatment for a given patient indicating
potentialforclinicalapplications.Inpart(c)youcanseeafewrepresentativepatchesfromhighand
lowriskregions.SuchpatchesprovideinsightintoHistoKernelspatternsintheentiredatasetwithout
theneedforapathologisttoevaluatealargenumberofWSIs.Foradeeperanalysisin(c)slide-level
heatmaps of WSIs associated with the representative patches. Blue regions indicate low risk areas
whereas red regions indicate high risk areas. Such patch-level predictions provide explainability to
themodelandhelpdoctorstrustthepredictionsmoreinaclinicalsetting.
10(a) (b)
0.0 1.0
(c) (d)
Fig. 5 (a)Resultsofmulti-modalsurvivalanalysisforbreastcancerwithtwomulti-modalkernels
beingutilisedaspre-computedkernelsforKSSVM.Thebasesingle-modalkernelsareamorphologi-
calHistokernel(KWSI)aswellasatranscriptomictopic-basedkernel(KTOPIC).Thesebasekernels
arecombinedviaadditionandmultiplicationinordertogeneratetwonewkernels,KTOPIC+KWSI
andKTOPIC×KWSI respectively.Fromthisplotitisclearthatmulti-modalkernelsachievehigher
concordance index indicating that they are able to better capture patters associated with patient
survival.Further,thesecombinedkernelsaremorestableastheyhaveasmallerstandarddeviation
acrossthethreefolds,indicatingbetterconsistency.Finally,onlythecombinedkernelsarestatistically
significant(shownbyanasterix)furthershowingtheirsuperiority.FocusingontheKTOPIC+KWSI
whichachievedthehighestC-indexwecanvisualiseittogetadeeperunderstanding.In(b)weseea
heatmapofthiskernelmatrixsuchthateachentryrepresentspatientsimilarity(bluetoredininten-
sity). Unsupervised hierarchical clustering of this kernel matrix reveals clear clusters corresponding
tobreastcancersubtypes(seelegend).Thissuggeststhekernelisabletocaptureexpressiveinforma-
tionaboutbreastcancer,despiteitsgenerationbeingcompletelyunsupervised.Finally,part(c)and
(d) further corroborates the benefit of a multi-modal approach as the Kaplan–Meier curves of both
multi-modal kernels show a good separation between high and low risk patients, further indicating
thatthesekernelswereabletolearnmeaningfulpatternsassociatedwithsurvival.
2.7 Time Complexity
For kernel computation we computed similarity between 12,186 WSIs, resulting in
74,243,205 WSI pairs. Calculating a single pairwise computation varies depending on
number of patches but on average took 4 miliseconds. Thus, for all pairs the distance
matrix computation requires 3.4 days on single GPU. This can be accelerated with
parallelisation and by preloading WSI feature vectors into the GPUs.
11After kernel computation the same precomputed kernel can be utilised in numer-
ous kernel-based algorithms for downstream tasks. By utilising a precomputed kernel
trainingisextremelyfastincontrasttotraditionaldeeplearningapproaches.Fordrug
sensitivity prediction training all 2135 models (427 drugs with 5-fold cross validation)
including hyper-parameter optimisation took 15 minutes on a machine with 32GB of
RAM and an Intel Core i5-13500 processor. On the same machine, point mutation
prediction computation took 6 minutes for all 304 models (76 genes with 4-fold cross
validation)includinghyper-parameteroptimisation.WSIretrievaltook10minutesfor
retrievingtop5imagesforall9,362WSIsconsidered.Finally,survivalanalysisforthe
30 models (6 sites with 5-fold cross validation) took 10 minutes. These times are a
significant improvement over existing approaches.
3 Discussion
We presented a novel MMD-based kernel approach that quantifies similarity between
WSIs. By computing MMD between WSIs represented as sets of patch-level features
we generate a single kernel for entire dataset where the similarity between any two
givenWSIsisexpressedbyasinglenumber.Thiskernelisonlycomputedonceforthe
entire dataset, after which it can be used for a variety of downstream tasks. Avoiding
long retraining times per task makes HistoKernel very fast and flexible. Nevertheless,
HistoKernelcapturesmeaningfulinformationasitiscomparabletoSOTAapproaches
for numerous fundamental tasks. To strengthen this claim, our perturbation-based
patch-level explainer found logical patterns in HistoKernel’s predictions, highlighting
the potential for clinical applications.
Firstly,wevisualisedHistoKernel.Fig1part(a)showsthatnumerouscancerslike
brain form clear clusters, supporting the idea that HistoKernel is finding patterns in
data.Thisclusteringisnotperfectpotentiallyduetotumourheterogeneity.Fig1part
(b) further support idea of cancers clustering. Interestingly, both clustering methods
coincide with the cancer types that are most distinguishable. It may be beneficial
to study underlying reasons for this. It seems HistoKernel is capturing meaningful
patterns in the data. It is unlikely HistoKernel is picking up stain variations or pos-
sible artefacts as these have been accounted for during feature extraction and tissue
segmentation. However, other confounding variables may exist.
WeinvestigatedWSIretrievalwhereHistoKernelsignificantlyoutperformedSOTA
for majority of sites1, 12% higher macro-average. A strong retrieval method is useful
for diagnosis of new patients, based on similarity with patients with existing diagno-
sis. Further, retrieval can be used to discover new patterns, for example identifying
genetic patterns in patients who have high image-based similarity. Overall, HistoKer-
nel has outperformed SOTA for retrieval without any processing of the kernel. This
strengthens the argument that HistoKernel has found meaningful patterns.
Next,welookedattheregressiontaskofpredictingdrugsensitivities.HistoKernel
significantly outperformed SOTA, achieving higher SCC for 94% of compounds. For
Vincristine and Paclitaxel HistoKernel achieved highest SCC. Knowledge of patient
1TheRetCCLresultsinthispaperaredifferentfromthoseoriginallyreportedduetoadifferentsubset
ofTCGAandtissuemaskalgorithmbeingused[11]
12sensitivity to these compounds can reduce serious side effects such as Vincristine
neurotoxicity, improving treatment efficacy and patient prognosis [17, 18]. Overall,
HistoKernel has significantly outperformed comparative method for regression task
without recomputing the kernel.
Using the same kernel we explore classification (point mutation prediction). His-
toKernel was comparable to SOTA, outperforming it for 56% of genes. Particularly,
HistoKernel achieved higher AUC-ROC than comparative method for CDH1 and
PTEN in BRCA and UCEC respectively, for which targeted therapies exist [23, 24].
This may improve patient care by identifying effective therapies for patients quickly
and cheaply (in contrast to genetic tests). We also compare patch-level heatmaps of
both HistoKernel and SOTA for TP53 prediction. These highlight similar areas sug-
gesting HistoKernel learned similar patterns to a previously well-established method,
giving it credibility. However, 42 genes were still unpredictable for both methods.
This may be because these genes may not be associated with significant morphologi-
cal patterns. Thus, HistoKernel is comparable to SOTA and has managed to identify
meaningful information for a clinically relevant classification task.
Next, we consider a ranking problem, survival analysis. HistoKernel has outper-
formed comparative method for all cancer types considered. However, results are
statisticallysignificantonlyforKIRCandUCEC.Thismaybeduetolimitednumber
ofsamplespercancertype.Kaplan-Meierplotscurvesofhighestperformingmodelfor
KIRCshowthatHistoKernelcouldseparatepatientsintotwostatisticallysignificantly
different groups. Low-risk patients have significantly better survival probability over
timecomparedtohigh-riskgroup.Agoodstratificationisusefulfordoctorstodecide
the best treatment course, helping improve quality of care. Pathologist analysis of
HistoKernel’s representative patches showed it successfully identified low risk regions
as benign tissue, mainly renal parenchyma (some showing fat, likely perinephric). For
high risk patches most contained clear cell renal cell carcinoma, containing chronic
inflammatory cells mainly lymphocytes. Further slide-level analysis of 5 WSIs asso-
ciated with 5 representative patches supported the idea that low-risk regions were
mostly benign tissue. The pathologist identified various patterns in HistoKernel high-
risk regions of these WSIs. This included: tumour interface to stroma, tumour in the
vicinity of large caliber vessels, pressure effect off tumours (pushed aside parenchyma
and significant fibrosis and chronic inflammation) and areas of higher grade tumour
(more eosinophilic and more prominent nuclei). This shows HistoKernel has success-
fully identified clinical information that current literature has shown to be associated
withprognosiswithoutdirectannotationsorspecificlabels(otherthanbasicpatient’s
survival information) [28, 29]. This provides credibility to HistoKernel thus opening
avenuesforclinicalapplications.However,certainpatternsneedfurtherinvestigation.
For example, HistoKernel has identified Granulomas outside of the tumour itself (in
the interring tissue, possible in the vicinity of sinus fat) as an important factor for
worseprognosis.However,currentliteratureisinconclusiveofGranulomasimportance
duetoitsrarityinKIRC.Overall,HistoKerneloutperformedcomparativemethodfor
numerous cancers in a fundamentally different problem and showed clinically relevant
patterns whilst utilising the same kernel.
13Finally,wedemonstratepotentialformulti-modalityintegrationwithmulti-kernel
learning (MKL) via multi-modal survival analysis results. These show a multi-modal
approach significantly outperformed single-modal variants. This substantial increase
inperformanceandreducedstandarddeviationshowedclearadvantageofMKL.Fur-
thermore, integration of two or more kernels is very easy, utilising basic arithmetic to
combine kernels. This is supported by Kaplan-Meier plots of the multi-modal kernels
showing a good stratification between high and low risk patients. Finally, unsuper-
vised clustering of the strongest performing kernel showed clear clusters forming with
respect to breast cancer subtypes suggesting that multi-modal kernel contains mean-
ingfulinformation[31].Itispossiblethemulti-modalkernelisutilisingthisinformation
as current literature shows breast cancer subtype is associated with survival. Overall,
a multi-modal approach is very easy to integrate into existing pipelines.
4 Methods
4.1 Dataset
For all the experiments we used WSIs of Formalin-Fixed paraffin-Embedded (FFPE)
Hematoxylin and Eosin (H&E) stained tissue section from The Cancer Genome Atlas
(TCGA) [32]. After excluding WSIs having missing baseline resolution information in
total we end up with 12,186 WSIs belonging to 9,374 patients. We used data of 32
caner sub-types spanning across 25 anatomic sites.
Toobtainthetargetlabelsofpatientspointmutationstatuswedownloadedmuta-
tiondataofpatientsin6-cancertypes(endometrial,breast,lungadenocarcinoma,lung
squamous cell carcinoma and glioblastoma) from cBioportal [33]. Inline with previous
workwecuratedcancer-relatedgeneswithatleast25mutationsofknownsignificance
with a matching WSI [22]. However, unlike previous work we relabelled TCGA brain
samples to obtain a new glioblastoma sub-population based on modern classification
standards[34](2021fiftheditionWHO).Thiseditionincorporatedmolecularfeatures
intothediagnosticdecisiontreeforbraintumoursthuscausingamajorchangeinthe
classification of samples. These reclassified labels for the TCGA were obtained from
Zakharova et al. [35]. Due to this relabelling and after excluding WSIs with missing
baseline resolution from analysis we obtained 76 analysable genes in six cancer types.
For cancer drug sensitivity prediction to be consistent with comparative method,
we used data of 1,098 patients with breast invasive carcinoma from TCGA (TCGA-
BRCA).Forthesepatientsweacquiredtheirestimatedsensitivityto427experimental
and FDA-approved compounds from a previously published work that has used
genomic and drug response data of Cancer Cell Lines (CCL) data [36] to infer these
numbers. Based on these labels the comparative method restricted the analysis to
patients with gene expression-based imputed sensitivity scores for all compounds to
get a total of 551 patients for analysis. The labels were also normalised using z-score
normalisation to account for the different ranges of the drug scores.
For survival analysis, we restricted our analysis to kidney renal clear cell carci-
noma(n=504),uterinecorpusendometrialcarcinoma(n=504),astrocytoma(n=219),
glioblastoma (n=266), bladder urothelial carcinoma (n=372) and lung adenocarci-
noma (n=426). To obtain labels for astrocytoma and glioblastoma we relabelled the
14brainLowerGradeGliomaandGlioblastomaMultiformecohortsfromtheTCGA[34].
The Disease-Specific Survival (DSS) data for each patient was collected from the
TCGA Pan-Cancer Clinical Data Resource (TCGA-CDR) [37]. Patients with missing
DSS data or those with an event time less than or equal to zero were not used in the
study.
For WSI retrieval, in line with comparative method, we looked at the 10 cancer
source sites which have more than one sub-type associated with them (29 sub-types
in total). This resulted in 9,324 WSIs belonging to 7,606 patients.
For Multi-Kernel Learning we obtained gene expression states (topics) from a
previous method that utalised CoReX on normalised gene expression data [38]. We
restricted our analysis to breast adenocarcinoma as topics have only been computed
for this cohort, resulting in 956 patients. Corresponding survival data was obtained
from TCGA-CDR [37].
4.2 Pre-processing of WSIs
For each WSI we first identify its viable tissue regions by using a U-Net-based tissue
segmentationmodelfromtheTIAToolbox[11].Thisensuresanyartefactssuchaspen
markings or tissue folds as well as background regions are removed. This generates
a mask for each image with a score of one for tissue area and zero otherwise. Since
WSIsatfullresolutioncanbeverylarge(150,000×150,000pixels)andcannotfitinto
GPU memory, we apply the previously generated masks and then tile each WSI into
patchesofsize1024×1024ataspatialresolutionof0.50micrometers-per-pixel(MPP).
Patchescapturinglessthan40%ofinformativetissuearea(meanpixelintensityabove
200)arediscarded,andtherestofthepatchesareused,bothtumourandnon-tumour
patches. For each patch pi in a WSI J, we obtain its d = 2048-dimensional feature
J
representation xi ∈ Rd by passing it through a convolutional neural network (CNN)
J
encoder. Any feature extractor can be used to encode patch-level features however we
used the RetCCL model [13].
4.3 Maximum Mean Discrepancy Kernels
We are interested in defining a (dis)similarity metric between two arbitrary WSIs
X and X . To do this we will instead try to solve the analogous problem of defin-
I J
ing a distance metric which can then easily be converted to a similarity metric via a
transformation (See Equation 5). We first require that this distance metric is valid,
it should satisfy the non-negativity, identity, symmetry, and triangle inequality pro-
prieties [39]. On top of this, since we are working with WSIs we need the distance
metric to be independent of the orientation or shape of tissue, work with arbitrary
feature representations, and it should be able to compare WSIs with different num-
bers of patches. To capture these additional properties we model each WSI as a set
of patches since by definition sets are unordered and can have different sizes thus any
metrics defined will implicitly be forced to include these assumptions. More specifi-
cally,X ={x1,x2,...,xNI}whereX isaWSIsuchthatN isthenumberofpatches
I I I I I I
in the image and xm represents the mth patches feature embedding in image X .
I I
15By formulating the problem in terms of sets it is possible to make use of popular
distance metrics in the field of set theory. One such example is Maximum Mean Dis-
crepancy (MMD) which was originally proposed as a kernel two-sample test [40]. The
MMD between two WSIs X and X is defined as:
I J
MMD(X ,X )=∥E [φ(xi)]−E [φ(xj)]∥ (1)
I J xi I∼XI I xj J∼XJ J H
where H is the Reproducing kernel Hilbert space (RKHS) that allows us to perform
the change of basis on the patches and φ is the feature map φ;X (cid:55)→ H that maps
into a RKHS [40]. Here X is some space from which X and X originated. More
I J
intuitively,MMDcomparesdifferentstatisticalmomentsbetweenX andX depend-
I J
ing on the specification of φ(·). A moment is a quantitative measure that describes
specific characteristics of a probability distribution where the first, second, and third
moments are mean, standard deviation, and skewness respectively. Formally, the rth
moment µ of X is defined as µ = E[Xr] [41]. To visualise this consider φ(x) = x
r I r I
and X =H=Rd, where Rd is a d-dimensional real space. This will result in:
MMD(X ,X )=∥E [φ(xi)]−E [φ(xj)]∥
I J xi I∼XI I xj J∼XJ J H
=∥E [xi]−E [xj]∥ (2)
xi I∼XI I xj J∼XJ J Rd
=∥µ −µ ∥
XI XJ Rd
which shows that for this specific transformation, MMD captures the difference in
means between the two images. Similarly, we can define φ(x)=x2 which allows us to
capture the difference between both the mean (first moment) as well as the standard
deviation (second moment) of the WSIs.
Based on this principle by setting φ(x) = xk we can compare up to an arbitrary
kth moment.However,suchanapproachislimitedbecauseitassumestwoimageswill
have a distance of 0 if they share the first k moments. However, this is not correct as
the images may only start differing at the k+1th moment. Thus, ideally, we would
like to compare an infinite number of moments.
To achieve this we can make use of the kernel trick [42]. This is based on the
Moore–Aronszajn theorem and states that a kernel k(·) that is semi-definite positive
has an implicit feature representation [40]. This is defined as:
k(xi,xj)=⟨xi,xj⟩=φ(xi)Tφ(xj). (3)
I J I J I J
Since we have defined φ(·) to map to some RKHS it is possible to apply the
kernel trick for MMD [40]. To do this we first need to rearrange equation 1 to be only
expressed in terms of dot products and then substitute in the kernel from Equation
3. This results in:
DMMD =MMD2(X ,X )=E [k(xi,xi′ )]+E [k(xj,xj′ )]
I,J I J XI I I XJ J J (4)
−2E [k(xi,xj)].
XI,Xj I J
16There is a degree of choice with the exact definition of the kernel (for example
EnergyorLaplacian[43])however,inthiscase,weusethepatch-levelGaussiankernel
defined as k(xi I,xj J)=e−∥xi I 4σ− 2xj J∥2 where σ is the standard deviation (also called blur
parameter) of the kernel [43]. This specifies how large the region of influence of a
particular point is, the larger the σ the bigger the region. This kernel is semi-definite
positive but what’s more interesting is that it can be shown that the Gaussian kernel
allows us to compare an infinite number of moments and thus MMD will be zero if
and only if the distributions are identical [40].
With this, we have defined a pairwise distance metric between any two arbitrary
WSIs with the same patch feature embedding. Using this we can generate an N ×
N matrix where N is the number of WSIs in the database, DMMD. Specifically,
DMMD = MMD2(X ,X ) such that I,J = 1...N. This allows us to summarise
I,J I J
an entire dataset of WSIs in a single matrix that can fit into computer memory.
To get a corresponding symmetric and positive semi-definite Mercer kernel matrix,
Kγ ∈RN×N, from this distance matrix we can apply the transformation:
Kγ =e−γDMMD (5)
where Kγ ∈[0,1] is the similarity between X and X and γ ∈R determines the
I,J I J ≥0
rate at which similarity decreases with increasing distance. Thus for large values of γ
a small increase in distance will correspond with a big decrease in similarity.
4.4 Computation of Maximum Mean Discrepancy Kernels
Inlinewithourpreviouswork,weusedtheGPU-basedGeomLosslibrarytoefficiently
compute MMD between WSIs [43]. In this paper, we use a Gaussian kernel thus to
reduce computation the standard deviation for the kernel is set to σ = 10. By paral-
lelising the matrix computation the MMD-dissimilarity matrix for the entire TCGA
(12,186×12,186 dimensional matrix) took around 2 days to compute with paralleli-
sation. It is important to note this computation was only done once and then the
relevant subsections of this kernel were utilised for each task mentioned in Section 2.
4.5 Explainability of Maximum Mean Discrepancy Kernels
Since MMD generates a slide-level kernel any models trained with the precomputed
kernel are intrinsically unable to generate patch-level predictions since patch-level
informationhasalreadybeencondensedduringthecomputationofmoments.Thus,it
was previously impossible to see which patches were most important for HistoKernel.
Explainability is vital in CPath to ensure pathologists can make informed decisions
about any models they use as well as to ensure the safety, approval, and acceptance
of such models in a clinical setting [44]. To overcome this limitation, we developed
a model-agnostic patch sensitivity metric that tells us how sensitive our predictor
is with respect to a certain patch. This method takes inspiration from the field of
perturbation-based instance explainability which perturb inputs of a given sample to
observetheeffectsoftheseperturbationsonthemodel’soutput[45,46].Traditionally,
perturbations are applied to the features of a particular instance and any change in
17the outputs is then attributed to the perturbed feature [47]. Perturbations depend
on the type of data but can range from simply increasing or decreasing a numerical
feature such as age or adding blur to a region of an image. The changes in the output
can then be used to estimate feature importance for a particular sample. In the case
of MMD we are not interested in feature importance but rather patch importance.
Thus we perturb a given WSI by removing patches to see the impact on the models’
output.Specifically,considersomepre-trainedpredictor,f :M (R)(cid:55)→R,thattakes
n×d
a WSI represented as a set of n d-dimensional patches and generates a real number
prediction. Then if we have an arbitrary WSI, X with N patches, if we passed this
I I
into our predictor we would get f(X )=s where s is the baseline score generated by
I
the predictor after considering all patches. If we want to see the effect of jth patch,
pj, such that pj ∈ 1...N we can remove pj from X to see how the score changes.
I I I I I
Formally, we can calculate:
¬pj
δ =f(X I)−f(X ) (6)
pj I I
I
where X¬pj I is WSI X without patch pj. The magnitude of δ will tell us how
I I I pj
I
impactful the loss of patch pj is to the original prediction which acts as a measure of
I
patch-level importance. We can also use the sign of δ to generate a patch-level pre-
pj
I
diction. For example, consider the case where we are training a TP53 point mutation
classifier where WSIs whose predicted value above some threshold t are classified as
mutated and those below as wild type. Now consider we have a test WSI, X , which
I
is TP53 mutated, equivalently we can say that if X is correctly classified it should
I
satisfyf(X )=s>t.Ifδ <0thatmeansthemodelislesscertainthatX isTP53
I pj I
I
mutated after losing pj as f(X¬pj I) was smaller than f(X ). In other words, patch pj
I I I I
looked like it was TP53 mutated as losing it made the model reduce its confidence
that this is a TP53 mutated image. Similarly, if δ > 0 we can argue that patch pj
pj I
I
resembles TP53 wild type.
Thesescorescanthenbenormalised,inthispaperweusemin-maxnormalisation,
for easy visualisation of the WSI patch-level heatmap.
4.6 Kernel Visualisation
To perform kernel visualisation we first carried out Uniform Manifold Approximation
andProjectionforDimensionReduction(UMAP).Thisworksbyconstructingahigh-
dimensional graph representation of the data and then optimising a low-dimensional
graph to be as structurally similar as possible [48]. Since the current implementation
of UMAP accepts a precomputed square distance matrix we can simply pass in the
HistoKernel matrix as input. The two main hyper-parameters of the model are the
minimum distance between embedded points, d = 0.0, and the size of the local
min
neighbourhood, s = 100 (see the documentation for more details [48]). Secondly,
local
we generated a heatmap of the distance matrix. This is done by first converting the
distancematrixtoasimilaritykernel,KMMD,withγsettothemedianoftheflattened
distance matrix. This standardises all the values between zero and one. Then to get
18back to a distance matrix, D′ , we calculate D′ =1−KMMD. Finally, we cluster this
new matrix using hierarchical clustering using Ward linkage to see which WSIs are
clustered together [48].
4.7 Drug Sensitivity Prediction
In order to predict drug sensitivity we made use of support Vector Regression (SVR)
with our precomputed kernel. SVRs work similarly to traditional SVMs however the
two major differences are that they predict scalar values instead of a binary label and
use epsilon-insensitive loss for the loss function. This loss function introduces a new
hyper-parameter that is not present in traditional SVMs, ϵ, which sets errors that are
within ϵ distance of the true value to zero. For this experiment, we trained an SVR
for each chemical compound separately resulting in 427 models.
In line with the comparison study, for evaluation we made use of 5-fold cross-
validation where we reserve 10% of the training data as a validation set for
hyper-parameter optimisation. The metric used for evaluation was Spearman’s rank
correlation coefficient (SCC) between the ground truth and predicted values. The p-
value associated with each SCC was also computed. A Wilcoxon paired signed rank
testwasalsocalculatedbetweenHistoKernelandthecomparativemethodresults[49].
This test is used to establish if two groups of samples are statistically significantly
different from one another. A one-sided test was carried out to see if the distribution
d=R −R , where R and R are the results of HistoKernel and compara-
MMD B MMD B
tivemethodrespectively,isstochasticallygreaterthanadistributionsymmetricabout
zero. This test was chosen as the Shapiro-Wilk test for normality revealed that both
the comparative method and HistoKernel results do not follow a normal distribution
(p≪0.01) [50].
4.8 Whole Slide Image Retrieval
InthistaskforaqueryWSI,X ,giventhatweknowthesiteoforiginofX weaimto
Q Q
retrieve the top k most ”similar” WSIs. In the comparative method paper, similarity
is defined as images from the same cancer sub-type. For example, if X originates
Q
fromthebrainandisofsub-typebrainlowergradeglioma(LGG)adatabaseofWSIs
originating from the brain is searched and the algorithm is considered successful if it
returns images of the same sub-type (in this case LGG). To remain fair we will utilise
the same definition.
ToperformWholeSlideImageRetrievalwedirectlyquerytheprecomputedkernel.
Thus to retrieve the top-k most similar WSIs for an arbitrary query image X using
Q
MMD kernels we first generate a similarity kernel of the entire dataset KMMD =
e−γDMMD.Hereγ issettothemedianoftheflatteneddistancematrix.Thenweselect
theqth rowofthematrix,KMMD.SinceK capturesthesimilaritybetweenX and
q∗ q∗ Q
every other image in the dataset we just need to sort the row in descending order of
similarity to find out which images are most similar to the query. We will also need
toexcludetheentryfromthethissortedrowwhichcorrespondstosimilaritybetween
X withitselfsincethesimilaritykernelincludestheentiredatasetandanimagewill
Q
19have a maximum similarity of one with itself, by definition of MMD with a Gaussian
kernel [40].
Forperformanceevaluation,inlinewiththecomparativemethod,wewillbeusing
a majority vote at the top k search results (mMv@k) which is given by the formula:
N
1 (cid:88)
mMv@k = ζ(y ,yˆ [:k]) (7)
N I I
I=1
where N is the number of test WSIs, y is the ground truth (the cancer sub-type),
I
yˆ [:k] are the returned top k most similar images and ζ(·) is a discriminator function
I
that returns one if the majority label of the predictions is equal to the ground truth
andzerootherwise.Hereweusek =5soforagivenqueryWSIweretrievethetopfive
most similar images to the query and if the majority label of these five most similar
images matches that of the ground truth of the query the prediction is considered
correct. To prevent information leakage we remove all slides from the same patient as
X before retrieval.
Q
4.9 Point Mutation Prediction
To predict point mutations we made use of kernelized binary SVMs. Inline with the
comparative method we trained a separate model (SVM) for each of the 76 genes.
For performance evaluation, we used 4-fold cross-validation with 40% of the train-
ing data used as a validation set for hyperparameter tuning (both kernel γ, see
Section 4.3, and SVM regularisation parameter) [51]. The model’s performance was
measured by using Area Under the Receiver Operating Characteristic curve (AUC-
ROC). In Figure 3 part (a) predcitons are binned based on AUC-ROC into weak
(AUC-ROC < 0.6), moderate (AUC-ROC 0.6 to 0.7) and strong (AUC-ROC 0.7 to
1.0)predictors.InFig3part(b)wefilteredoutgeneswherebothcomparativemethod
andHistoKernelachievedanAUC-ROClessthan0.6,leaving34genes.Thisisbecause
comparing genes for which both predictors are weak is meaningless.
4.10 Survival Analysis
In order to perform survival analysis we utilised kernelized survival SVMs (KSSVM)
with our precomputed kernel. These predict a risk score f(X ) for a given patient,I,
I
after training a model over a training dataset in the form of {(X ,T ,δ )|I =
I I I
1...N }. Each patient is modelled as a tuple comprised of a patient’s WSI X ,
train I
theirdisease-specificsurvivaltimeT andabinaryeventindicatorvariableδ ∈{0,1}
I I
which shows if the patient has passed away from the recorded cancer or not within
a censoring time T = 10 years. The implementation of KSSVM accepts a pre-
censor
computed kernel and has a single hyperparameter α that controls the loss penalty
term in its objective function [26]. We chose, α = 0.0625 and γ, for the kernel, is set
to the median of the flattened distance matrix. This is done to reduce the number of
tunable hyper-parameters as the effect of γ is also modulated by the blur parameter
of the patch level kernel [52].
20For performance evaluation, in line with the comparative method, we used 5-fold
cross-validation stratified with respect to the survival event. In each run we generate
the risk scores on the test set which are then used to compute the Concordance-
index (C-index) [53]. This metric ranges from 0.0 to 1.0 and measures the degree of
concordance between the relative prediction scores of test patients and their actual
survival times. A score of 0.0 indicates an inverted ranking of survival scores whereas
1.0 shows perfect concordance between prediction scores and actual survival time.
A score of 0.5 implies no concordance between predicted scores and actual survival
times) [53]. For the statistically significant models we also show the Kaplan-Meier
survival curves of the high-risk and low-risk patient groups using the medium of the
trainingsetscores as thethreshold. The p-value ofthe log-rank testacross the 5folds
is calculated as 2×median({p |r =1...5}) where p is the p-value at fold r.
r r
After extracting patch-level predictions using our perturbation-based method (see
Methods 4.5) for KIRC WSIs we identified representative patches using K-medoid
clustering.Specifically,weformahighrisksetofpatchesbytakingthehighestscoring
patchperpatient(randomlypickingasinglepatchincaseofdraws)thenperformingk-
medoidclusteringwithK =25togetthe25mostrepresentativehighscoringpatches.
A similar process was applied to find the 25 representative low-scoring patches (by
instead taking lowest scoring patches from patients).
4.11 Multi-Modal Kernels
Toperformmultimodallearningwefirsthavetodefineourkernels.Thefirstkernelis
our precomputed HistoKernel that captures morphological information, KWSI. The
secondisatranscriptomickernelthatiscomputedfromgeneexpressiontopicsdefined
by Dawood et al [38]. In this work, each BRCA patient has been characterised by 200
binary variables or topics. The status of each topic variable represents specific gene
expression patterns of co-dependent genes. Thus for each patient, P , we can express
I
their genetic information as a 200 binary feature vector, tPI:
 tPI
1
.
tPI =

.
.


(8)
tPI
200
where tPI ∈{0,1} is the binary status of topic j of patient I. To define a topic kernel
j
wecancomputetheradialbasisfunctionbetweentopicrepresentationsoftwopatients
as:
K IT ,JOPIC =e−∥tPI 2− σt 2PJ∥2 (9)
where σ is the bandwidth of the RBF kernel function. In this work, for simplicity, we
set σ =10.
We can then utilise the rich theory of Multi Kernel Learning (MKL) in order to
combine our set of kernels K = {KTOPIC,KWSI}. The simplest type of method to
combinekernelsisUnweightedMultipleKernelMethods(UMKL)whereweperforma
specificarithmeticoperationtocombinekernelswithoutassigningkernelweights[30].
ThefirstoperationweuseisadditionwherewedefineanewkernelKWSI+KTOPIC.
21Addition of kernels is equivalent to concatenating the feature space representation of
the base kernels [54]. Another operation is to multiply the kernels such that KWSI ×
KTOPIC. This can be thought of as computing the tensor product of of the base
kernels feature spaces [54].
Once these multi-modal kernels are computed they can be used as precomputed
kernels for kernelized survival SVMs as shown in Methods 4.10. To find the optimum
hyperparameters we perform Bayesian optimisation over the validation set. Specifi-
cally, we optimise over α ∈ [2.0−12,0.125] which controls the degree of regularisation
in the KSSVM function. We then minimise the negative c-index on the validation
set added to the chosen α. This tries to find hyperparameters that balance a high
performance whilst also keeping high regularisation to prevent overfitting.
For performance evaluation, we used 3-fold cross-validation stratified with respect
to the survival event while utilizing 20% of the training set for validation. In each run
wegeneratetheriskscoresonthetestsetwhicharethenusedtocomputetheC-index
and p-value (as shown in Methods 4.10).
5 Conclusion
This work explores Maximum Mean Discrepancy-based kernels for various CPath
tasks. We have demonstrated the power of HistoKernel for WSI retrieval, cancer drug
sensitivityprediction,pointmutationclassification,survivalanalysisandmulti-modal
learning.Forthese,HistoKernelhasoutperformedvariouscomparativemethodsshow-
ing its wide versatility and ability to capture meaningful information from WSIs and
summarise the data in a very compact manner. Our second major contribution was
developing a patch sensitivity metric that provides explainability of slide-level predic-
tions removing a major obstacle that was blocking the use of HistoKernel in a clinical
setting. We hope this work paves the way for further exploration of HistoKernel in
CPath. Future work will involve testing HistoKernel on datasets other than TCGA,
testingforconfoundingfactorsandseeinghowthemodelperformsinaclinicalsetting.
Supplementaryinformation. AccompanyingsupplementaryisprovidedasaPDF
document.
Declarations
5.1 Funding
Fayyaz Minhas acknowledges funding from EPSRC EP/W02909X/1. Fayyaz Min-
has and Muhammad Dawood report research funding from GlaxoSmithKline outside
the submitted work. Piotr Keller acknowledges funding from EPSRC Doctoral Train-
ing Partnership (DTP) at the University of Warwick. Brinder Singh Chohan has no
associated funding.
5.2 Conflict of interest/Competing interests
Not applicable.
225.3 Ethics approval and consent to participate
Not applicable.
5.4 Consent for publication
Consent for publication is given by all authors.
5.5 Data availability
All WSIs and survival data used in this study are part of the TCGA and are publicly
available at https://www.cancer.gov/ccg/research/genome-sequencing/tcga. Point
mutation data from all genes is publicly available at https://www.cbioportal.org/31.
5.6 Materials availability
Not applicable.
5.7 Code availability
All code is available in GitHub at: https://github.com/pkeller00/HistoKernel.
5.8 Author contribution
The concept for the study and experimented was developed by P.K. and F.M.
The experiments and statistical were implemented by P.K. Assistance with run-
ning comparative models and providing cleaned data was done my M.D. The study
was supervised by F.M. B.R analysed patches and WSIs from KIRC, identifying
morphological patterns in high and low risk regions.
References
[1] Zhang,Z.,Chen,P.,McGough,M.,Xing,F.,Wang,C.,Bui,M.,Xie,Y.,Sapkota,
M., Cui, L., Dhillon, J., et al.: Pathologist-level interpretable whole-slide cancer
diagnosis with deep learning. Nature Machine Intelligence 1(5), 236–245 (2019)
[2] Tolkach,Y.,Dohmg¨orgen,T.,Toma,M.,Kristiansen,G.:High-accuracyprostate
cancer pathology using deep learning. Nature Machine Intelligence 2(7), 411–418
(2020)
[3] Xu, H., Usuyama, N., Bagga, J., Zhang, S., Rao, R., Naumann, T., Wong, C.,
Gero, Z., Gonz´alez, J., Gu, Y., et al.: A whole-slide foundation model for digital
pathology from real-world data. Nature, 1–8 (2024)
[4] Bilal, M., Jewsbury, R., Wang, R., AlGhamdi, H.M., Asif, A., Eastwood, M.,
Rajpoot,N.:Anaggregationofaggregationmethodsincomputationalpathology.
Medical Image Analysis, 102885 (2023)
23[5] Bilal, M., Raza, S.E.A., Azam, A., Graham, S., Ilyas, M., Cree, I.A., Snead,
D., Minhas, F., Rajpoot, N.M.: Development and validation of a weakly super-
vised deep learning framework to predict the status of molecular pathways and
key mutations in colorectal cancer from routine histology images: a retrospective
study. The Lancet Digital Health 3(12), 763–772 (2021)
[6] Eastwood, M., Marc, S.T., Gao, X., Sailem, H., Offman, J., Karteris, E., Fernan-
dez,A.M.,Jonigk,D.,Cookson,W.,Moffatt,M.,et al.:Malignantmesothelioma
subtyping via sampling driven multiple instance prediction on tissue image and
cell morphology data. Artificial Intelligence in Medicine 143, 102628 (2023)
[7] Liang, J., Zhang, W., Yang, J., Wu, M., Dai, Q., Yin, H., Xiao, Y., Kong, L.:
Deep learning supported discovery of biomarkers for clinical prognosis of liver
cancer. Nature Machine Intelligence 5(4), 408–420 (2023)
[8] Keller, P., Dawood, M., Minhas, F.U.A.A.: Maximum mean discrepancy kernels
forpredictiveandprognosticmodelingofwholeslideimages.In:2023IEEE20th
International Symposium on Biomedical Imaging (ISBI), pp. 1–5 (2023). IEEE
[9] Binder, A., Bockmayr, M., H¨agele, M., Wienert, S., Heim, D., Hellweg, K., Ishii,
M., Stenzinger, A., Hocke, A., Denkert, C., et al.: Morphological and molecular
breast cancer profiling through explainable machine learning. Nature Machine
Intelligence 3(4), 355–366 (2021)
[10] Yoshida, H., Shimazu, T., Kiyuna, T., Marugame, A., Yamashita, Y., Cosatto,
E., Taniguchi, H., Sekine, S., Ochiai, A.: Automated histological classification of
whole-slideimagesofgastricbiopsyspecimens.Gastriccancer21,249–257(2018)
[11] Pocock,J.,Graham,S.,Vu,Q.D.,Jahanifar,M.,Deshpande,S.,Hadjigeorghiou,
G., Shephard, A., Bashir, R.M.S., Bilal, M., Lu, W., et al.: Tiatoolbox as an
end-to-endlibraryforadvancedtissueimageanalytics.Communicationsmedicine
2(1), 120 (2022)
[12] Bostwick, D.G.: Grading prostate cancer. American journal of clinical pathology
102(4 Suppl 1), 38–56 (1994)
[13] Wang,X.,Du,Y.,Yang,S.,Zhang,J.,Wang,M.,Zhang,J.,Yang,W.,Huang,J.,
Han, X.: RetCCL: Clustering-guided contrastive learning for whole-slide image
retrieval. Medical Image Analysis 83, 102645 (2023) https://doi.org/10.1016/j.
media.2022.102645 . Accessed 2024-01-15
[14] Gruener, R.F., Ling, A., Chang, Y.-F., Morrison, G., Geeleher, P., Greene, G.L.,
Huang, R.S.: Facilitating drug discovery in breast cancer by virtually screening
patients using in vitro drug response modeling. Cancers 13(4), 885 (2021)
[15] Kidwai-Khan,F.,Rentsch,C.T.,Pulk,R.,Alcorn,C.,Brandt,C.A.,Justice,A.C.:
Pharmacogenomics driven decision support prototype with machine learning: A
24framework for improving patient care. Frontiers in big Data 5, 1059088 (2022)
[16] Dawood,M.,Vu,Q.D.,Young,L.S.,Branson,K.,Jones,L.,Rajpoot,N.,Minhas,
F.u.A.A.: Cancer drug sensitivity prediction from routine histology images. NPJ
Precision Oncology 8(1), 5 (2024)
[17] Pond´e, N.F., Zardavas, D., Piccart, M.: Progress in adjuvant systemic therapy
for breast cancer. Nature reviews Clinical oncology 16(1), 27–44 (2019)
[18] Wu, C.-Y., Li, G.-T., Chu, C.-C., Guo, H.-L., Fang, W.-R., Li, T., Wang, Y.-
R., Xu, J., Hu, Y.-H., Zhou, L., et al.: Proactive therapeutic drug monitoring
of vincristine in pediatric and adult cancer patients: current supporting evidence
and future efforts. Archives of Toxicology 97(2), 377–392 (2023)
[19] Hine, R.: A Dictionary of Biology, 8;8;eighth; edn. Oxford University Press,
Oxford (2019)
[20] Fontanini, G., De Laurentiis, M., Vignati, S., Chine, S., Lucchi, M., Silvestri, V.,
Mussi, A., De Placido, S., Tortora, G., Bianco, A.R., et al.: Evaluation of epider-
mal growth factor-related growth factors and receptors and of neoangiogenesis
in completely resected stage i-iiia non-small-cell lung cancer: amphiregulin and
microvessel count are independent prognostic indicators of survival. Clinical can-
cer research: an official journal of the American Association for Cancer Research
4(1), 241–249 (1998)
[21] Rusch, M., Nakitandwe, J., Shurtleff, S., Newman, S., Zhang, Z., Edmonson,
M.N.,Parker,M.,Jiao,Y.,Ma,X.,Liu,Y.,etal.:Clinicalcancergenomicprofiling
by three-platform sequencing of whole genome, whole exome and transcriptome.
Nature communications 9(1), 3962 (2018)
[22] Saldanha, O.L., Loeffler, C.M., Niehues, J.M., Treeck, M., Seraphin, T.P.,
Hewitt, K.J., Cifci, D., Veldhuizen, G.P., Ramesh, S., Pearson, A.T., et al.: Self-
supervisedattention-baseddeeplearningforpan-cancermutationpredictionfrom
histopathology. NPJ Precision Oncology 7(1), 35 (2023)
[23] M Dillon, L., W Miller, T.: Therapeutic targeting of cancers with loss of pten
function. Current drug targets 15(1), 65–79 (2014)
[24] Citrin, D.L., Tan, B.A., Patel, N.B., Doctor, V., Ali, S.M., Parikh, A.R., Mark-
man, M., Ross, J.S., Syriac, A.K., Brzezinski, S.J.: Treatment of patients with
lobular breast cancer harboring human epidermal growth factor receptor 2
mutation with her2-directed therapy. JCO Precision Oncology 2, 1–7 (2018)
[25] Bø, H.K., Solheim, O., Jakola, A.S., Kvistad, K.-A., Reinertsen, I., Berntsen,
E.M.:Intra-ratervariabilityinlow-gradegliomasegmentation.JournalofNeuro-
oncology 131, 393–402 (2017)
25[26] al., S.P.: Fast training of support vector machines for survival analysis. In:
Joint European Conference on Machine Learning and Knowledge Discovery in
Databases, pp. 243–259 (2015). Springer
[27] Mackenzie, C.C., Dawood, M., Graham, S., Eastwood, M., et al.: Neural graph
modelling of whole slide images for survival ranking. In: Learning on Graphs
Conference, pp. 48–1 (2022). PMLR
[28] Nilsson, H., Lindgren, D., Axelson, H., Brueffer, C., Saal, L.H., Lundgren, J.,
Johansson,M.E.:Featuresofincreasedmalignancyineosinophilicclearcellrenal
cell carcinoma. The Journal of Pathology 252(4), 384–397 (2020)
[29] Mattila, K.E., Vainio, P., Jaakkola, P.M.: Prognostic factors for localized clear
cellrenalcellcarcinomaandtheirapplicationinadjuvanttherapy.Cancers14(1),
239 (2022)
[30] G¨onen, M., Alpaydın, E.: Multiple kernel learning algorithms. The Journal of
Machine Learning Research 12, 2211–2268 (2011)
[31] Lachapelle,J.,Foulkes,W.:Triple-negativeandbasal-likebreastcancer:implica-
tions for oncologists. Multidisciplinary Digital Publishing Institute (2011)
[32] al.,K.A.H.:Cell-of-originpatternsdominatethemolecularclassificationof10,000
tumors from 33 types of cancer. Cell 173(2), 291–304 (2018)
[33] Cerami,E.,Gao,J.,Dogrusoz,U.,Gross,B.E.,Sumer,S.O.,Aksoy,B.A.,Jacob-
sen, A., Byrne, C.J., Heuer, M.L., Larsson, E., et al.: The cbio cancer genomics
portal: an open platform for exploring multidimensional cancer genomics data.
Cancer discovery 2(5), 401–404 (2012)
[34] Louis, D.N., Perry, A., Wesseling, P., Brat, D.J., Cree, I.A., Figarella-Branger,
D., Hawkins, C., Ng, H., Pfister, S.M., Reifenberger, G., et al.: The 2021 who
classificationoftumorsofthecentralnervoussystem:asummary.Neuro-oncology
23(8), 1231–1251 (2021)
[35] Zakharova, G., Efimov, V., Raevskiy, M., Rumiantsev, P., Gudkov, A.,
Belogurova-Ovchinnikova, O., Sorokin, M., Buzdin, A.: Reclassification of tcga
diffuse glioma profiles linked to transcriptomic, epigenetic, genomic and clinical
data,accordingtothe2021whocnstumorclassification.Internationaljournalof
molecular sciences 24(1), 157 (2022)
[36] Gruener, R.F., Ling, A., Chang, Y.-F., Morrison, G., Geeleher, P., Greene, G.L.,
Huang,R.S.:FacilitatingDrugDiscoveryinBreastCancerbyVirtuallyScreening
Patients Using In Vitro Drug Response Modeling. Cancers 13(4), 885 (2021)
https://doi.org/10.3390/cancers13040885 . Accessed 2024-01-15
[37] al.,J.L.:Anintegratedtcgapan-cancerclinicaldataresourcetodrivehigh-quality
26survival outcome analytics. Cell 173(2), 400–416 (2018)
[38] Dawood, M., Eastwood, M., Jahanifar, M., Young, L., Ben-Hur, A., Branson,
K., Jones, L., Rajpoot, N., Minhas, F.u.A.A.: Data-driven modelling of gene
expression states in breast cancer and their prediction from routine whole slide
images. bioRxiv, 2023–04 (2023)
[39] Gromov, M.: Metric Structures for Riemannian and Non-Riemannian Spaces,
(2007). https://doi.org/10.1007/978-0-8176-4583-0
[40] al., A.G.: A kernel two-sample test. The Journal of Machine Learning Research
13(1), 723–773 (2012)
[41] Papoulis, A., pp. 145–149. McGraw Hill (1984)
[42] Koutroumbas, K., Theodoridis, S.: Pattern Recognition. Academic Press, San
Diego, CA (2008)
[43] al.,J.F.:Interpolatingbetweenoptimaltransportandmmdusingsinkhorndiver-
gences. In: The 22nd International Conference on Artificial Intelligence and
Statistics, pp. 2681–2690 (2019)
[44] Plass,M.,Kargl,M.,Kiehl,T.-R.,Regitnig,P.,Geißler,C.,Evans,T.,Zerbe,N.,
Carvalho, R., Holzinger, A., Mu¨ller, H.: Explainability and causability in digital
pathology. The Journal of Pathology: Clinical Research (2023)
[45] Ribeiro, M.T., Singh, S., Guestrin, C.: ” why should i trust you?” explaining the
predictions of any classifier. In: Proceedings of the 22nd ACM SIGKDD Inter-
national Conference on Knowledge Discovery and Data Mining, pp. 1135–1144
(2016)
[46] Robnik-Sˇikonja, M., Kononenko, I.: Explaining classifications for individual
instances. IEEE Transactions on Knowledge and Data Engineering 20(5), 589–
600 (2008)
[47] Robnik-Sˇikonja, M., Bohanec, M.: Perturbation-based explanations of prediction
models. Human and Machine Learning: Visible, Explainable, Trustworthy and
Transparent, 159–175 (2018)
[48] Sainburg, T., McInnes, L., Gentner, T.Q.: Parametric umap embeddings for rep-
resentationandsemisupervisedlearning.NeuralComputation33(11),2881–2907
(2021)
[49] Conover, W.J.: Practical Nonparametric Statistics, 3rd edn. John Wiley, New
York;Chichester; (1999)
[50] Shapiro, S.S., Wilk, M.B.: An analysis of variance test for normality (complete
samples). Biometrika 52(3/4), 591 (1965) https://doi.org/10.2307/2333709
27[51] Saldanha, O.L., Loeffler, C.M.L., Niehues, J.M., Treeck, M., Seraphin, T.P.,
Hewitt, K.J., Cifci, D., Veldhuizen, G.P., Ramesh, S., Pearson, A.T., Kather,
J.N.: Self-supervised attention-based deep learning for pan-cancer mutation pre-
diction from histopathology. npj Precision Oncology 7(1), 1–5 (2023) https:
//doi.org/10.1038/s41698-023-00365-0.Number:1Publisher:NaturePublishing
Group. Accessed 2024-01-15
[52] Keller, P., Dawood, M., Minhas, F.U.A.A.: Maximum mean discrepancy kernels
for predictive and prognostic modeling of whole slide images. In: 2023 IEEE
20th International Symposium on Biomedical Imaging (ISBI), pp. 1–5 (2023).
https://doi.org/10.1109/ISBI53787.2023.10230578
[53] Longato,E.,Vettoretti,M.,DiCamillo,B.:Apracticalperspectiveontheconcor-
dance index for the evaluation and selection of prognostic time-to-event models.
JournalofBiomedicalInformatics108,103496(2020)https://doi.org/10.1016/j.
jbi.2020.103496 . Accessed 2024-01-15
[54] Viljanen, M., Airola, A., Pahikkala, T.: Generalized vec trick for fast learning of
pairwise kernel models. Machine Learning 111(2), 543–573 (2022)
28
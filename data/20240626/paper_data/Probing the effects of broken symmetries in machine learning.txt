Probing the effects of broken symmetries in machine learning
Marcel F. Langer,1 Sergey N. Pozdnyakov,1 and Michele Ceriotti1,
∗
1Laboratory of Computational Science and Modeling and National Centre for
Computational Design and Discovery of Novel Materials MARVEL, Institute of Materials,
E´cole Polytechnique F´ed´erale de Lausanne, 1015 Lausanne, Switzerland
(Dated: June 26, 2024)
Symmetryisoneofthemostcentralconceptsinphysics,anditisnosurprisethatithasalsobeen
widely adopted as an inductive bias for machine-learning models applied to the physical sciences.
Thisisespeciallytrueformodelstargetingthepropertiesofmatterattheatomicscale. Bothestab-
lishedandstate-of-the-artapproaches,withalmostnoexceptions,arebuilttobeexactlyequivariant
to translations, permutations, and rotations of the atoms. Incorporating symmetries – rotations in
particular – constrains the model design space and implies more complicated architectures that
are often also computationally demanding. There are indications that non-symmetric models can
easily learn symmetries from data, and that doing so can even be beneficial for the accuracy of the
model. We put a model that obeys rotational invariance only approximately to the test, in real-
istic scenarios involving simulations of gas-phase, liquid, and solid water. We focus specifically on
physical observables that are likely to be affected – directly or indirectly – by symmetry breaking,
finding negligible consequences when the model is used in an interpolative, bulk, regime. Even for
extrapolativegas-phasepredictions,themodelremainsverystable,eventhoughsymmetryartifacts
are noticeable. We also discuss strategies that can be used to systematically reduce the magnitude
of symmetry breaking when it occurs, and assess their impact on the convergence of observables.
Data-driven techniques are increasingly applied across els,bothforconstructingMLPs[19]andfortasksinvolv-
the physical sciences [1, 2], with the modeling of matter ingthe predictionofthe secondarystructureof polypep-
at the atomic scale being a field in which they have been tides [20]. However, good predictive performance on
adopted early [3–6] and with great success. Machine- static test datasets is not sufficient to evaluate the prac-
learning models that are meant to reproduce the rela- tical usefulness of a given model architecture [21]. Sym-
tionship between a structure and its properties inherit metries are associated with conservation laws that are
the constraints, and hence the symmetries, of the un- beneficial for the numerical stability of algorithms [22],
derlying physics. For instance, the potential energy, the and whose violation can occasionally lead to manifestly
target of so-called machine-learning interatomic poten- absurd simulation outcomes [23, 24]. This work inves-
tials(MLPs), isinvarianttoatomlabelpermutations, as tigates the impact of neglecting rotational invariance in
well as translations, rotations, and reflections. Ensuring MLPs, and to what extent an approximation of invari-
that MLPs respect the inherent symmetries of the prob- ance is sufficient in practice.
lem has long been considered essential [4, 5, 7, 8]. The
simplest approach to constructing invariant models is to We use the Point Edge Transformer (PET) architec-
use invariant features from the start, for instance inter- ture [19] that is exactly invariant to translations and
atomic distances or angles, that however leads to models atom index permutations but not to rigid rotations to
with reduced descriptive power [9]. Alternatively, mod- train a MLP for bulk water. We use the training set
els can rely on an equivariant architecture [10]: Internal fromRef.25thatcontains1593configurationscomputed
features are constructed to transform with the coordi- attherevPBE0[26,27]leveloftheory, includingD3dis-
nateframe,andcanthenbecombinedintoinvariantsfor persioncorrections[28]. Thedetailsofthemodelandthe
the final energy prediction. Most state-of-the-art MLPs, training protocols are discussed in the Supp. Mat., and
forinstanceNequip[11],Mace[12],orSo3krates[13], can also be found in the data record associated with this
arebasedonthistypeofarchitecture. However,ensuring publication. Forthepurposeofthisstudy,itisimportant
equivariance imposes severe constraints on model archi- to stress that – as in Ref. 19, and as standard practice
tectures [14, 15], and general equivariant operations can in fields using non-symmetric architectures – rotational
become computationally costly in practice. augmentation is performed during training: For each
Forthisreason,therehasbeengrowinginterestin‘un- epoch, a different random orientation is chosen for every
constrained’ models that relax the requirement of global structure. In addition, we implement an inference-time
invariance (or internal equivariance), and that are used approximate symmetrization scheme, i.e., averaging pre-
widely in computer science for tasks involving the clas- dictionsovermultiplerotations,basedonsystematically-
sification of point clouds [16–18]. Even in the field of convergent grids over Euler angles [29]. This provides a
atomic-scale modeling, recent work has shown that non- way to assess the impact of symmetry-breaking on the
invariant models can achieve competitive accuracy on model accuracy without changing its architecture. Tak-
benchmarkdatasetswhencomparedwithinvariantmod- ing the base model y(A), a rotationally averaged version
4202
nuJ
52
]hp-mehc.scisyhp[
1v74771.6042:viXra2
is defined as:
y¯(A)=
1 (cid:88)M
w y(Rˆ A), (1)
2 11 00 −− 43 b
k k
M 0
0 i 2 2i 3 3i k=1
Averaginggrid
whereRˆ k indicatetheuniformly-distributedrotationma- −2 a PET,noavg. PET,2iavg.
trices and w the associated quadrature weights, and
k
A the structure for which we are making a prediction. 0 5 10 15 20 25
t(ps)
We indicate the grid size with the notation N[i], where
N 2 is an integer that indicates the subdivision of PET
≥ 103
the Euler angles, and i indicates that the grid is dupli- ∆PET
cated to also include the corresponding improper rota-
tions Rˆ . Grids labeled by 2, 2i, 3, 3i contain 18, 36,
100
k
{− }
75,150rotationsrespectively. Byincreasingthegridsize,
10−3
themodelcanbemadeasclosetoexactlyequivariantas
c
desired,atcorrespondinglyincreasedcomputationalcost.
0 2500 5000 7500 10000 12500 15000 17500
NotethatRef.19alsoproposesanexact symmetrization
ω(cm−1)
scheme, which however would require modifications to
2π
the PET architecture to enable an efficient application
(see the Supp. Mat.).
As a first, and perhaps the most extreme, test, we run
π
constant-energy molecular dynamics (MD) simulations
for a water molecule in vacuum. Given that the model
istrainedexclusivelyonbulkstructures,thisamountsto
d e
a deep extrapolative regime, and allows us to test the 0
1 0 1 1 0 1
most direct consequence of the lack of rotational invari- − −
cosθ cosθ
ance – break-down of angular momentum conservation.
F/kBT
A first observation is that the potential is very stable
0.40 0.20 0.00 0.20 0.40
despite the extrapolative conditions, and can be run for − −
several nanoseconds with energy conservation consistent
FIG. 1. Simulations of a water molecule using a rotationally
withthetimestepof0.5fsandtheuseofsingle-precision
non-equivariant PET model. (a) Trajectories of the angular
arythmetics. The symmetry breaking is however ap- momentumcomponents(dashedlines)andmodulus(fullline)
parent in the precession of the angular momentum L during constant-energy molecular dynamics, for the model
(Fig. 1a) that is a consequence of the non-zero torque without symmetrization (red) and with rotational averaging
acting on the molecule despite the absence of an exter- over a 2i grid. (b) Mean value of the torque acting on the
nal potential (Fig. 1b). The torque τ is almost orthog- molecule over a constant-temperature simulation, for differ-
ent orientation grids (using the notation N[i]). (c) Power
onal to the angular momentum, so the angular velocity
spectrum computed from the autocorrelation function of the
is almost constant. The small fluctuations of the total
potential energy, and on the non-equivariant part of the po-
momentum are an indication of the coupling of the non- tential∆(computedasthedifferencebetweentherawmodel
equivarianttermswiththeinternaldegreesoffreedomof and a 2i average). (d-e) Orientational free energy for the
the molecule. Rotational averaging mitigates symmetry water molecule computed over a long constant-temperature
breaking, and systematically reduces the magnitude of simulation without (d) and with 2i rotational averaging (e).
τ – which does not eliminate precession, but slows it
| |
down dramatically, and effectively eliminates the fluctu-
ations of L. use the MTS implementation in i-PI [31], with an inner
| |
Another important observation is that the non- time step of 0.5fs for the base model and evaluating the
equivariantcomponentofthepotential(estimatedasthe rotationally averaged forces every 10 steps.
difference between the single and rotationally averaged Angular momentum precession for an isolated system
predictions of the model for each structure) shows fluc- is a telltale sign of SO(3) symmetry breaking, but pre-
tuationsthatarenotonlymuchsmallerthanthoseofthe cise classical dynamics is only relevant in few molecular
actual potential, but also slowly-varying (Fig. 1c). This applications, such as the study of gas-phase chemical re-
means it is possible to apply multiple time-step (MTS) actions [32, 33]. A much more common scenario involves
methods [30] and avoid evaluating the averaged model, simulationsthatsampleathermaldistributionandcom-
which is computationally more demanding, at every MD putestatisticalaveragesoverthetrajectory. Inthiscase,
step. In all of the constant-temperature simulations per- a clear signature of broken symmetry would be a pref-
formed in this work that use rotational averaging, we erential absolute orientation of the water molecules in
)sfVe(
|L
|,αL
)2Ve(
VVc
φ
)Ve(
τ
i|
|h3
2π has a more significant impact on the collective behav-
ior of matter in the condensed phase. We run a long
classical MD trajectory (1 ns) of a relatively large box
π (512 molecules) at room temperature, in the NVT en-
semble at T = 300 K, using a stochastic velocity rescal-
ing thermostat [35] that has a negligible effect on dy-
a b
namical properties [36]. Given that periodic boundary
0
1 0 1 1 0 1 conditions make it impossible to define and monitor a
− −
cosθ cosθ conserved angular momentum, we look for a signature
F/kBT of non-equivariant behavior in the absolute orientation
-0.40 -0.20 0.00 0.20 0.40 of the water molecules. The free energy profile is al-
most perfectly isotropic even without rotational averag-
2.0 PET
ing (Fig. 2a-b), indicating that not only there are no
PET,2iavg.
1.5 collective effects that generate spurious molecular orien-
tations, but that for thermodynamic conditions that are
1.0
well-represented in the training data, the PET model is
0.5
c even closer to being exactly equivariant. We can further
0.0 assess indirect effects ofthe small symmetry breaking by
2 3 4 5 6 7 8 computingstructuralpropertiesoftheliquid,suchasthe
r(A˚)
pair correlation function and dipole-dipole correlations.
0.4
These quantities, which depend subtly on the relative
PET cL
uu position and orientation of pairs of water molecules, are
PET,2iavg. cT
0.2 uu essentiallyleftunchangedbytheapplicationofinference-
time averaging (Fig. 2c-d) – indicating that the lack of
exact equivariance in the raw PET predictions is in-
0.0
consequential. Even though it appears that structural
d
propertiesofwaterareperfectlyconvergedwithoutrota-
2 3 4 5 6 7 8 tional averaging, one may wonder if dynamical proper-
r(A˚)
ties, which are strongly dependent on the height of en-
ergy barriers, would be more sensitive to the broken ro-
FIG. 2. Structural properties of liquid water at T = 300 K,
tationalsymmetry. Fig.3showsthatthisisnotthecase:
simulated with a PET model with and without 2i rotational
Both translational and orientational diffusion are identi-
averaging. (a-b) Orientational free energy for the water
cal within the statistical error, regardless of whether the
moleculecomputedoveralongconstant-temperaturesimula-
tionwithout(a)andwith(b)2iaveraging. (c)O-Opaircor- PET model is made more equivariant by averaging over
relation function. (d) Molecular orientation correlation func- a grid of rotations.
tion,computedseparatelyforthelongitudinal(fulllines)and
Asafinaltest,weconsidertheenergeticsofprotondis-
transverse (dashed lines) components.
order in hexagonal ice. We consider 9 proton-disordered
cellsfromRef.37,andoptimizethegeometryusingaraw
PET model and a 2i rotational average. This amounts
space. We assess this by computing a histogram of the to an intermediate degree of extrapolation: Even though
polar angle of the molecular orientation (defined as the the training set contains only disordered structures, it
vector connecting the oxygen atom with the mid-point has been shown that models trained on liquid water are
of the two hydrogen atoms), over a long trajectory that also capable of describing, with good accuracy, the solid
is supplemented with an efficient colored-noise thermo- portion of the phase diagram [38]. It is also a prob-
stat [34] to sample a classical Boltzmann distribution at lem for which small energy differences matter and a case
T = 300 K. The histogram can then be re-cast as a free in which a small preference for a particular orientation
energy that should be constant throughout the spheri- could easily lead to macroscopic distortions upon relax-
cal coordinate system. As shown in Fig. 1d there is ation. Once again, the practical impact of approximate
indeed a significant (but tiny) inhomogeneity, of the or- equivarianceisnegligible. Theforcesontheinitialstruc-
derofafractionofk BT. Rotationalaveragingbringsthe tures (that are of the order of 1eV/˚A) differ by less
anisotropydowntothelevelofstatisticalnoise(Fig. 1e), than 1meV/˚A between standard and rotationally aver-
which is consistent with the sharp reduction in the value agedPET.Eventhoughindividualproton-orderedstruc-
of the torque seen in Fig. 1b. tures have energies that differ from each other by only
We now move to the more typical use case of simula- 0.3meV/molecule[39], relative energies are predicted by
tionsofbulkwater,toassesswhetherthesmall,butmea- the base model with an error that is an order of mag-
surable, violation of isotropy for the isolated molecule nitude smaller, about 0.02meV/molecule. The relaxed
φ
)r(OOg
)r(uuc4
perfectly compensated by a mild, dynamics-preserving,
15 PET
stochastic velocity rescaling thermostat (see the Supp. PET,2iavg.
10 Mat.). Another possibility that would be relevant where
obtaining a high level of equivariance is more important
5
than the sheer accuracy of the energy and force predic-
tions, is to modify the training loss to explicitly penalize
0
symmetry breaking, e.g., evaluating the same structure
1.0
over multiple orientations and requiring each prediction
to match the rotational average. This can help pushing
0.5 the degree of equivariance below the residual regression
error and can also be done for out-of-sample structures
for which reference properties have not been computed,
0.0
serving as a form of regularization [43].
0 2 4 6 8 10
Obviously,ourobservationsarespecifictothePETar-
t(ps)
chitecture and the systems we considered, but they add
to a growing body of empirical evidence indicating that
FIG. 3. Dynamical properties of liquid water at T =300 K,
simulatedwithaPETmodelwithandwithouta2irotational the practical impact of neglecting rotational symmetry
averaging. The shaded area around the curves indicates the is usually small. The success of non-equivariant mod-
(small) statistical uncertainty. (a) Oxygen mean-square dis- els in other applications of geometric deep learning and
placementcurves,whoseslopeisproportionaltothediffusion computer vision [16, 44] is a clear example, as well as
coefficient. (b) Dipole autocorrelation function, which is in-
the minute effects resulting from the application of an
dicative of the rotational dynamics of water molecules.
exact symmetrization scheme on validation errors in a
previous study of the PET architecture [19]. We think
thatthefactthatrotationsformacompactgroupwitha
geometries have a minuscule root mean squared distance low dimension contributes to the ease by which they can
(RMSD) of about 0.001˚A/atom. be learned from relatively small data sets. One should
Our tests show that applying random rotations dur- howeverkeepinmindthatnoamountoftestingcanguar-
ing training, i.e., standard data augmentation, can be antee that there are no corner cases, or adversarial ex-
sufficient to achieve a very high degree of approximate amples, in which a broken-symmetry model would lead
equivariance. Thereareessentiallynomeasurableeffects to grossly unphysical predictions. The angular momen-
onthestaticanddynamicalpropertiesobtainedinthein- tum precession of the isolated water molecule is a clear
terpolativeregime; thepotentialremainsstableandvery – although perhaps contrived – example.
close to equivariant even when extrapolating to a com- Still, this study provides some confidence to computa-
pletely different thermodynamic state point, from bulk tional physicists investigating promising non-equivariant
watertoasinglegas-phasemolecule. Wesuggestthatro- architectures, and demonstrates simple schemes to mon-
tationalaveragingduringinference(eitherusingaregular itor and improve the compliance with symmetry con-
grid as we do here, or with exact symmetrization tech- straints at little to no cost. Despite the unquestionable
niquesthatcanrestorerigorousequivariance[19,40])can appeal of incorporating fundamental physical concepts
beusedasasafeguardandasanitycheck. Theassociated in the architecture of machine-learning models, it might
overhead can be reduced by using a multiple-time-step be beneficial – and it certainly is not as detrimental one
integrator, or by only computing the symmetrized po- would expect – to just let models learn.
tential occasionally to monitor the discrepancy with the
non-symmetric model. Furthermore, there are several
strategies one could apply to obtain an equivariant de- SUPPORTING MATERIAL
scription avoiding this inference-time overhead entirely.
For example, one can apply a random rotation before ThePETcodeisfreelyavailableonhttps://github.
each PET evaluation, so that the potential is on aver- com/spozdn/pet/. Templates for the different tests we
age independent of the absolute orientation. This in- present, andweightsforthetrainedPETmodels, willbe
troduces a (small) noise that disrupts energy conserva- madeavailableuponpublication. Additionalinformation
tion, but can be controlled with gentle thermostatting – can also be found at https://marcel.science/eqt.
a strategy that is used routinely in atomistic simulations
to control errors due to incomplete convergence of self-
consistentalgorithms[41]orsamplingerrorsinquantum ACKNOWLEDGEMENTS
MonteCarlo[42]. Thisprocessofrandomrotationsleads
to simulations of bulk water that are free of preferential ML and MC acknowledge funding from the European
orientationeffects. Thesmalllevelofnoiseontheforceis Research Council (ERC) under the European Union’s
)2A˚()t(DSM
)t(uuc5
Horizon 2020 research and innovation programme Grant Geiger, Jonathan P. Mailoa, Mordechai Kornbluth,
No. 101001890-FIAMMA.SPandMCacknowledgesup- Nicola Molinari, Tess E. Smidt, and Boris Kozin-
portfromtheNCCRMARVEL,fundedbytheSwissNa- sky, “E(3)-equivariant graph neural networks for data-
efficient and accurate interatomic potentials,” Nature
tionalScienceFoundation(SNSF,grantnumber182892)
Communications 13, 1–11 (2022).
and from the Swiss Platform for Advanced Scientific
[12] Ilyes Batatia, Da´vid P´eter Kova´cs, Gregor N. C. Simm,
Computing (PASC).
Christoph Ortner, and Ga´bor Csa´nyi, “MACE: Higher
order equivariant message passing neural networks for
fastandaccurateforcefields,”inAdvancesinNeuralIn-
formation Processing Systems 35 (NeurIPS 2022), New
Orleans, Louisiana, USA, Nov 28–Dec 9 (Curran Asso-
∗ michele.ceriotti@epfl.ch ciates, 2022) pp. 11423–11436.
[1] Giuseppe Carleo, Ignacio Cirac, Kyle Cranmer, Lau- [13] ThorbenFrank,OliverUnke, andKlaus-RobertMu¨ller,
rent Daudet, Maria Schuld, Naftali Tishby, Leslie Vogt- “So3krates: Equivariant attention for interactions on
Maranto, andLenkaZdeborova´,“Machinelearningand arbitrary length-scales in molecular systems,” in Ad-
the physical sciences,” Reviews of Modern Physics 91, vances in Neural Information Processing Systems 35
045002 (2019). (NeurIPS2022),NewOrleans,Louisiana,USA,Nov28–
[2] Jonas Degrave, Federico Felici, Jonas Buchli, Michael Dec 9 (Curran Associates, 2022) pp. 29400–29413.
Neunert, Brendan Tracey, Francesco Carpanese, Timo [14] Jigyasa Nigam, Sergey Pozdnyakov, Guillaume Fraux,
Ewalds, Roland Hafner, Abbas Abdolmaleki, Diego and Michele Ceriotti, “Unified theory of atom-centered
De Las Casas, Craig Donner, Leslie Fritz, Cristian representations and message-passing machine-learning
Galperti, Andrea Huber, James Keeling, Maria Tsim- schemes,”TheJournalofChemicalPhysics156,204115
poukelli, Jackie Kay, Antoine Merle, Jean-Marc Moret, (2022).
Seb Noury, Federico Pesamosca, David Pfau, Olivier [15] Ilyes Batatia, Simon Batzner, Da´vid P´eter Kova´cs,
Sauter, Cristian Sommariva, Stefano Coda, Basil Duval, Albert Musaelian, Gregor N. C. Simm, Ralf Drautz,
Ambrogio Fasoli, Pushmeet Kohli, Koray Kavukcuoglu, Christoph Ortner, Boris Kozinsky, and Ga´bor Csa´nyi,
DemisHassabis, andMartinRiedmiller,“Magneticcon- “The design space of E(3)-equivariant atom-centered in-
trol of tokamak plasmas through deep reinforcement teratomic potentials,” arxiv:2205.06643 (2022).
learning,” Nature 602, 414–419 (2022). [16] Charles R. Qi, Li Yi, Hao Su, and Leonidas J. Guibas,
[3] Payel Das, Mark Moll, Herna´n Stamati, Lydia E. “PointNet++: Deep hierarchical feature learning on
Kavraki, and Cecilia Clementi, “Low-dimensional, free- point sets in a metric space,” in Proceedings of the 31st
energy landscapes of protein-folding reactions by non- InternationalConferenceonNeuralInformationProcess-
lineardimensionalityreduction,”ProceedingsoftheNa- ingSystems,NIPS’17(CurranAssociatesInc.,RedHook,
tionalAcademyofSciencesoftheUnitedStatesofAmer- NY, USA, 2017) pp. 5105–5114.
ica 103, 9885–9890 (2006). [17] Mutian Xu, Runyu Ding, Hengshuang Zhao, and Xiao-
[4] Jo¨rgBehlerandMicheleParrinello,“GeneralizedNeural- juan Qi, “PAConv: Position Adaptive Convolution with
Network Representation of High-Dimensional Potential- Dynamic Kernel Assembling on Point Clouds,” in 2021
Energy Surfaces,” Physical Review Letters 98, 146401 IEEE/CVFConferenceonComputerVisionandPattern
(2007). Recognition (CVPR) (IEEE, Nashville, TN, USA, 2021)
[5] Albert P. Barto´k, Mike C. Payne, Risi Kondor, and pp. 3172–3181.
Ga´bor Csa´nyi, “Gaussian Approximation Potentials: [18] Hengshuang Zhao, Li Jiang, Jiaya Jia, Philip Torr,
TheAccuracyofQuantumMechanics,withouttheElec- and Vladlen Koltun, “Point Transformer,” in 2021
trons,” Physical Review Letters 104, 136403 (2010). IEEE/CVF International Conference on Computer Vi-
[6] Matthias Rupp, Alexandre Tkatchenko, Klaus-Robert sion (ICCV) (IEEE, Montreal, QC, Canada, 2021) pp.
Mu¨ller, and O. Anatole von Lilienfeld, “Fast and Ac- 16239–16248.
curateModelingofMolecularAtomizationEnergieswith [19] Sergey Pozdnyakov and Michele Ceriotti, “Smooth, ex-
MachineLearning,”PhysicalReviewLetters108,058301 actrotationalsymmetrizationfordeeplearningonpoint
(2012). clouds,” in Advances in Neural Information Processing
[7] FelixMusil,AndreaGrisafi,AlbertP.Barto´k,Christoph Systems, Vol. 36 (Curran Associates, Inc., 2023) pp.
Ortner, Ga´bor Csa´nyi, and Michele Ceriotti, “Physics- 79469–79501.
inspiredstructuralrepresentationsformoleculesandma- [20] Josh Abramson, Jonas Adler, Jack Dunger, Richard
terials,” Chemical Reviews 121, 9759–9815 (2021). Evans,TimGreen,AlexanderPritzel,OlafRonneberger,
[8] MarcelF.Langer,AlexGoeßmann, andMatthiasRupp, LindsayWillmore,AndrewJ.Ballard,JoshuaBambrick,
“Representationsofmoleculesandmaterialsforinterpo- Sebastian W. Bodenstein, David A. Evans, Chia-Chun
lation of quantum-mechanical simulations via machine Hung, Michael O’Neill, David Reiman, Kathryn Tunya-
learning,”NaturePartnerJournalComputationalMate- suvunakool, Zachary Wu, Akvile˙ Zˇemgulyte˙, Eirini Ar-
rials 8, 41 (2022). vaniti, Charles Beattie, Ottavia Bertolli, Alex Bridg-
[9] Sergey N Pozdnyakov, Michael J Willatt, Albert P land, Alexey Cherepanov, Miles Congreve, Alexan-
Barto´k, Christoph Ortner, Ga´bor Csa´nyi, and Michele der I. Cowen-Rivers, Andrew Cowie, Michael Fig-
Ceriotti,“IncompletenessofAtomicStructureRepresen- urnov,FabianB.Fuchs,HannahGladman,RishubJain,
tations,” Physical Review Letters 125, 166001 (2020). Yousuf A. Khan, Caroline M. R. Low, Kuba Perlin,
[10] TessE.Smidt,“Euclideansymmetryandequivariancein Anna Potapenko, Pascal Savy, Sukhdeep Singh, Adrian
machinelearning,”TrendsinChemistry3,82–85(2021). Stecula,AshokThillaisundaram,CatherineTong,Sergei
[11] Simon Batzner, Albert Musaelian, Lixin Sun, Mario Yakneen, Ellen D. Zhong, Michal Zielinski, Augustin6
Zˇ´ıdek, Victor Bapst, Pushmeet Kohli, Max Jaderberg, 555 (2001).
DemisHassabis, andJohnM.Jumper,“Accuratestruc- [34] Michele Ceriotti, Giovanni Bussi, and Michele Par-
ture prediction of biomolecular interactions with Al- rinello, “Colored-noise thermostats a` la Carte,” Jour-
phaFold 3,” Nature (2024), 10.1038/s41586-024-07487- nal of Chemical Theory and Computation 6, 1170–1180
w. (2010).
[21] Xiang Fu, Zhenghao Wu, Wujie Wang, Tian Xie, [35] GBussi,DDonadio, andMParrinello,“Canonicalsam-
Sinan Keten, Rafael Gomez-Bombarelli, and Tommi S. pling through velocity rescaling,” Journal of Chemical
Jaakkola, “Forces are not enough: Benchmark and crit- Physics 126, 14101 (2007).
ical evaluation for machine learning force fields with [36] GiovanniBussiandMicheleParrinello,“Stochasticther-
molecularsimulations,”TransactionsonMachineLearn- mostats: Comparisonoflocalandglobalschemes,”Com-
ing Research (2023). puter Physics Communications 179, 26 (2008).
[22] Michael F Herbst and Antoine Levitt, “Black-box inho- [37] J A Hayward and J R Reimers, “Unit cells for the sim-
mogeneous preconditioning for self-consistent field iter- ulation of hexagonal ice,” Journal of Chemical Physics
ations in density functional theory,” Journal of Physics: 106, 1518–1529 (1997).
Condensed Matter 33, 085503 (2021). [38] Bartomeu Monserrat, Jan Gerit Brandenburg, Edgar A.
[23] Xiaojing Gong, Jingyuan Li, Hangjun Lu, Rongzheng Engel, andBingqingCheng,“Liquidwatercontainsthe
Wan, Jichen Li, Jun Hu, and Haiping Fang, “A charge- buildingblocksofdiverseicephases,”NatureCommuni-
driven molecular water pump,” Nature Nanotechnology cations 11, 5757 (2020).
2, 709–712 (2007). [39] Note that even though this is a stringent test for rota-
[24] Jirasak Wong-ekkabut, Markus S. Miettinen, Cristiano tional symmetry breaking, the energies are unlikely to
Dias, andMikkoKarttunen,“Staticchargescannotdrive fully capture the physics of proton ordering, given that
a continuous flow of water molecules through a carbon PET, as most MLPs, is a local model and misses an ex-
nanotube,” Nature Nanotechnology 5, 555–557 (2010). plicit description of long-range electrostatics.
[25] BingqingCheng,EdgarA.Engel,Jo¨rgBehler,Christoph [40] NadavDym,HannahLawrence, andJonathanW.Siegel,
Dellago, andMicheleCeriotti,“Abinitiothermodynam- “Equivariant frames and the impossibility of continuous
icsofliquidandsolidwater,”ProceedingsoftheNational canonicalization,” arxiv:2402.16077 (2024).
Academy of Sciences of the United States of America [41] Thomas D Ku¨hne, Matthias Krack, Fawzi R Mohamed,
116, 1110–1115 (2019). and Michele Parrinello, “Efficient and Accurate Car-
[26] YingkaiZhangandWeitaoYang,“Commenton“Gener- Parrinello-like Approach to Born-Oppenheimer Molec-
alizedGradientApproximationMadeSimple”,”Physical ular Dynamics,” Physical Review Letters 98, 66401
Review Letters 80, 890–890 (1998). (2007).
[27] Carlo Adamo and Vincenzo Barone, “Toward reliable [42] GuglielmoMazzolaandSandroSorella,“Acceleratingab
density functional methods without adjustable param- initio Molecular Dynamics and Probing the Weak Dis-
eters: The PBE0 model,” The Journal of Chemical persive Forces in Dense Liquid Hydrogen,” Physical Re-
Physics 110, 6158 (1999). view Letters 118, 015703 (2017).
[28] Stefan Grimme, Jens Antony, Stephan Ehrlich, and [43] Alice E A Allen, Genevi`eve Dusson, Christoph Ortner,
Helge Krieg, “A consistent and accurate ab initio and Ga´bor Csa´nyi, “Atomic permutationally invariant
parametrization of density functional dispersion correc- polynomials for fitting molecular force fields,” Machine
tion(DFT-D)forthe94elementsH-Pu.”TheJournalof Learning: Science and Technology 2, 025017 (2021).
chemical physics 132, 154104 (2010). [44] Meng-Hao Guo, Jun-Xiong Cai, Zheng-Ning Liu, Tai-
[29] Zubair Khalid, Salman Durrani, Rodney A. Kennedy, Jiang Mu, Ralph R. Martin, and Shi-Min Hu, “PCT:
Yves Wiaux, and Jason D. McEwen, “Gauss-Legendre Point cloud transformer,” Computational Visual Media
SamplingontheRotationGroup,”IEEESignalProcess- 7, 187–199 (2021).
ing Letters 23, 207–211 (2016).
[30] M. Tuckerman, B. J. Berne, and G. J. Martyna, “Re-
versible multiple time scale molecular dynamics,” The
Journal of Chemical Physics 97, 1990 (1992).
[31] VenkatKapil,MarianaRossi,OndrejMarsalek,Riccardo
Petraglia,YairLitman,ThomasSpura,BingqingCheng,
Alice Cuzzocrea, Robert H. Meißner, David M. Wilkins,
Benjamin A. Helfrecht, Przemys(cid:32)law Juda, S´ebastien P.
Bienvenue, Wei Fang, Jan Kessler, Igor Poltavsky,
Steven Vandenbrande, Jelle Wieme, Clemence Cormin-
boeuf, Thomas D. Ku¨hne, David E. Manolopoulos,
ThomasE.Markland,JeremyO.Richardson,Alexandre
Tkatchenko, Gareth A. Tribello, Veronique Van Spey-
broeck, andMicheleCeriotti,“I-PI2.0: Auniversalforce
engine for advanced molecular simulations,” Computer
Physics Communications 236, 214–223 (2019).
[32] JMFarrarandYTLee,“ChemicalDynamics,”Annual
Review of Physical Chemistry 25, 357–386 (1974).
[33] Adolf Miklavc, “Strong Acceleration of Chemical Reac-
tions Occurring Through the Effects of Rotational Exci-
tation on Collision Geometry,” ChemPhysChem 2, 552–Probing the effects of broken symmetries in machine learning
Supporting Materials
Marcel F. Langer,1 Sergey N. Pozdnyakov,1 and Michele Ceriotti1,
∗
1Laboratory of Computational Science and Modeling and National Centre for
Computational Design and Discovery of Novel Materials MARVEL, Institute of Materials,
E´cole Polytechnique F´ed´erale de Lausanne, 1015 Lausanne, Switzerland
I. POINT EDGE TRANSFORMER
Thearchitectureweemploy,PointEdgeTransformer(PET),wasintroducedanddescribedindetailinRef.1.
While PET was thoroughly discussed in that cited work, we provide a summary here, with a primary focus on
thehyperparametersthatweremodifiedrelativetoasimilartrainingexerciseforthewaterdatasetfromRef.2.
PETisagraph neural networkfeaturing N message-passinglayers. Ateachlayer, messagesare exchanged
GNN
between all atoms within a distance R from each other. The functional form of each layer is an arbitrarily
c
deep transformer applied individually to each atom. Atomic environments are constructed around each atom,
definedbyallneighborswithinR . Eachneighborsendsamessagetothecentralatom,witheachmessagebeing
c
a token of fixed size d . These tokens are processed by a transformer, which performs a permutationally
PET
equivariant sequence-to-sequence transformation. The output sequence is then treated as outbound messages
from the central atom to all neighbors. Consequently, for a model with N layers and a system with N
GNN
atoms, there are N individual transformers with distinct weights, each independently invoked N times,
GNN
resulting in N N transformer runs. The number of input tokens for each transformer run is determined by
GNN
the number of neighbors of the central atom.
In addition to an input message from a neighboring atom, geometric information about the displacement
vector r from the central atom to the corresponding neighbor is incorporated into the token. After each
ij
message-passing layer, all output messages are fed into a head (individual for each message-passing layer),
implemented as a shallow MLP, to produce a contribution to the total prediction. The total prediction, in this
case, the potential energy of the system, is computed as the sum of all head outputs over all message-passing
layers and all messages. This architecture is rigorously invariant with respect to translations because it uses
displacement vectors that do not change if both the central atom and a neighbor are rigidly shifted. It is
invariant with respect to permutations of identical atoms because the transformer defines a permutationally
covariant sequence-to-sequence transformation, and the sum over the contributions from all edges yields an
overall invariant energy prediction. However, it is not rotationally invariant since it operates with the raw
Cartesian components of displacement vectors.
ThefittingschemeweusedisidenticaltotheonedescribedinRef.1,withmoredetailsavailableinAppendix
C.5 of the cited work. We use Adam with linear warmup and do not apply weight decay. A specific aspect we
Model E (meV) F (meV/˚A)
Chengetal.[2],RMSE 4500 120
Nequip[3],MAE 120 21
PET[1],MAE - 14
PET[thiswork],MAE 74 17
PET[thiswork],RMSE 167 60
TableI.EnergyandforceerrorsforthetestsetforthebulkwaterdatasetfromRef.2,comparingthemodelusedhere
withthoseintheliterature. Notethatdifferentresultsintheliteraturereporteithermeanabsoluteerrorsorrootmean
square errors, as indicated, and that we could not use the exact same test/train split (although the train fraction is
consistent) so the comparison is only indicative. The observed drastic difference between MAE and RMSE indicates
the presence of outliers in the dataset, with the RMSE metric being heavily influenced by them. Additionally, it is
importanttonotethatwhilethedifferenceinMAEmetricsforthevalidation(usedforearlystopping)andtestsubsets
was negligible, the RMSE for PET on the validation subset was about 40 meV/˚A, or about 1.5 times smaller than on
the test subset. Given that the training, validation, and test split were random, this discrepancy further suggests that
theRMSEmetricisdominatedbyafewoutliers.
∗ michele.ceriotti@epfl.ch2
foundbeneficialforthefinalaccuracyisfittingthemodelwithahighlearningrateinitiallyandthendecreasing
the learning rate very rapidly at a certain point. Thus, our learning rate scheduler loosely resembles but is
not identical to OneCycleLR [4]. The hyperparameters of the architecture we used differ slightly from those in
Ref. 1 to make the model noticeably faster at the cost of a slight deterioration in accuracy. Similar to Ref. 1,
d was set to 128, and N (number of self-attention layers in each transformer) to 2. The most accurate
PET TL
modelinRef.1forthediscusseddatasetusedR =4.25˚AandN =6. Incontrast,weusedR =4.0˚Aand
c GNN c
N =4. Consequently, the accuracy slightly drops from a mean absolute error (MAE) on force components
GNN
of14.4meV/˚A,asreportedinRef.1,to17.1meV/˚A. However,themodelbecomesfaster,makingourselection
of hyperparameters a reasonable trade-off between accuracy and computational efficiency.
We report the validation error in comparison with some results in the literature (Table I), with the sole
purpose of demonstrating that the model we use is competitive with state-of-the-art equivariant models from
the point of view of benchmark accuracy.
II. APPROXIMATE (AND EXACT) ROTATIONAL SYMMETRIZATION.
Throughoutourexperiments,weusedanapproximatesymmetrizationschemedefinedinthemaintext,which
involvesaveragingpredictionsovermultiplerotationsbasedonsystematicallyconvergentgridsoverEulerangles.
Thisapproachallowsamodeltobemadearbitrarilyclosetoanequivariantone,albeitatthecostofprogressively
increased computational demand. However, it still does not achieve rigorous equivariance. Given that Ref. 1
proposes an exact symmetrization scheme, termed the Equivariant Coordinate System Ensemble (ECSE), it is
worth explaining why we decided not to employ it in this work. The exact symmetrization protocol works by
defining a set of local coordinate systems (equivalently rotations) for each atomic environment that are rigidly
attached toitand,thus,rotatesynchronouslywiththeatomicenvironment. Forstrictlylocalmodels,thefinal
prediction is computed by running a backbone architecture for each of these rotations and then computing a
weighted sum of all the predictions. Since all the coordinate systems rotate synchronously with the atomic
environment, all the predictions of the backbone architecture are exactly invariant with respect to rotations,
ensuring the final prediction is also rotationally invariant. The use of an ensemble of local coordinate systems,
rather than selecting an individual frame, aims to ensure smoothness of the resulting symmetrized model with
respect to geometric deformations of an input atomistic system, which is challenging to achieve using only
one local coordinate system [5]. The ECSE scheme also include a several optimizations to reduce the number
of coordinate systems needed to achieve smooth averaging, which makes ECSE computationally efficient for
strictly local models.
For message-passing schemes, and PET in particular, such an approach encounters a difficulty: when a
message is sent from atom A to atom B, there is a mismatch between the coordinate systems defined for the
atomic environments around atom A and atom B. Thus, for message-passing schemes, one possibility is to
utilizeanaiveapproachbyexplicitlytreatingmessage-passingschemesaslocalmodels(wherethecutoffradius
istheirreceptivefield). Whilethismaintainslinearscaling,itisverycomputationallyexpensive. Alternatively,
onewouldneedtoredesignthemessage-passingmechanismbyallowingoneto“match”thecoordinatesystems
of the different local environments, which changes the nature of the model and is therefore incompatible with
ourgoaltocomparetherawpredictionsofanon-symmetrizedPETmodelwithonethathasbeenmade(more)
equivariant without changing its architecture.3
III. ROTATIONAL ERROR FOR THE POTENTIAL
Wecanassessthemagnitudeofthesymmetrybreakinginaverydirectwaybycomparingtherawprediction
of the energy and forces of the PET model with those computed with a high degree of rotational averaging.
As shown in Table II, the error on forces an energy for the test set is about 10 times smaller than the error
relative totheDFT reference. Comparingtheenergyerrorforstructures obtainedfromNVT trajectories with
that on the test set is not trivial, as the system-size scaling depends on whether the errors on atom and bond-
centered contributions are systematic, or uncorrelated. However, it is clear from the force errors – that are
intensive and therefore easier to compare between structures of different size – that the bulk trajectories are in
aninterpolativeregime,withsmallererrorsthanforthetestset(whichcontainshighly-distortedconfigurations
from high-temperature simulations) while the isolated molecule have a much larger symmetry error, consistent
with the extrapolative nature of the prediction. Still, the rotational error for the energy of the molecule is
one order of magnitude smaller than thermal energy at the simulated conditions, which is reflected in the very
weak anisotropy of the orientational free energy. Fig. 1 demonstrates the convergence of the force error with
increasing degree of rotational averaging, demonstrating that the 2i grid reduces, in all cases, the rotational
error by at least an order of magnitude.
Dataset E E F F
⟨| PET− (me3 Vi|⟩
)
⟨| PE (T m− eV/3 ˚Ai| )⟩
Testset(n =64) 5.1 2.0
H2O
BulkMD(n =512) 8.0 1.2
H2O
GasMD(n =1) 2.7 12.0
H2O
TableII.Symmetryerror(MAE)fortotalenergyandforces,computedoverthetestset,acollectionofsnapshotsfrom
aNVTbulksimulationat300K,andacollectionofsnapshotsfromaNVTgas-phasesimulationat300K.
1100 testset
bulkMD
55
mol. MD
22
11
00..55
00..22
00..11
00..0055
0 i 2 2i 3
Averaginggrid
Figure 1. Convergence of rotational error for the forces (MAE) computed over the test set, a collection of snapshots
from a NVT bulk simulation at 300 K, and a collection of snapshots from a NVT gas-phase simulation at 300K. The
gridsarethesamediscussedinthemaintext.
)A˚/Vem(
f
f
i|i3
−dirg|h4
IV. STABILITY OF THE DYNAMICS
The PET model yields excellent qualitative stability – meaning that trajectories of several nanoseconds can
be performed for both bulk and gas-phase water without observing catastrophic events in which molecules lose
their chemical integrity. More quantitatively, Fig. 2 shows a small drift of the conserved quantity – defined
as potential plus kinetic energy, and including an additional term that tracks the total heat balance of the
thermostat used to enforce constant-temperature sampling[6] for the trajectories using non-symmetrized PET.
This very small drift is not due to the lack of rotational equivariance (as PET is still rigorously conservative)
but to the fact we use single-precision arithmetics. The drift is larger – but still amounting to a few tens of
meV per molecule per nanosecond – when using a multiple time step integrator with the grid-averaged PET
evaluatedeveryten0.5pssteps,andwhenperformingon-the-flyaveragingbyusingadifferentrandomrotation
at each evaluation of the model. Even in this latter case, a global stochastic velocity rescaling thermostat is
sufficienttomaintainaccuratecanonicalsampling: Structuralpropertiesareindistinguishablefromthoseofthe
grid-averaged trajectory (as shown in the next Section) and the mean kinetic energy of O and H atoms is less
than 0.2K away from the target temperature of 300K.
0.010
PET
PET,MTS
0.008 PET,rnd.
0.006
0.004
0.002
0.000
0 100 200 300 400 500
t(ps)
Figure2. Driftoftheconservedquantity(totalenergyplus
heat balance of the thermostat) for simulations of liquid
waterusinganon-symmetrizedPETmodel,a2i-gridrota-
tion averaging with multiple time step integration (MTS),
andanon-the-flyrandomaugmentationprotocol(rnd.).
)O2H/Ve(.sncE5
V. ON-THE-FLY RANDOM AUGMENTATION
We perform simulations for bulk water using at each force evaluation a different random rotation of the
system. We use a global stochastic velocity rescaling thermostat [7] that does not affect significantly the
dynamical properties of the system to control the effect of the resulting noise, which leads to a noticeable, but
small, increase in the drift of the conserved quantity, as observed in Fig. 2. Figures 3 and 4, to be compared
with the corresponding plots in the main text, demonstrate that the orientational distribution of the water
molecules is isotropic within the statistical noise, and that all static and dynamic translational and rotational
correlations are indistinguishable from that of a run using a grid-averaged model.
2π
15 PET,rnd
PET,2iavg.
10
π
5
0
a b
0 1.0
1 0 1 1 0 1
− −
cosθ cosθ
F/kBT 0.5
-0.40 -0.20 0.00 0.20 0.40
2.0 PET,rnd 0.0
PET,2iavg. 0 2 4 6 8 10
1.5
t(ps)
1.0
0.5 Figure 4. Dynamical properties of liquid water at T =
c
300 K, simulated with a PET model with random and
0.0 2i-gridrotationalaveraging. (a)Oxygenmean-squaredis-
2 3 4 5 6 7 8 placementcurves,whoseslopeisproportionaltothediffu-
r(A˚)
sioncoefficient. (b)Dipoleautocorrelationfunction,which
0.4 isindicativeoftherotationaldynamicsofwatermolecules.
PET,rnd cL
uu
PET,2iavg. cT
0.2 uu
0.0
d
2 3 4 5 6 7 8
r(A˚)
Figure 3. Structural properties of liquid water at T =
300 K, simulated with a PET model with on-the-fly ran-
dom augmentation, and with a fixed 2i grid rotational
averaging. (a-b) Orientational free energy for the water
moleculecomputedoveralongconstant-temperaturesim-
ulation with random (a) and 2i (b) averaging. (c) O-O
paircorrelationfunction. (d)Molecularorientationcorre-
lation function, computed separately for the longitudinal
(fulllines)andtransverse(dashedlines)components.
[1] S.PozdnyakovandM.Ceriotti,inAdvances in Neural Information Processing Systems,Vol.36(CurranAssociates,
Inc.,2023)pp.79469–79501.
[2] B. Cheng, E. A. Engel, J. Behler, C. Dellago, and M. Ceriotti, Proceedings of the National Academy of Sciences of
theUnitedStatesofAmerica116,1110(2019).
[3] S.Batzner,A.Musaelian,L.Sun,M.Geiger,J.P.Mailoa,M.Kornbluth,N.Molinari,T.E.Smidt,andB.Kozinsky,
NatureCommunications13,2453(2022).
[4] L. N. Smith and N. Topin, in Artificial intelligence and machine learning for multi-domain operations applications,
Vol.11006(SPIE,2019)pp.369–386.
φ
)r(OOg
)r(uuc
)2A˚()t(DSM
)t(uuc6
[5] N.Dym,H.Lawrence,andJ.W.Siegel,arXivpreprintarXiv:2402.16077 (2024).
[6] G.BussiandM.Parrinello,PhysicalReviewE75,56707(2007).
[7] G.Bussi,D.Donadio,andM.Parrinello,JournalofChemicalPhysics126,14101(2007).
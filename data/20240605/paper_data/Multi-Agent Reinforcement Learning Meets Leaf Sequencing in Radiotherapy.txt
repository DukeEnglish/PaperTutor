Multi-Agent Reinforcement Learning Meets Leaf Sequencing in Radiotherapy
RiqiangGao1 FlorinC.Ghesu2 SimonArberet1 ShahabBasiri3 EsaKuusela3 MartinKraus2
DorinComaniciu1 AliKamen1
Abstract
Dose Objectives Optimal Fluence
Incontemporaryradiotherapyplanning(RTP),a
Definition Prediction
keymoduleleafsequencingispredominantlyad-
ROI Contours
dressed by optimization-based approaches. In Iterative Refinement
this paper, we propose a novel deep reinforce- (if needed)
mentlearning(DRL)modeltermedasReinforced
LeafSequencer(RLS)inamulti-agentframework Sim.CT Deliverable Plan Leaf Sequencing
Clinical
for leaf sequencing. The RLS model offers im- Goals/Configs
provementstotime-consumingiterativeoptimiza-
tionstepsvialarge-scaletrainingandcancontrol Figure1.Illustration of a typical RTP process. Three common
movementpatternsthroughthedesignofreward components are shown in the orange boxes. We focus on leaf
mechanisms. We have conducted experiments sequencinginthiswork. Theterm“optimization”inthispaper
onfourdatasetswithfourmetricsandcompared referstoaseriesofmethodsthatarenotmachinelearning.
ourmodelwithaleadingoptimizationsequencer.
throughPlanningTargetVolume(PTV)whilesafeguarding
OurfindingsrevealthattheproposedRLSmodel
healthytissues,asindicatedbyOrgansatRisk(OARs). In
canachievereducedfluencereconstructionerrors,
practical RT, the RTP should also consider that the plan
andpotentialfasterconvergencewhenintegrated
can be delivered in a reasonable time. Current RTPs are
in an optimization planner.ResAtricdtedd i©ti Soienmaenlsl yM,edRicaLl SoSlutions USA, Inc., 2022
hasshownpromisingresultsPaigne 3afullartificialin- dominantbyoptimizationpipelinesinpracticalplatforms
suchasVarian(Varian,2023b)andElekta(Elekta,2023).
telligence RTP pipeline. We hope this pioneer
Thoughdifferenttreatmenttypesareexisting,e.g.,intensity-
multi-agentRLleafsequencercanfosterfuture
modulated radiation therapy (IMRT) (Mundt & Roeske,
researchonmachinelearningforRTP.
2005)andvolumetric-modulatedarctherapy(VMAT)(Otto,
2008),theiroptimizationpipelinessharesimilarkeycompo-
1.Introduction nents: doseobjectivesdefinition,optimalfluenceprediction,
andleafsequencingtogetfeasiblemachineparameters,as
Radiotherapy(RT)standsasanessentialcornerstoneinthe showninFigure11. Optimalfluencepredictionestimates
realmofcancertreatment,recommendedforapproximately a 2D intensity map of the radiation beam for each beam
halfofcancerpatients(Huynhetal.,2020). Despitetech- angleallowingforcustomizabledosedeliverytomeetthe
nologicaladvances, asubstantialpartofRTstilldepends objectives,however,thepracticalityofthefluencemaybe
onlabor-intensiveandtime-consumingplanningpipelines limitedasitcouldpotentiallyviolatecertainphysicalrules
fromadiversehealthcareteam(Elmoreetal.,2019). necessaryforachievability. Leafsequencingistoapprox-
imateoptimalfluenceswithfeasiblemachinemovements.
RadiotherapyPlanning(RTP),originatesfrom1890s,refers
Dependingontheimplementationdetailsofalgorithms,the
totheprocesstoplantheappropriateexternalbeamRTtreat-
fluencemapoptimizationandleafsequencingcanbeper-
mentforpatientswithcancer. ModernRTPinvolvestailor-
formedsequentiallyanditeratively.
ingpersonalizedtreatmentplanstoeffectivelytargettumors
Tolearnknowledgefromlarge-scaleexistingplans,deepsu-
1Digital Technology and Innovation, Siemens Healthineers,
PrincetonNJ,USA2DigitalTechnologyandInnovation,Siemens pervisedlearninghasbeenwidelyappliedtodoseobjectives
Healthineers, Erlangen, Germany 3Varian Medical Systems, definitionandoptimalfluencepredictionmodules(details
Siemens Healthineers, Helsinki, Finland. Correspondence to: in Section 2). Leaf sequencing is relatively challenging
RiqiangGao<riqiang.gao@siemens-healthineers.com>.
1In-depthRTPintroduction(background,terms,visuals,etc.)
Proceedings of the 41st International Conference on Machine isinAppendixA.SomeleafsequencingoptimizationsforVMAT
Learning,Vienna,Austria.PMLR235,2024.Copyright2024by skipfluenceprediction.Herewemainlydiscussthebranchwith
theauthor(s). fluencepredictioninthepipeline,suchasRapidArcTM(Varian).
1
4202
nuJ
3
]GL.sc[
1v35810.6042:viXraMARLMeetsLeafSequencinginRT
withsupervisedlearningbecauseitsoutputspaceislarge AI for RTP. Recently, researchers aim to translate artifi-
intheserialnature,especiallyforVMAT.Forexample,a cialintelligence(AI)toRTPtoachievefastandhigh-quality
typicalHD-120VMATplanwith178controlpoints(CPs) planning(Huynhetal.,2020;Luchinietal.,2022)toreplace
(Bergmanetal.,2014)hasover20Kdegreesofserialactions one ormore componentsof an optimizationpipeline. To
fromleafpositionsandmonitorunits. replaceconventionalpoint-basedobjectives,RapidPlanTM
introducedose-volumehistograms(DVHs)proposalasline-
Apart from being unable to leverage learning from exist-
objectives(Fogliataetal.,2019;Varian,2023a). Dosepre-
ing data, the absence of a differentiable leaf sequencing
dictionfrompatientdata(e.g.,CTandcontouring)withdeep
module poses a challenge for training the overall end-to-
learning may serve as 3D objectives (Barraga´n-Montero
end planning pipeline. In the spirit of recent success in
etal.,2019;Kearneyetal.,2020;Wangetal.,2022;Gao
decision-makingtasks, weproposeanewdeepreinforce-
etal.,2023;Fengetal.,2023;Jiaoetal.,2023;Gronberg
ment learning (DRL) model, termed as Reinforced Leaf
etal.,2023).Followingdoseprediction,deeplearningmeth-
Sequencer(RLS),foralearning-basedleafsequencing. Our
odsareusedtoreplacefluencemapoptimization(Romeijn
majorcontributionscanbesummarizedasbelow:
etal.,2003;2004)topredict2Dfluencemapsforeachbeam
anglebyfeedingprojectionsfrompredicted3Ddose(Wang
• Toourbestknowledge,wearethefirsttosuccessfully
etal.,2020;2021;Maetal.,2020;Yuanetal.,2022).
formulateleafsequencingproblemsinpracticalradio-
therapyscenarioswithadeepmulti-agentRLmodel. DeepRLandMulti-Agent. DeepRLhasmaderemark-
ableprogressinsequentialdecision-makingtasks,includ-
• We propose five reward components to reasonably
ingstrategygames(Mnihetal.,2013;Silveretal.,2016),
guidethemovementofleavesandmonitorunits. The
roboticcontrol(Mnihetal.,2015;Schulmanetal.,2017),
movepatterniscontrollablebytuningtheweightof
autonomousdriving(Kiranetal.,2021),andlandmarkde-
rewards,whichenableshumanpreferencesintheloop.
tection (Ghesu et al., 2017). Many of these applications
involvemultipleagents,necessitatingasystematicapproach
• ComparetovanillaRLoroptimizationmethods,RLS
tomodelingasmulti-agentRL(MARL)(Zhangetal.,2021).
abandonsiterativeprocessingandonlyexecutesonce
Comparedtovalue-basedRLs(Mnihetal.,2015;Coulom,
foreachCPforacceleratedinference.
2006), policy-based methods directly explore the policy
• Experimentsconductedonfourdatasetsacrosstwocan- space,withbetterconvergenceguarantees(Konda&Tsit-
cersites,RLSachieved1)betterorcloseperformances siklis, 1999; Yang et al., 2018; Wang et al., 2019; Zhang
compared to a leading optimization sequencer in a etal.,2021). Actor-criticalgorithmsinpolicy-basedbranch,
VMAToptimizationplatform(i.e.,PORIxmentioned suchasPPO(Schulmanetal.,2017)andSAC(Haarnoja
later);2)effectivepredictioninafull-AIpipeline. etal.,2018),haveachievedstate-of-the-artperformancein
manyapplications. PPOshowedsurprisingeffectivenessin
2.RelatedWork cooperativemulti-agentgames(Yuetal.,2022).
RLhasbeenappliedtoRTPtasks. Hrinivich&Lee(2020);
Leaf Sequencing in RTP Optimization. RTP is mainly
Ganeshan (2021) explored DQN for planning, however,
solved by optimization-based methods currently in both
thesestudieslieinsingle-leaf-pairsimulations. Aconcur-
IMRT and VMAT (Xia & Verhey, 1998; Shepard et al.,
rentwork(Hrinivichetal.,2024)extendedHrinivich&Lee
2002;Earletal.,2003;Ripsmanetal.,2022;Carrasqueira
(2020)toenableVMATina3Dbeamcontext. Differently,
etal.,2023;Fallahietal.,2022;Jhanwaretal.,2023;Cedric
wetargetmodularizingRTPpipelinetobemoreflexible;
&Tang,2011). TherearedifferentpipelinesofRTPopti-
makingleafsequencingcanleverageadvancesofotherAI
mization,onemajorbranch(asinFigure1),suchasCao
models(e.g.,dose/fluencepredictions)andenablingintegra-
et al. (2006); Shepard et al. (2007); Wang et al. (2008);
tionwithinoptimizationloops.Tothebestofourknowledge,
Bedford (2009), is including the leaf sequencing to con-
theproposedRLSisthefirstMARL-basedleafsequencerin
verttheoptimizedbeamintensitiesintodeliverablemulti-
practicalRTPscenarios(i.e.,outputsincludeleafpositions
leafcollimator(MLC)segmentstoformarc(s)orfieldsby
ateachleafpairandmonitorunitforeachcontrolpoint).
startingfromfluencemaps. RapidArcTM fromVarianisa
representative commercial example in this branch which
initiallyadoptedthealgorithminOtto(2008)andcontinu- 3.ProblemFormulationandIntuition
allyupgradedinsubsequentyears. RapidArchasdirectly
This paper focuses on leaf sequencing, the final module
promotedthelarge-scaleclinicalimplementationofVMAT
inRTPasinFigure1,toachievedeliverableoutcomes—a
(Cedric&Tang,2011;Infusino,2015). Comparedtoma-
domainscarcelyexploredwithinadvancedMARL.
chine learning, disadvantages of optimization algorithms
includetime-consumingiterativeexecutionandthelackof There are two common approaches for treatment: IMRT
leveragingknowledgefromlarge-scaletrainingdata.
2PTV projection leaf (2D) leaf (3D) fluence intensity in one bixel
X-ray
(d) cartoon fluence
Target Fluence
Cumulated Fluence Cumulated Fluence
(a) multi-leaf pairs in 2D (b) one-leaf pair in 3D (c) one-leaf pair fluences (e) real fluence
MARLMeetsLeafSequencinginRT
X-ray
Target Fluence
Isocenter Isocenter
Cumulated Fluence Cumulated Fluence
(a(a)) mmuullttii--leleafa pfapirasi irns 2D ((bb)) oonnee-l-elaefa pfapira iinr 3D (c()c)o cnuem-luelaatfedp vasir. tflarugeetnces
Figure3.(a)showsa2Dillustrationofmulti-leafpairs,withthe
(a) VMAT (b) IMRT
middledepictingPTVprojection. (b)providesa3Dviewofa
Restricted © Siemens Medical Solutions USA, Inc., 2022
Page 5 leafpairanditsconnectiontocumulatedfluences.(c)illustrates
Figure2.Control point distribution: Each black dot signifies a
motivationsofReward1(green)andReward2(red)bycomparing
controlpoint. (a)InVMAT,controlpointscanbeapproximate-
cumulatedandtargetfluences.DetailsareinAppendixA.
evenlyspacedalongthedesignatedarcduringtherapy,andmaybe
dividedintomultiplesectorsduringplanningandoptimization.(b)
only once per CP revisit multiple times
TheIMRTplaniscomprisedofseveralfields,eachencompassing
multiplecontrolpointsatidenticalgantryangles. .... ....
K control points K control points
(Mundt & Roeske, 2005) and VMAT (Otto, 2008) (as in
(a)RLS:finitehorizonRL (b)vanillaRLorconventionalmethods
Figure2andmoredetailsinAppendixA.1). IMRTemploys
multiplebeam-angles(i.e.,fields)withmodulatedintensity
Figure4.UsingfinitehorizonRLforacceleratedinference.Con-
usingmultileafcollimators(MLCs)tocreateprecisedose
ventional optimization methods start with an estimate of the
profiles. VMAToffersimproveddeliveryefficiencycom-
leaf/MU positions and iteratively refine the estimate until con-
paredtoIMRT,usingnumerousbeamdirectionsalongarc
vergeorthestoppingcriteriaaremet. Inprinciple,wecanalso
trajectory to delivery dose dynamically (Teh et al., 1999; apply vanilla RL in an infinite horizon context, and iteratively
Teoh et al., 2011; Quan et al., 2012). It is customary for refinetheestimates.However,toachievegreaterefficiencyduring
IMRT to generate a sequence of control points for a spe- inference,wetrainRLStoexecuteonlyonceforeachCP.
cificbeamangle. InVMATscenarios,variousoptimization
atCPs(aswell asotherpracticalregularization), asetof
techniques, including RapidArc, address leaf sequencing
rewardscanguidemovementsofleavesandMUs,asshown
byconsolidatingcontrolpointswithinasectorduringopti-
inFigure3candSection4.
mization(Unkelbachetal.,2015;Amendolaetal.,2013).
Consequently,theleafsequencinginbothVMATandIMRT Toreducetimecomplexity,weformulateleafsequencing
canbeviewedastheprocessofderivingasequenceofcon- underafinitehorizonRLadaptedfromPardoetal.(2018),
trolpoints,specifyingleafpositionsandmonitorunitsbased whereagentshavetomaximizeexpectedreturnonlyover
ontargetfluences,i.e.,optimalfluences. a fixed episode length, as in Figure 4. To cover multiple
leafpairsandMUprediction,weleveragethemulti-agent
Notethatthefluencepredictioncomponent’stargetfluence
framework. Consider practical function of leaf pairs and
F cannot be directly translated into outcomes for the RT
MUs,weproposeatwo-levelRLframeworkasinFigure5.
machine.Theleafsequencerisdesignedtopredictoutcomes
thatarefeasibleforthemachine. GivenX leafpairsinthe 4.Methodology: ReinforcedLeafSequencer
MLCforallK controlpointscontributingtothefluenceF
anddenotetheleafsequencerasf(·),wehave: OurframeworkisshowninFigure5. ThebackboneofRLS
is in spirit of PPO (Schulman et al., 2017). We also con-
(P,M)=f(F), (1)
ductedablationstudiesofotheractor-criticconfigurations.
whereP denotestheleafpositionswithasizeofK×X×2
andM isaK×1vectorrepresentingmonitorunit(MU).
4.1.KeyComponentsofRL
Intuition. We summarize our intuition in Figure 3 and
Enviroment. Theenvironmenttakestheoutputofagents
4. Leaf sequencing can be conceptualized as a sequence
(leafactorsandMUactor)andcomputethecumulatedflu-
ofdecision-makingtasks. Inthissequence,thegoalisto
ences. Target fluence generation and fluence map com-
approximatetargetfluencewithaseriesofcontrolpoints
putation from leaf sequencing are based on methods in a
(CPs).Thesedecisionsinvolveagentsselectingtheappropri-
planningenvironmentPORIx(detailsinAppendixB).
ateleafmovementsandMUsforeachCP.Figure3ashows
themulti-leafopeningsofoneCP.Eachleafpaircanfilter Actions. Wedefinetheleafmovementcreatingthefluence
X-rays to balance the radiation on PTV and OARs, as in mapasasequenceofdiscreteactionsla∼N2,−S ≤la≤
Figure 3b. By comparing cumulated and target fluences S. S isthemaximumstepsizeofeachleaf. TheMUaction
3Adapted multi-agent PPO (for paper)
MARLMeetsLeafSequencinginRT
leaf positions of 𝐶𝑃
target & cumu. fluences, 𝑘+1
leaf positions of𝐶𝑃
𝑘 Leaf Leaf 𝐴1……Leaf 𝐵1 cumu. fluence Yes
…
actors Leaf 𝐴𝑋 Leaf 𝐵𝑋
k+1 <
…
Num. of
MU CPs?
MUof 𝐶𝑃
actor 𝑘+1 No
1.3 2.1 1.8
…
Leaf Sequencing
target fluence leaf positions & MU predicted fluence
Figure5.IllustrationoftheproposedRLS.Theuppershowsthemethodologyandthelowershowstheinput/outputofRLS.Thetarget
fluenceissplittedintoXrows,eachrowisrelatedtooneleaf-pairandoneleafactor.x-thleafactorpredictsthepositionsofLeafA and
x
B .Allrowsink-thcontrolpoint(CP)sharesthesamemonitorunit,whichispredictedbyMUactorafterallleafpositionsareobtained.
x
ThestateofleafactoratCP includestargetfluence,cumulatedfluenceofCP ∼CP ,leafpositionsofCP .ThestateofMUactor
k+1 1 k k
issimilarbutreplaceleafpositionsofCP withthatofCP .
k k+1
1
Restricted © Siemens Healthineers, 2024
ma is continuous in the range of (R ,R ) where R can larizingtheshapeoftheapertureformedby(Ak,Bk),with
b e e
bethemaximumMUallowedbytheradiotherapymachine. areaandperimeterdenotedasareaandperirespectively,
Ink-thcontrolpointCP ,x-thleafpairhasaseparateleaf whichalignswithYoungeetal.(2012).
k
movementactionla , whileallleafpairsofCP share
x,k k Rewardsofk-thCP forx-thleafpairaredefinedasbelow:
thesameMUactionma .
k
Y
State. The state s of the leaf actors at CP is based on Rk =X Mk·F˜k ·1(F −Fˆk−1 >Mk)
k k 1 x,y x,y x,y
followinginformation: targetfluenceF,cumulatedfluence y=1
Fˆk,andleafpositions(Ak,Bk),thestepindexk,andleaf
Y
positionindexx. SinceMUactoristopredicttheoptimal Rk =−X 1(F −Fˆk <Mk)
2 x,y x,y (2)
MU,whosestateshouldbeupdatedwithnewleafpositions y=1
afterleafactorstakeactions. Thisistheso-calltwo-level Rk =1(Bk−Ak)−1(Ak−Bk)
3 x x x x
actionsmotivatedfromclinicalpractice. Forsimplicity,we
Rk =Σ (1−σ(|Ik−Ik−1|))
use(s ,la )torepresentthestateforMUactor,asinthe 4 I∈{A,B,M} x x
k k
afterwardsEq. 5. Rk =area(Ak,Bk)/peri(Ak,Bk)
5
Rewards. Constructing the reward system is pivotal for where Y is the second dimension size of fluence F. The
framingtheleafsequencingwithRL.Wedefinethecumu- totalrewardisdefinedasRk =λ 1·R 1k+λ 2·R 2k+λ 3·R 3k+
latedfluenceFˆk asthecumulationoffluencesofcontrol λ 4·R 4k+λ 5·R 5k. Detailswithpseudo-codeareshownin
points CP to CP , i.e., Fˆk = Pk Mk · F˜k, where AppendixFandmathsymbolsummaryisinAppendixA.
1 k i=1
Mk andF˜k areMUandunitfluenceofCP respectively.
k
Considerationsforrewarddesignareasfollows: 1)Encour- 4.2.Two-levelMulti-agentPPO
agement to approach target fluence (Reward 1): Positive
TheproposedRLSadaptsamulti-agentPPOframework.To
rewardsforactionsbringingcumulativefluencecloserto
accommodateRTcharacteristics,itincorporatestwolevels
thetarget,seeninthegreenofFigure3c. 2)Punishingover-
ofactions: leafmovementsandMUsprediction. RLStrains
dosing(Reward2):Penaltiesforactionscausingcumulative
three networks: leaf policy net π shared by all X leaf
fluence to exceed target intensity, represented by the red
θl
agentsparameterizedbyθ ,MUpolicyπ forMUagent
portioninFigure3c. 3)Avoidingcrossleaves(Reward3): l θm
parameterizedbyθ ,andcriticnetV parameterizedbyϕ.
m ϕ
Encouragingavoidanceofleft-rightleafintersection,consid-
eringitsimpracticality.4)Leaf/MUchangingregularization Thepolicynetsaretrainedtomaximizetheobjective:
betweenCPs(Reward4):Regularizingmachinemovement L(θ)=LCLIP(θ)+cEˆ [H(π )]+cEˆ [H(π )], (3)
betweencontrolpoints,withuser-adjustableparameterλ sur x,k θl k θm
4
intraining. 5)Apertureregularization(Reward5): Regu- whereH(π θ)istheentropyofthepolicydistribution,and
c is the entropy coefficient hyperparameter. The clipped
4MARLMeetsLeafSequencinginRT
Algorithm1RLStraining BBox: Normalized Size: Predicted Leaf Position:
Input:Xleafagentswithsharedpolicyπ andanMUagent
θl
withpolicyπ
θm
Output:trainedleafpolicyπ ,MUpolicyπ ,criticV
θl θm ϕ
1: Initialize parameters {θ,θ } for policies {π ,π } and Crop
l m θl θm &
parametersϕforcriticV ϕ Resize RLS agents
2: forn=1toRLiterationsdo
3: InitializedatabufferD
4: fori=1tobatchsizedo
5: Runpolicyπ intheenvironmentforXleafagents
θl,old Map leaf positions to original fluence coordination:
6: Runpolicyπ intheenvironmentforMUagent
θm,old
7: ComputetheadvantagesusingGAE
8: AddingtimestampdatatobufferD
Figure6.Illustrationofdealingwithheterogeneousfluenceswith
9: endfor
proposedcroppingstrategy. TheredboxisROIcoversfluence
10: fore=1toupdateepochsdo
locationswithpositiveintensity. TheRLSagentsmoduleonly
11: fori=1tobatchsizedo
12: ComputethepolicylossbasedonEq.3 dealwithnormalizedfluencemaps.
13: ComputethevaluelossbasedonEq.6
14: AdamWupdate{θ,θ }on{π ,π }likePPO
l m θl θm
15: AdamWupdateϕonπ θm likePPO of RLS, which is transformed to original fluence coordi-
16: endfor
nation as P obtained by linear interpolation and resize
17: endfor P =Resize(Pˆ· y2−y1 +y ,(K,x −x ,2)).
18: θ l,old ←θ l Y 1 2 1
19: θ ←θ
m,old m
20: endfor 4.4.DealingwithVariousLengthofSector
Due to various of machine or optimization settings, the
surrogateobjectiveLCLIP(θ)isgivenby: numberofcontrolpointsinonesectormaybedifferent. To
sur
makeasinglemodelthatcanbeappliedtovariouslengths,
h (cid:16) (cid:17)i
LC suL rIP(θ)=Eˆ
x,k
min r x,k(θ)Aˆ x,k,clip(r x,k(θ),1±ϵ)Aˆ
x,k
, (4) we provide a novel post-processing strategy: In order to
mergetwo(forexample)controlpointspresentedascoor-
wheretheadvantagesAˆ x,karecomputedusingGAE(Schul- dinates p k = p k−1 +d k, and p k+1 = p k +d k+1 (where
manetal.,2015)withrewardsdefinitioninSection4.1. The p k and d k are the position and predicted position change
probabilityratior x,k(θ)forx-thleafpairofCP k is associatedtoCP k);themergedpositionatCP k isdefined
asp¯ = pk+pk+1 =p +d +dk+1. Thus,RLScandeal
k 2 k−1 k 2
π (la |s )·π (ma |s ,la )
r (θ)= θl x,k x,k θm k k x,k . (5) withvariousnumberofCPsinasectorwithpost-processing
x,k π θl,old(la x,k|s x,k)·π θm,old(ma k|s k,la x,k) andwithoutfundamentallychangetheRLmodule.
Thecriticnetistrainedtominimizethelossfunction(with 4.5.InnovationHighlight
clippingfollowingCleanRL(Huangetal.,2022)):
Inthisstudy,weapplyPPOandmulti-agentlearningprin-
h i ciplestodevelopaninnovativeRLmodelthatincorporates
L(ϕ)=Eˆ 1(V (s )−(r +γV (s )))2 , (6)
x,k 2 ϕ x,k x,k ϕ x,k+1 two-levelagents(leafagentsandMUagent)inafinitehori-
zoncontext,aimingtoreducetimecomplexity. Thismodel
TheRLStrainingalgorithmisshowninAlgo. 1.
istailoredtoaddressreal-worldchallengesinRL.Ourpro-
posedrewardmechanismempowerscontrollablemovement
4.3.DealingwithHeterogeneousFluencePatterns
patternsoftheleafsequence,acrucialelementinRTP.Our
AsshowninFigure6,eveniftargetfluencesarefromthe studydemonstratesaninauguralapplicationofdeepmulti-
samesite(e.g.,head-and-neck),theirpatterncanbesignif- agentRLmethodsofleafsequencing.Thisapproachhasthe
icantly different due to patient distinction (e.g., different potentialtopartiallyreplaceoptimizationmethodsinRTP
sizeandshapeofPTV).Toreducesuchheterogeneity,we andfacilitateend-to-endlearningwithotherAImodules.
proposeacroppingstrategytonormalizethetargetfluence.
5.Experiment
AsinFigure6,wefirstdetectpositivevaluesintargetflu-
ence with coordination {xˆ,xˆ,yˆ,yˆ}, and crop the tar-
1 2 1 2 5.1.Dataset,Pre-processing,andPlanEvaluation
getfluencewithboundingbox{x = xˆ,x = xˆ,y =
1 1 2 2 1
yˆ/2,y = (yˆ +Y)/2}. In the training, y and y are Two sites of RT cancer treatment from four datasets are
1 2 2 1 2
sampledfrom(0,yˆ)and(yˆ,Y)respectivelyfordataaug- included: head-and-neck (HN) and prostate (Pros). The
1 2
mentation. Pˆ ispredictedleafpositionsintheoutputspace HN site includes three datasets: 1) the HNd set contains
5MARLMeetsLeafSequencinginRT
493 patients after quality assurance used for training and HNd HNe1 HNe2 Pros Pros(e)
test with a train/validation/test split, 2) two external test
PORIx .219 .257 .241 .079 .079
sites from TCIA: HNe1 (Bejarano et al., 2018) with 31 ours .149 .165 .146 .042 .043
patientsandHNe2(Grossbergetal.,2020)with140patients
afterfiltering. TheProssiteisfromapublicdatasetwith Table1.TheMNSE(↓)fromtargetfluenceandpredictedfluence.
accesspermissionrequirements,including555patientsafter
filtering. Eachpatienthasupto525targetfluencesfrom
HNd HNe1 HNe2 Pros Pros(e)
PORIxenvironment. DetailsareinAppendixG.
RIRE97%metric(↓)
Wehavethreecontextstoevaluatetheproposedmodel. 1) PORIx 18.8 26.3 20.6 4.13 4.13
PhotonOptimizerResearchInference(PORIx)ofaleading ours 12.6 10.7 14.4 3.85 3.75
commercial radiotherapy company Varian; 2) end-to-end AIRE97%metric(↓)
full-AIresearchpipelineforVMAT;and3)simulationwith PORIx 27.2 46.8 41.0 4.21 4.21
ours 17.6 27.9 31.6 3.93 3.78
IMRT.ThePORIxisaleadingoptimizationenvironment
AIRE99%metric(↓)
whichprovidescallbacksoftargetfluenceandleafposition-
PORIx 56.7 71.0 62.2 8.65 8.65
s/MUs. It also allows the user to overwrite the output of ours 50.1 66.3 53.1 7.25 7.05
theleafsequencer,whichcancompareourmethodwiththe
leaf sequencer in PORIx from multiple perspectives (see Table2.RIRE97%,AIRE97%andAIRE99%ofPORIxvs.ours.
AppendixB).TheleafsequencingoptimizationinPORIx,
terms as PORIx for short in some contexts, serves as a
baselinetocomparewithourRLS. perparametersS,R ,R aresetas4,0.5,2.5,respectively.
b e
MoredetailscanbefoundinAppendixC.
5.2.EvaluationMetrics
5.4.MainExperimentalResults
Weincludethreelevelsofevaluationforleafsequencing:
(1) Mean of Normalized Square Error (MNSE) to evalu- PlanningwithPORIx. Table1and2showthecompari-
ate the fluence reconstruction performance, which is de- sonbetweenourRLSandleafsequencingoptimizationin
fined as 1 Pn ||F−Fˆ||2. (2) Iterations Reducing p% PORIx. WeachievethelowerMNSEacrossallcompared
Error
(IREn p%i )= t1
o
e| v|F al| u|2
ate the optimization convergence contexts,indicatingourRLScanreconstructtargetfluence
speedofPORIxwhenitsleafsequencerisusingitsdefault betterthanPORIxwithexecutableleafpositionsandMUs.
modelvs. ourRLS.Specifically,twotypesofIREarede- ThereducedAIREandRIREsuggestthatanoptimization
fined: The absolute IREp% (AIREp%) is defined as the planner, such as PORIx, incorporating our RLS, has the
smallest of iteration whose planning cost is smaller than potentialforquickerconvergence. Figure7and8depict
E ·(1− p%), where E is the cost after the first itera- typicaloutcomesofourRLSandthePORIxoptimizer. The
1 1
tioninPORIx. TherelativeIREp%(RIREp%)isdefinedas RLS excels in challenging cases, especially in large and
(E −min(E))·(1−p%)+min(E).ThelistEiscostsfrom heterogeneousPTVcasesofthehead-and-neck(firstrowin
1
theplanningcostsofiterationsinPORIx. (3)Toevaluate bothfigures). Ineasiercasesofhead-and-neckandprostate
thereconstructionperformancefrom3Ddoseperspective (second and third rows), RLS performs close or slightly
(3Ddosesarecomputedfromtargetvs. predictedfluences), outperformsPORIxoptimizer. Notably,easycasesexhibit
weusetheDosescoreandDVHscorefromtheOpenKBP betterreconstructionandfasterconvergence,whichmaynot
challenge(Babieretal.,2020). poseasignificantchallengeinRTP.
5.3.ExperimentalSettings
Dosescore(↓) DVHscore(↓)
OurimplementationismotivatedbyCleanRL(Huangetal., MAE MSE MAE MSE
2022). Our major backbone is based on PPO, which has OpenKBPS1 2.4(1st) 15.5(1st) 1.5(1st) 5.9(1st)
OpenKBPS2 2.6(2nd) 16.6(2nd) 1.7(12nd) 6.8(10th)
shownsuccessinmanyapplicationsincludingGPT-4(Ope- OpenKBPS3 2.7(4th) 18.1(5th) 1.5(2nd) 6.0(2nd)
nAI,2023). Theactionsofleaves/MUsfollowthephysical Tengetal.(2024) 2.1 - 0.98 -
ours(VMAT,8cps) 0.19 0.18 0.88 1.2
regularizationintheplanningsystem,andMUactionsof
ours(IMRT,32degree) 0.23 0.28 0.97 1.6
asector/fieldarerefinedwithridgeregression. Wefollow
hyper-parameters related to PPO settings in CleanRL un-
Table3.DoseandDVHscoreswhencomparinga3Ddosefrom
lessmentioned. WeapplytheAdamWoptimizerwithan
prediction and a 3D dose from target. The upper panel is best
initiallearningrateof1e-4,weightdecay1e-4,andaCo-
performancesintheOpenKBPleaderboard(Babieretal.,2020)
sineAnnealingscheduler. Therewardratios{λ i}areset andthelatestbreakthrough;thelowerpanelisforevaluatingleaf
to{1,2,2,1,1}exceptinablationstudies. Theactionhy- sequencingwhentargetfluencefromfluencepredictionmodule.
6MARLMeetsLeafSequencinginRT
(a)target (b)ours (c)PORIx
NSE: .06 NSE: .20
NSE: .03 NSE: .01 (a) HN, large PTVs
NSE: .04 NSE: .05
Page 1
Figure7.Predictedfluencevs.targetfluence.Thereconstruction
errorisshownrightbottomofthepredictedfluences. Firstrow:
hardcasefromHN;secondrow: easycasefromHN;thirdrow:
prostatecase.ThisfigureismatchedwithcasesinFigure8. (b) HN, small PTVs
Full-AIEnd-to-endVMATPlanning(Prostate). Asin
Figure1,atypicalRTPpipelinecanconsistofthreemajor
components. Here,weevaluateourRLSinthecontextof
afull-AIend-to-endframeworkwithoutoptimizationitera-
tion. Theobjectivedefinitionisreplacedbydoseprediction
adaptedfromGaoetal.(2023),andthefluencepredictionis
motivatedbyWangetal.(2020)(whichwasoriginallyfor (c) Pros
IMRTfielddose,herehasbeenadaptedforVMAT).More
detailsofdose/fluencepredictionsareinAppendixERe.stricted © SiemFeingsu Mreed8ic.aTl Syopluitcioanlsc UaSsAe,s Inicn., d20if2f2erentscenarios.Theleftpanelshows
Page 1 thePTVcontourswithinbodymask;rightpanelshowsthemain
AsinFigure9andTable3,thecomputed3Ddosesfrom optimizationcostwiththenumberofiterations.Upper:largePTVs
targetfluence(notexecutableformachine)andpredicted (PTV54andPTV60)inHN,middle: smallPTVsinHN(PTV
fluencefromRLS(executablefrommachine)areclose,both 66),lower:PTVinprostate.TheRLSbringsclearimprovements
visuallyandintermsofDose/DVHscores. Comparedto forhardcases(e.g.,thosewithlargePTVs).
dose prediction (a module needed in E2E pipeline) from
OpenKBP challenge (Babier et al., 2020), RLS achieves (a)target (b)prediction (c)difference
betterDosescoreandDVHscorecomparedtostate-of-the- 2
60 60
artmodelsinOpenKBP2. 0
40 40
2
Simulation for IMRT. Although RLS was designed for 20 20
4
VMAT contexts, it can be applied to leaf sequencing of
IMRTwithasimulationtestbed.Wegroup16controlpoints 100 target body
pred body
(∼32degreebetweentwoadjacentbeamangles)asasin- 80 target rectum
pred rectum
glefieldfromfluencepredictionmoduleoftheend-to-end
60 target bladder
pipelineinaIMRT-simulationcontext. AsinTable3(last pred bladder 40 target ptv
row),ourRLSalsoachievespromisingperformance. pred ptv
20
5.5.AblationStudies 0
0 20 40 60 80
Dose G(Gy)
Backbone. Ourmajorexperimentsfollowthesettingsof
PPO in CleanRL (Huang et al., 2022), i.e., the networks Figure9.RT plan from an AI end-to-end preliminary solution.
ofactorandcriticareseparated. Weincludetheablation (a)targetisthe3Ddosecomputedfromfluences(notmachine
executable)ofFluencePredictionmodule,while(b)predictionis
2ItisacompromisetouserecordsofOpenKBPtocompare computedfromexecutableleafsequencing.Thelowerpartshows
withourmodelsinceourtasksarenotthesameasinOpenKBP. DVHsfromtarget(solidlines)andprediction(dashlines).
SeedetailedconsiderationsinAppendixE.
7
)%(
emuloV
lanoitcarFMARLMeetsLeafSequencinginRT
Weight 0 0.01 0.1 1 10
1.0 PPO (share)
PPO (separate)
λ 0.300 0.289 0.229 0.149 0.181
0.8 PPG 1
λ 0.574 0.528 0.271 0.151 0.226
2
0.6 λ 0.155 0.152 0.150 0.149 0.151
3
λ 0.148 0.147 0.147 0.149 0.167
0.4 4
λ 0.150 0.148 0.149 0.149 0.165
5
0.2
Table4.Thereconstructionerrors(MNSE)offiveweightsindif-
0 2500 5000 7500 10000 12500 15000 17500 20000 ferentscaleforeachrewardratioλ (otherλ )aresettodefault
i j̸=i
RL iterations
ratio.Thedefaultratiosare{λ :1,λ :2,λ :2,λ :1,λ :1},
1 2 3 4 5
whichachieve0.149ofMNSE.
Figure10.The ablation of different actor-critic structures with
normalizedreconstructionerrors.shareandseparaterepresentthe
policy-netandcritic-netaresharedandseparated,respectively. HNe1 Pros(e)
w/oCrop wCrop w/oCrop wCrop
RIRE97%(↓) 13.2 10.7−19% 6.13 3.85−38%
large AIRE97%(↓) 27.3 27.9+2% 6.25 3.93−37%
middle
0.8 small 0.9 AIRE99%(↓) 69.4 66.3−4% 9.44 7.25−23%
X small MNSE(↓) .181 .165−9% .060 .043−28%
0.6 0.8 large
middle
small
0.4 0.7 X small Table5.Withvs.withoutcroppingcomparison.RLSistrainedon
HNd,andexternallytestedonHNe1andprostatesites.
0.2 0.6
0 5000 10000 15000 20000 0 5000 10000 15000 20000 Figure11showsadetailedablationstudyoftheleafchange
RL iterations RL iterations inadjacentcontrolpoints(i.e.,RkinEq.2).Highleafspeed
4
(a)NormalizedErrors (b)Reward4
mayincreasetheinstabilityandviolatethemaxspeedof
theRTmachine,whilelowspeedmayreducetheflexibility
Figure11.Differentweightsonleafspeedregularization(i.e.,Re-
to reconstructthe targetfluence. We demonstratethat by
ward4inEq.2).Fourscalesofλ arecompared;Large:5,middle:
4 tuning the weight of the reward (i.e., λ ) in training, our
1,small:0.1,Xsmall:0.01. 4
modelallowsuserpreferenceinthebalancebetweenleaf
speedandreconstructionperformance.
studiesofsharingbackbonebetweenactorandcritic,and CroppingStrategy. Theutilizationofthecroppingstrat-
PPG(Cobbeetal.,2021)whichseparatesactorandcritic egyfacilitatesthenormalizationofheterogeneousfluence
training into distinct phases. As shown in Figure 10, in patterns. Acomprehensivecomparison,asinTable5,high-
ourleafsequencingcontext,theshared-networksettingisa lightstheimpactofcroppingvs. nocroppingandtheopti-
littleworsethantheseparate-networkunderthePPOsetting. mizationsolution. Significantly,thecroppingstrategyhas
Overall,thePPGframeworkhasminorsuperiorityoverPPO enhancedtheperformanceofleafsequencing,particularly
backbones. Consideringdifferencesarenotsignificantin evidentinexternaltestingacrossdiversesites,asindicated
thesethreebackbonesandforsimplicitypurposes,weapply bythecolumnsforPros(e)inTable5.Thisscenarioinvolves
themostwidelyusedPPO(separated)forthemajorityof trainingonhead-and-neckcancersiteandsubsequentlyex-
ourexperiments. Weleavecarefulcomparisonsofdifferent ternal testing on prostate cancer site. More experimental
backbonesinfuturework. resultscanbefoundinAppendixH.
TheRatioofRewardComponents. Tobetterunderstand
6.Discussion
thesensitivityofdifferentrewardcomponents,weconduct
theablationstudieswithfivedifferentratiosofeachreward,
Conclusion. ThispaperintroducestheReinforcedLeafSe-
asshowninTable4.
quencer(RLS),apioneermulti-agentreinforcementlearn-
Reward 1 and 2 are the major rewards driving the feasi- ingapproachinpracticalleafsequencingforradiotherapy.
bility of RLS, as depicted in Figure 13c, which are more RLScanpotentiallysupplantcommonlyusedoptimization-
sensitivetoweights. Reward3-5areauxiliarywithclinical basedmethods,producingexecutableplans. Ourtechnical
orphysicalconsiderations,whicharelesssensitivetothe contributioninvolvesextendingmulti-agentandProximal
weight. The default weights achieved a reasonably good PolicyOptimization(PPO)intoatwo-levelpracticalleaf
performance,exposingsuchablationstudiesguidesusersto sequencing framework, incorporating novel rewards and
chooseweightsindifferentscenarios. actions. WeassesstheperformanceoftheproposedRLS
8
rorrE
dezilamroN
rorrE
dezilamroN
4 draweRMARLMeetsLeafSequencinginRT
usingfourdatasets(threefromhead-and-necksiteandone Disclaimer
fromprostatesite)inthreedistinctcontexts: 1)apractical
Theinformationinthispaperisbasedonresearchresults
radiotherapyenvironment,2)afull-AIend-to-endresearch
that are not commercially available. Future commercial
pipeline,and3)IMRTsimulation. Notably,ourAImodel,
availabilitycannotbeguaranteed.
even without an iteration loop, exhibits improvements in
termsofreconstructionerrorandearlyiterationcoverage
ratewhencomparedtooptimizationmethods. ImpactStatement
LimitationandFutureWork. Asaninitialendeavorto Thispaperpresentsworkwhosegoalistoadvancethefield
address practical leaf sequencing with MARL, our work of Machine Learning for Radiotherapy. There are many
has several limitations. First, unlike well-established re- potentialsocietalconsequencesofourwork,nonewhichwe
searchdomains,ourcomparativeanalysesareconstrained feelmustbespecificallyhighlightedhere.
bythescarcityofdirectlyrelevantliterature. Moreover,the
absenceofopen-sourcemodels,oftenattributabletocom-
Acknowledgement
mercialorconfidentialityconstraints,furtherhindersdirect
comparisons. Fortunately, the PORIx provides a contem- WeacknowledgethesupportofVarianfortheresearchin-
porary baseline for evaluation and facilitates meaningful terfaceofpracticalplanningenvironment,anditsfeasibility
comparisons. Second, the training of RLS is focused on toevaluateleafsequencingperformances.
leafsequencingmodulesothatmain-loopcostsinPORIx
WethankVivekSinghandYueZhangfromDigitalTechnol-
maynotbealwayswell-optimized. Thislimitationissim-
ogyandInnovation,SiemensHealthineersforthehelpful
ilarlypresentintheend-to-endAIplanningpipeline. One
discussionsonthisstudy.
future work is to train different modules end-to-end for
globaloptimalplan. Third,wecurrentlyconcentratesolely WethankallthedatacontributorstotheREQUITEproject,
on the initial ≤ 100 iterations of PORIx as a preliminary including patients, clinicians and nurses. The core RE-
plan. Inclinicalpractice,thenumberofiterationscantheo- QUITE consortium consists of David Azria, Erik Briers,
reticallybeinfinite,andplannerscanusemulti-resolution JennyChang-Claude,AlisonM.Dunning,RebeccaM.El-
planning(asinEclipse)tofine-tunesolutions. Wesimpli- liott,CorinneFaivre-Finn,SaraGutie´rrez-Enr´ıquez,Kerstie
fiedthisprocessforlarge-scaleautomation. Onepotential Johnson,ZoeLingard,TizianaRancati,TimRattay,BarryS.
future work could involve initiating the planning process Rosenstein,DirkDeRuysscher,PetraSeibold,ElenaSperk,
withdeeplearningplans,whichofferrapidandautomated R.PaulSymonds,HilaryStobart,ChristopherTalbot,Ana
solutions, followed by a limited number of human/opti- Vega,LivVeldeman,TimWard,AdamWebbandCatharine
mizationinterventionsteps. Morecontextscanbefoundin M.L.West.
AppendixB.Fourth,weoptforoneofthemostrepresen-
tativeRLframeworks,specificallyPPO,asourbackbone.
References
ItseffectivenesshasbeenvalidatedacrossvariousRLtasks,
includingrenownedLLMs(OpenAI,2023). Althoughwe Amendola,B.E.,Amendola,M.,Perez,N.,Iglesias,A.,and
performsomeablationsonitsactor-criticconfiguration,the Wu,X. Volumetric-modulatedarctherapywithrapidarc:
explorationofexperimentalcomparisonsamongvariousRL Anevaluationoftreatmentdeliveryefficiency. Reportsof
backbones,suchaswithmodel-basedRLs(Moerlandetal., practicaloncologyandradiotherapy,2013.
2023),isleftforfuturework.
Babier,A.,Zhang,B.,Mahmood,R.,Moore,K.L.,Purdie,
Outlook. Excitementsurroundsthepotentialofdeeplearn- T.G.,McNiven,A.L.,andChan,T.C.Y. OpenKBP:The
ingtofullyorpartiallyreplaceconventionaloptimization open-accessknowledge-basedplanninggrandchallenge.
inpracticalRT,despiteacknowledgedlimitations. Thepro- MedicalPhysics,2020.
posedRLSstandsoutforthreekeyreasons: 1)itenables
potentialend-to-endlearningfortheentireplanningpipeline Barraga´n-Montero,A.M.,Nguyen,D.,Lu,W.,Lin,M.H.,
toseekglobaloptimalsolutions;2)unliketheleafsequencer Norouzi-Kandalan,R.,Geets,X.,Sterpin,E.,andJiang,
methodusediniterativeoptimizers(suchastypicalVMAT), S. Three-dimensional dose prediction for lung IMRT
there is no need to give as input a “seed sequence” (i.e., patientswithdeepneuralnetworks: robustlearningfrom
initialstateofleafpositionsandMUs)frompreviousitera- heterogeneous beam configurations. Medical Physics,
tion,allowingamoreflexiblealgorithmdesign;and3)with 2019.
properlearnedknowledge,RLScanpotentiallydeliversu-
Bedford,J.L.Treatmentplanningforvolumetricmodulated
periorperformancethanoptimizationwithuser-preference.
arctherapy. Medicalphysics,2009.
Weareexcitedaboutfutureworkwhenmoreadvancedal-
gorithmsandscenariosareapplied.
Bejarano,T.,Ornelas-Couto,M.,andMihaylov,I. Head-
9MARLMeetsLeafSequencinginRT
and-necksquamouscellcarcinoma(hnscc)patientswith diffusionmodel. InInternationalConferenceonMedical
3dcttakenduringpre-treatment,mid-treatment,andpost- ImageComputingandComputer-AssistedIntervention.
treatmentdataset. TheCancerImagingArchive,2018. Springer,2023.
Bergman,A.M.,Gete,E.,Duzenli,C.,andTeke,T. Monte
Fogliata, A., Cozzi, L., Reggiori, G., Stravato, A., Lobe-
carlomodelingofhd120multileafcollimatoronvarian
falo,F.,Franzese,C.,Franceschini,D.,Tomatis,S.,and
truebeamlinearacceleratorforverificationof6xand6x
Scorsetti,M. RapidPlanknowledgebasedplanning: Iter-
fffvmatsabrtreatmentplans. Journalofappliedclinical
ativelearningprocessandmodelabilitytosteerplanning
medicalphysics,2014.
strategies. RadiationOncology,2019.
Cao,D.,Earl,M.A.,Luan,S.,andShepard,D.M. Continu-
Ganeshan, A. R. Reinforcement learning applied to mlc
ousintensitymapoptimization(cimo): anovelapproach
toleafsequencinginstepandshootimrt.Medicalphysics, tracking,2021.
2006.
Gao, R., Lou, B., Xu, Z., Comaniciu, D., and Kamen, A.
Carrasqueira,P.,Rocha,H.,Dias,J.,Ventura,T.,Ferreira, Flexible-cmgan: Towardsprecise3ddosepredictionin
B., and Lopes, M. An automated treatment planning radiotherapy. InProceedingsoftheIEEE/CVFConfer-
strategyforhighlynoncoplanarradiotherapyarctrajecto- enceonComputerVisionandPatternRecognition,2023.
ries. InternationalTransactionsinOperationalResearch,
2023. Ghesu,F.-C.,Georgescu,B.,Zheng,Y.,Grbic,S.,Maier,
A.,Hornegger,J.,andComaniciu,D. Multi-scaledeep
Cedric, X. Y. and Tang, G. Intensity-modulated arc ther-
reinforcementlearningforreal-time3d-landmarkdetec-
apy:principles,technologiesandclinicalimplementation.
tioninctscans. IEEEtransactionsonpatternanalysis
PhysicsinMedicine&Biology,2011.
andmachineintelligence,2017.
Cobbe, K. W., Hilton, J., Klimov, O., and Schulman, J.
Phasicpolicygradient. InInternationalConferenceon Gronberg,M.P.,Jhingran,A.,Netherton,T.J.,Gay,S.S.,
MachineLearning,2021. Cardenas, C. E., Chung, C., Fuentes, D., Fuller, C. D.,
Howell, R. M., Khan, M., et al. Deep learning–based
Coulom, R. Efficientselectivityand backup operatorsin dosepredictiontoimprovetheplanqualityofvolumetric
monte-carlotreesearch. InInternationalconferenceon modulatedarctherapyforgynecologiccancers. Medical
computersandgames,2006. physics,2023.
Earl, M. A., Shepard, D. M., Naqvi, S., Li, X. A., and
Grossberg,A.,Elhalawani,H.,Mohamed,A.,Mulder,S.,
Yu,C.X. Inverseplanningforintensity-modulatedarc
Williams,B.,White,A.,Zafereo,J.,Wong,A.,Berends,
therapy using direct aperture optimization. Physics in
J., AboHashem, S., Aymard, J., Kanwar, A., Perni, S.,
MedicineandBiology,2003.
Rock,C.,Chamchod,S.,Kantor,M.,Browne,T.,Hutch-
Elekta. High-precision treatment planning for radia- eson, K., Gunn, G., Frank, S., Rosenthal, D., Garden,
tion therapy, 2023. URL https://www.elekta. A.,andFuller,C. M.d.andersoncancercenterheadand
com/products/oncology-informatics/ neckquantitativeimagingworkinggroup.(2020)hnscc
elekta-one/treatment-applications/ [dataset]. TheCancerImagingArchive,2020.
monaco/. Accessed: 2023-10-12.
Haarnoja, T., Zhou, A., Abbeel, P., and Levine, S. Soft
Elmore, S. N. C., Prajogi, G. B., Rubio, J. A. P., and Zu-
Actor-Critic: Off-PolicyMaximumEntropyDeepRein-
bizarreta,E. Theglobalradiationoncologyworkforcein forcementLearningwithaStochasticActor. InInterna-
2030: estimatingphysiciantrainingneedsandproposing tionalConferenceonMachineLearning,2018.
solutionstoscaleupcapacityinlow-andmiddle-income
countries. ApplRadOncol,2019.
Hrinivich, W. T. and Lee, J. Artificial intelligence-based
radiotherapymachineparameteroptimizationusingrein-
Fallahi, A., Mahnam, M., and Niaki, S. T. A. A discrete
forcementlearning. Medicalphysics,2020.
differential evolution with local search particle swarm
optimizationtodirectangleandapertureoptimizationin
Hrinivich,W.T.,Bhattacharya,M.,Mekki,L.,McNutt,T.,
imrttreatmentplanningproblem. AppliedSoftComput-
Jia,X.,Li,H.,Song,D.Y.,andLee,J. Clinicalvmatma-
ing,2022.
chineparameteroptimizationforlocalizedprostatecan-
Feng,Z.,Wen,L.,Wang,P.,Yan,B.,Wu,X.,Zhou,J.,and cerusingdeepreinforcementlearning. Medicalphysics,
Wang, Y. Diffdp: Radiotherapy dose prediction via a 2024.
10MARLMeetsLeafSequencinginRT
Huang,S.,Dossa,R.F.J.,Ye,C.,Braga,J.,Chakraborty,D., Moerland, T. M., Broekens, J., Plaat, A., Jonker, C. M.,
Mehta,K.,andArau´jo,J.G.Cleanrl:High-qualitysingle- et al. Model-based reinforcement learning: A survey.
fileimplementationsofdeepreinforcementlearningal- FoundationsandTrends®inMachineLearning,2023.
gorithms. TheJournalofMachineLearningResearch,
2022.
Mundt,A.J.andRoeske,J.C.Intensitymodulatedradiation
therapy: aclinicalperspective. PMPH-USA,2005.
Huynh,E.,Hosny,A.,Guthier,C.,Bitterman,D.S.,Petit,
S.F.,Haas-Kogan,D.A.,Kann,B.,Aerts,H.J.,andMak, OpenAI. Gpt-4 technical report. arXiv preprint
R.H. Artificialintelligenceinradiationoncology. Nature arXiv:2303.08774,2023.
ReviewsClinicalOncology,2020.
Otto,K. Volumetricmodulatedarctherapy: Imrtinasingle
Infusino,E. Clinicalutilityofrapidarc™radiotherapytech- gantryarc. Medicalphysics,2008.
nology. CancerManagementandResearch,2015.
Pardo,F.,Tavakoli,A.,Levdik,V.,andKormushev,P. Time
Jhanwar, G., Tefagh, M., Taasti, V. T., Alam, S. R., Tuo- limitsinreinforcementlearning. InInternationalConfer-
maala,S.,Nadeem,S.,andZarepisheh,M. Portpy: An enceonMachineLearning,2018.
open-sourcepythonpackageforplanningandoptimiza-
tioninradiationtherapyincludingbenchmarkdataand Quan,E.M., Li,X.,Li,Y.,Wang,X.,Kudchadker, R.J.,
algorithms. AAPM65thAnnualMeetingandExhibition, Johnson,J.L.,Kuban,D.A.,Lee,A.K.,andZhang,X.A
2023. comprehensivecomparisonofimrtandvmatplanquality
forprostatecancertreatment. InternationalJournalof
Jiao, Z., Peng, X., Wang, Y., Xiao, J., Nie, D., Wu, X., RadiationOncologyBiologyPhysics,2012.
Wang,X.,Zhou,J.,andShen,D.Transdose:Transformer-
basedradiotherapydosepredictionfromctimagesguided Ripsman, D. A., Purdie, T. G., Chan, T. C., and Mah-
bysuper-pixel-levelgcnclassification. MedicalImage moudzadeh,H. Robustdirectapertureoptimizationfor
Analysis,2023. radiationtherapytreatmentplanning. INFORMSJournal
onComputing,2022.
Kearney,V.,Chan,J.W.,Wang,T.,Perry,A.,Descovich,
M.,Morin,O.,Yom,S.S.,andSolberg,T.D. DoseGAN: Romeijn,H.E.,Ahuja,R.K.,Dempsey,J.F.,Kumar,A.,
agenerativeadversarialnetworkforsyntheticdosepredic- andLi, J.G. Anovellinearprogrammingapproachto
tionusingattention-gateddiscriminationandgeneration. fluencemapoptimizationforintensitymodulatedradia-
ScientificReports,2020. tiontherapytreatmentplanning. PhysicsinMedicine&
Biology,2003.
Kiran,B.R.,Sobh,I.,Talpaert,V.,Mannion,P.,AlSallab,
A.A.,Yogamani,S.,andPe´rez,P. Deepreinforcement Romeijn,H.E.,Dempsey,J.F.,andLi,J.G. Aunifying
learningforautonomousdriving: Asurvey. IEEETrans- framework for multi-criteria fluence map optimization
actionsonIntelligentTransportationSystems,2021. models. PhysicsinMedicine&Biology,2004.
Konda, V. and Tsitsiklis, J. Actor-critic algorithms. Ad- Schulman,J.,Moritz,P.,Levine,S.,Jordan,M.,andAbbeel,
vancesinneuralinformationprocessingsystems,1999. P.High-dimensionalcontinuouscontrolusinggeneralized
advantageestimation. arXivpreprintarXiv:1506.02438,
Luchini,C.,Pea,A.,andScarpa,A. Artificialintelligence
2015.
inoncology: currentapplicationsandfutureperspectives.
BritishJournalofCancer,2022.
Schulman, J., Wolski, F., Dhariwal, P., Radford, A., and
Klimov, O. Proximal policy optimization algorithms.
Ma,L.,Chen,M.,Gu,X.,andLu,W. Deeplearning-based
arXivpreprintarXiv:1707.06347,2017.
inversemappingforfluencemapprediction. Physicsin
Medicine&Biology,2020.
Seibold, P., Webb, A., Aguado-Barrera, M.E., Azria, D.,
Bourgier, C., Brengues, M., Briers, E., Bultijnck, R.,
Mnih, V., Kavukcuoglu, K., Silver, D., Graves, A.,
Calvo-Crespo,P.,Carballo,A.,Choudhury,A.,Cicchetti,
Antonoglou,I.,Wierstra,D.,andRiedmiller,M. Playing
A., Claßen, J., Delmastro, E., Dunning, A. M., Elliott,
atari with deep reinforcement learning. arXiv preprint
R.M.,Farcy-Jacquet,M.P.,Gabriele,P.,Garibaldi,E.,
arXiv:1312.5602,2013.
Go´mez-Caaman˜o,A.,Gutie´rrez-Enr´ıquez,S.,Higginson,
Mnih,V.,Kavukcuoglu,K.,Silver,D.,Rusu,A.A.,Veness, D.S.,Johnson,K.,Lobato-Busto,R.,Molla`,M.,Mu¨ller,
J.,Bellemare,M.G.,Graves,A.,Riedmiller,M.,Fidje- A., Payne, D., Peleteiro, P., Post, G., Rancati, T., Rat-
land, A. K., Ostrovski, G., et al. Human-level control tay,T.,Reyes,V.,Rosenstein,B.S.,DeRuysscher,D.,
throughdeepreinforcementlearning. nature,2015. De Santis, M. C., Scha¨fer, J., Schnabel, T., Sperk, E.,
11MARLMeetsLeafSequencinginRT
Symonds,R.P.,Stobart,H.,Taboada-Valladares,B.,Tal- Wang,B.,Teng,L.,Mei,L.,Cui,Z.,Xu,X.,Feng,Q.,and
bot, C.J., Valdagni, R.,Vega, A., Veldeman, L., Ward, Shen,D. DeepLearning-BasedHeadandNeckRadio-
T., Weißenberger, C., West, C. M., and Chang-Claude, therapyPlanningDosePredictionviaBeam-WiseDose
J. REQUITE: A prospective multicentre cohort study Decomposition. InInternationalConferenceonMedical
of patients undergoing radiotherapy for breast, lung or ImageComputingandComputer-AssistedIntervention,
prostatecancer. RadiotherapyandOncology,2019. 2022.
Shepard, D., Cao, D., Afghan, M., and Earl, M. An arc- Wang,C.,Luan,S.,Tang,G.,Chen,D.Z.,Earl,M.A.,and
sequencingalgorithmforintensitymodulatedarctherapy. Cedric, X. Y. Arc-modulated radiation therapy (amrt):
Medicalphysics,2007. a single-arc form of intensity-modulated arc therapy.
PhysicsinMedicine&Biology,2008.
Shepard,D.M.,Earl,M.A.,Li,X.A.,Naqvi,S.,andYu,
C. Directapertureoptimization: aturnkeysolutionfor Wang,L.,Cai,Q.,Yang,Z.,andWang,Z. Neuralpolicy
step-and-shootimrt. Medicalphysics,2002. gradientmethods: Globaloptimalityandratesofconver-
gence. arXivpreprintarXiv:1909.01150,2019.
Silver,D.,Huang,A.,Maddison,C.J.,Guez,A.,Sifre,L.,
VanDenDriessche,G.,Schrittwieser,J.,Antonoglou,I., Wang,W.,Sheng,Y.,Wang,C.,Zhang,J.,Li,X.,Palta,M.,
Panneershelvam, V., Lanctot, M., et al. Mastering the Czito,B.,Willett,C.G.,Wu,Q.,Ge,Y.,Yin,F.F.,and
gameofgo with deepneuralnetworksandtreesearch. Wu,Q.J. FluenceMapPredictionUsingDeepLearning
nature,2016. Models – Direct Plan Generation for Pancreas Stereo-
tactic Body Radiation Therapy. Frontiers in Artificial
Society, C. C. external radiation therapy, 2024. URL Intelligence,2020.
https://cancer.ca/en/treatments/
treatment-types/radiation-therapy/ Wang,W.,Sheng,Y.,Palta,M.,Czito,B.,Willett,C.,Hito,
external-radiation-therapy. Accessed: M., Yin, F.-F., Wu, Q., Ge, Y., and Wu, Q. J. Deep
Learning-Based Fluence Map Prediction for Pancreas
2024-01-10.
StereotacticBodyRadiationTherapyWithSimultaneous
Teh,B.S.,Woo,S.Y.,andButler,E.B.IntensityModulated IntegratedBoost. AdvancesinRadiationOncology,2021.
RadiationTherapy(IMRT):ANewPromisingTechnol-
Xia,P.andVerhey,L.J. Multileafcollimatorleafsequenc-
ogyinRadiationOncology. TheOncologist,1999.
ingalgorithmforintensitymodulatedbeamswithmulti-
Teng,L.,Wang,B.,Xu,X.,Zhang,J.,Mei,L.,Feng,Q.,and plestaticsegments. MedicalPhysics,1998.
Shen,D. Beam-wisedosecompositionlearningforhead
Yang, Z., Zhang, K., Hong, M., and Bas¸ar, T. A finite
andneckcancerdosepredictioninradiotherapy. Medical
sample analysis of the actor-critic algorithm. In IEEE
ImageAnalysis,2024.
conferenceondecisionandcontrol,2018.
Teoh,M.,Clark,C.H.,Wood,K.,Whitaker,S.,andNisbet,
Younge,K.C.,Matuszak,M.M.,Moran,J.M.,McShan,
A.Volumetricmodulatedarctherapy:Areviewofcurrent
D. L., Fraass, B. A., and Roberts, D. A. Penalization
literatureandclinicaluseinpractice. BritishJournalof
ofaperturecomplexityininverselyplannedvolumetric
Radiology,2011.
modulatedarctherapy. Medicalphysics,2012.
Unkelbach,J.,Bortfeld,T.,Craft,D.,Alber,M.,Bangert,
Yu,C.,Velu,A.,Vinitsky,E.,Gao,J.,Wang,Y.,Bayen,A.,
M., Bokrantz, R., Chen, D., Li, R., Xing, L., Men, C.,
andWu,Y. Thesurprisingeffectivenessofppoincooper-
etal. Optimizationapproachestovolumetricmodulated
ativemulti-agentgames. AdvancesinNeuralInformation
arctherapyplanning. Medicalphysics,2015.
ProcessingSystems,2022.
Varian. RapidPlan Knowledge-Based Plan-
Yuan,Z.,Wang,Y.,Hu,P.,Zhang,D.,Yan,B.,Lu,H.-M.,
ning — Varian, 2023a. URL https:
Zhang,H.,andYang,Y. Acceleratetreatmentplanning
//www.varian.com/products/
processusingdeeplearninggeneratedfluencemapsfor
radiotherapy/treatment-planning/
cervicalcancerradiationtherapy. MedicalPhysics,2022.
rapidplan-knowledge-based-planning.
Accessed: 2023-10-12. Zhang,K.,Yang,Z.,andBas¸ar,T. Multi-agentreinforce-
mentlearning: Aselectiveoverviewoftheoriesandalgo-
Varian. Treatment planning, 2023b. URL
rithms. Handbookofreinforcementlearningandcontrol,
https://www.varian.com/products/
2021.
radiosurgery/treatment-planning. Ac-
cessed: 2023-10-14.
12MARLMeetsLeafSequencinginRT
Appendix
AppendixAintroducesthebackgroundofradiotherapytoreaderswhodonothavemuchbackgroundinradiotherapy. We
includecartoonillustrations,explanationsofterminologiesinAppendixA.1,andasummaryofmathematicalsymbolsin
AppendixA.2.
AppendixBprovidesamoredetailedintroductiontotheplanningenvironmentPORIx.
AppendixCincludesmorehyperparameterscomparedtothemaintext.
AppendixDdetailsthenetworkstructuresofourmodel.
AppendixEintroducestheothermodules(exceptforleafsequencing)inthefull-AIend-to-endplanningpipeline,andthe
considerationsofevaluatingleafsequencingin3Ddosespaceandcomparisonwithdosepredictionmetrics(Table3).
AppendixFincludesmoredetailsofrewardcomponentsandtheirPyTorchstylepseudocode.
AppendixGdetailsthedatasets.
AppendixHshowsmultipleexamplesoftheoptimizationcostcurveofPORIx,comparingtheproposedRLS,RLSwithout
cropping,andtheoptimizationsequencerinPORIx.
AppendixIincludesadditionalexamplesillustratingreconstructionerrors.
13MARLMeetsLeafSequencinginRT
A.IntroductiontoRadiotherapy
Inthissection,weofferacomprehensiveoverviewofradiotherapyconceptsrelevanttoourresearch. Ouraimistoassist
readersinunderstandingourworkfromamachinelearningstandpoint,eveniftheylackabackgroundinradiotherapy.
Explanations of related terminology and mathematical symbols are summarized in Appendix A.1 and A.2. Cartoon
illustrationsoftheradiotherapymachineandMLC/fluencesareshowninFigure12and13,respectively.
Gantry
Multileaf collimator
X-raybeam
Isocenter (red spot)
Patient laydown table
Figure12.Cartoonillustrationofatypicalradiotherapymachine.Themachinefigure(excepttheannotations)isborrowedfrom(Society,
2024).ThemultileafcollimatorisconnectedwithconceptinFigure13.
PTV projection leaf (2D) leaf (3D) fluence intensity in one bixel
Restricted © Siemens Medical Solutions USA, Inc., 2022
X-ray
Page 4
(d) cartoon fluence
Target Fluence
Cumulated Fluence Cumulated Fluence
(a) multi-leaf pairs in 2D (b) one-leaf pair in 3D (c) one-leaf pair fluences (e) real fluence
Figure13.CartoonillustrationofMLCandfluences,anextensionfigureofFigure3inthemaintext.(a)showsmulti-leafpairsin2D
representingMulti-leafCollimatorandPTVprojectionswhenobservedfromthedirectionofradiationsource.(b)providesa3Dviewof
aleafpairanditsconnectiontocumulatedfluences.(c)illustratesmotivationsofReward1(green)andReward2(red)bycomparing
cumulatedandtargetfluences.(d)showsacartoonillustrationoffluencesfrommulti-leafpairs,and(e)representsarealfluencemap.
A.1.Aberrations,ExplanationsofTerminologies
Radiotherapy(RT):alsoknownasradiationtherapy,itisoneoftheprimarymedicaltreatmentsthatuseshigh-energy
radiation(suchasphotons,electrons,orprotons)totargetandkillcancercellsorshrinktumors. Thegoalofradiation
therapyistodamagetheDNAinsidethecancercells,preventingthemfromgrowinganddividing,whileminimizingdamage
tonearbyhealthycells. TherearetwotypesofRT:ExternalBeamRadiationTherapyandInternalRadiationTherapy. In
X-ray
thispaper,wemainlyfocusonphotonExternalBeamRadiationTherapy.
Radiotherapy Planning (RTP): In radiation oncology, radiotherapy planning is a precise process that strategically
administersradiationtotreatconditionssuchascancer,withthegoalofmaximizingtumordestructionwhileminimizing
Target Fluence
14
Cumulated Fluence Cumulated Fluence
(a) multi-leaf pairs in 2D (b) one-leaf pair in 3D (c) cumulated vs. targetMARLMeetsLeafSequencinginRT
damagetoadjacenthealthytissues. InphotonExternalBeamRadiationTherapy,theplanningtaskinvolvesoptimizing
incomingfields/sectorsfromdifferentdirections.
VolumetricModulatedArcTherapy(VMAT)andIntensity-ModulatedRadiationTherapy(IMRT):VMATandIMRT
aretwomajormodernradiotherapytreatments,bothaimingforprecisedosedelivery. Insomeliterature,VMAThasbeen
broadlycategorizedunderIMRT.TheillustrationsofVMATandIMRTaresummarizedinFigure2. Thegantryisstaticfor
IMRTanddynamicforVMATduringX-raydelivery.
PlanningTargetVolume(PTV):Athree-dimensional(3D)volumedelineatedonspecificmedicalplanningimages(e.g.,
CTimages), outliningtheregionwheretheprescribeddoselevelistargetedtoachievethedesiredtumorcontrol. The
PTVgenerallyencompassesthevisuallyidentifiedtumor,adjacenthealthytissueatahighriskofharboringproliferative
cancercells,andgeometricmarginstoaccommodatepositioninginaccuraciesbetweentheplanningimagesandthepatient’s
anatomyduringtreatment.
OrganatRisk(OAR):Thistermreferstoanyhealthyorganortissue(suchastheheart,lung,eye,bladder,etc.) located
inproximitytotheregionundergoingradiationtreatment,andwhichcouldpotentiallyexperienceadverseeffectsdueto
exposuretoradiation.
RTDose: Alsoknownas3DDoseorDosewithinthecontextofthispaper,itdenotestheprecisequantityofradiation
administeredtoaPlanningTargetVolume(PTV)withinapatient’sbodythroughoutacourseofradiationtreatment. This
measurementrepresentstheabsorbedamountofradiationenergybythetissuesundergoingtreatment. RTDoseisa3D
matrixthatsharesthesameshapewithCTandROIcontours.
Fluence Map: This term refers to a depiction of the intensity of a radiation beam across the treatment field. It is a
two-dimensional(2D)mapthatvisualizeshowtheradiationdoseisdistributedacrossaspecificcross-sectionalareaofthe
patient’sbody. Fluencemapsplayacrucialroleincontemporaryradiationtherapytreatmentplanninganddelivery.
Isocenter: Theisocenterisdeterminedduringthetreatmentplanningprocess,wheremedicalprofessionalsuseimaging
techniquessuchasCTscanstoidentifythetumor’slocationanddefinethetreatmentvolume. Oncethetreatmentplan
isestablished,thelinearacceleratororotherradiationdeliveryequipmentisadjustedtoensurethatthebeamsintersect
preciselyattheisocenter.
ControlPoint: Thistermdenotesaspecifictimepointintheadministrationofradiationtherapy. Thedetailsofacontrol
pointencompassthepositionsofallleafpairsandthemonitorunitatthatspecifictimepoint.
MultileafCollimator(MLC):Positionedincloseproximitytothepatient’sbodyandsituatedinthepathoftheradiation
beam,theMLCplaysakeyroleinshapingandcontrollingtheradiationbeam. Itsprimaryfunctionistoenablepreciseand
conformalradiationtreatment,facilitatinghighlytargeteddelivery.
Leaf: TheMLCconsistsofaseriesofindividual“leaves”or“slats”arrangedinpairs. Theseleavesaretypicallymadeof
high-densitymaterial,suchastungsten,toeffectivelyblocktheradiation.
PhotonOptimizerResearchInterfacefromVarian(PORIx): AnoptimizerforphotonVMATplanningthatprovidesan
interfaceforthenecessarycomponentsforRLagenttraining: theimplementedcallbacksoftheinterfaceallowsuserto
replacethepredictioninthePORIxsotheAImodelcanbeevaluatedinthisenvironment. MoredetailsareinSectionBand
Figure14.
Main Optimization Cost: This term originates from the cost callbacks provided by PORIx, where it represents the
dosimetriccostderivedfromtheintermediatedoseanddoseobjectivesforeachiterationintheoptimizationprocess. In
Figure8and15,the“mainoptimizationcost”servesasthey-axis.
15MARLMeetsLeafSequencinginRT
A.2.SummaryofMathematicalSymbols
DifferentIndices:
k: indexofcontrolpoints,thenumberofcontrolpointsofafluencemapisK.
x: indexofleafagents,thenumberofleafagentsofafluencemapisX.
y: indexoftheseconddimensionoffluencemaps,theseconddimensionoffluencemapisY,indicatingtherangeofleaf
positionsis[0,Y].
FluenceMap. ThetargetfluenceisdenotedasF hasthesizeofX×Y. Thepartoffluenceassociatedtothex-thleafpair
isdenotedasF . ThepredictedfluenceistermedFˆ. Thek-thcumulatedfluenceistermedasFˆk,whichiscumulatedfrom
x
CP toCP ,theunitfluenceofCP istermedasF˜k,soFˆk =P Mk·F˜k. GivenK controlpointsforthetargetfluence,
1 k k
wehaveFˆ =FˆK.
3DDose. Tntheend-to-endAIpipeline. thereferencedoseistermedasD,andpredicteddoseisDˆ.
LeafPair. Tnaleafpair,theleafwithsmallerindexistermedasAandtheotherisB. Thepositionofx-thleafpairatk-th
controlpointistermedas(Ak,Bk).
x x
ControlPoint: denotedasCP. AfluenceisassociatedwithK controlpoints,andk-thcontrolpointistermedasCP .
k
MonitorUnit: termedasM. Themonitorunitatk-thcontrolpointisMk.
LeafPolicy: termedasπ . Allleafpairssharethesameleafpolicy.
θl
MUPolicy: termedasπ .
θm
CriticNet: termedasV .
ϕ
Reward: thetotalrewardistermedasR,andRewardiistermedasR . AstheshownintheEq. 2,therewardsrelatedto
i
x-thleafpairisRk.
i
Environment: istermedasEnv,whichfollowsradiotherapy-relatedcomputationsinPORIx.
Expection: istermedasEˆ[·].
SigmodFunction: istermedasσ(·).
IndicatorFunction. Inthispaper,1(·)isdefinedas
(
1 ifx>0,
1 (x)=
(0,∞)
0 ifx≤0.
16MARLMeetsLeafSequencinginRT
B.IntroductionofPORIx
PhotonOptimizerResearchInterface(PORIx)originatesfromaprominentcommercialcompany,VarianMedicalSystems,
aSiemensHealthineerscompany. TheframeworkofPORIx3isdepictedinFigure14. Thisresearchinterfaceisadeptat
generatingradiotherapy(RT)plansthroughscripting. Callbackswithintheinterfaceallowuserstosubstitutepredictions,
facilitatingtheevaluationofAImodelswithinthePORIxenvironment. Itisworthnotingthatclinicalplanningisacomplex
and often subjective process, involving experts with diverse backgrounds. Various metrics and considerations may be
includedforplanningoptimization,beyondthemetricsusedinthispaper.
Inthisstudy,ourfocuscentersonassessingtheleafsequencingfunctionswithintheinitial100iterations. Duringthisphase,
thenumberofcontrolpointsinonesectorisfixedateither16or10,similartotheVMATphotonoptimizationinVarian’s
Eclipse. Themainfocusinthispaperisonthefirst-levelresolutionofthemulti-resolutionoptimizationandnomanual
interventionduringoptimization.
Onepotentialfutureworkcouldinvolveinitiatingtheplanningprocesswithdeeplearningplans,whichofferrapidand
automatedsolutions,followedbyalimitednumberofhuman/optimizationinterventionsteps. Thisapproachmaypromisea
fasterandmoreefficientpathcomparedtoconventionalmethodsthatstartfromscratch,whilealsoleadingtosafeplans
approvedbyexperts.
Executable (.exe)
A set of binaries
for binary data
creation
output
PORIxpython wrapper:
Upon 3D Dose,
1. VMAT Optimizer,
CT images (.dcm) convergence
s DVHs, …
U 2. A set of callbacks
Structures (.dcm) M
/s
Parameters (.json): n
o
• Plan objectives,
itis
o
Current target Current Current leaf
p fluence maps MUs positions
• Field geometry,
fa
e
l
d
e
• … ta Leaf Sequencing Optimizer
d
p
input U
Figure14.IllustrationofRTplanningwithPORIx.TheinputoftheplanningincludesCT,RTstructures,andasetofplanningparameters.
ThePORIxisapythonwrapperofVMAToptimizerwithasetofcallbacksthatcanprovidetargetfluences,monitorunits,andleaf
positionsoftheiterations.LeafSequencingOptimizerisanotheroptimizationlayerforleafsequencingonly.OurRLScanreplacethe
LeafSequencingOptimizermoduletogetanAI-integratedsolution.NoteourRLSdonottakeMUs/leafpositionsfrompreviousiteration
whichcanworkbeyondaoptimizationenvironment.
Page 1
Weestimatethecomputationalrequirements(GPUmemoryoccupation)ofRLSandwholeplanningpipelines,asinTable6.
TheRLSitselfiscomputationallyefficientduetothelightweightnetworkstructuredescribedinAppendixD,anditdoes
notposeabottleneckwithinend-to-endpipelines.
Model EstimatedGPUmemoryoccupation
RLS ∼0.35GB
AIE2Epipeline(dose/fluenceprediction+RLS) ∼2.8GB
PORIxpipeline ∼3.0GB
Table6.EstimatedGPUmemoryoccupationwhenrunningindifferentcontexts.Disclaimer:Thecomparisonisbasedonsettingsinthis
study,thenumbercanbevariedwhenthesettingsaredifferent.
3OurexperimentsarebasedonaversionofPORIxin2023.Somefeaturesmayvaryacrossdifferentversions.
17MARLMeetsLeafSequencinginRT
C.AdditionalSettingsandHyperparameters
#--------------------------------- General Parameters ---------------------------------#
deep learning platform: PyTorch 1.13
GPU type: NVIDIA RTX A4500
RL iterations: 20000 # similar concept as args.num_iterations in CartPolePPO of CleanRL
Update epochs: 2 # similar concept as args.update_epochs in CartPolePPO of CleanRL
batch_size: 96
#---------------------------------- Parameters for Environment -----------------------#
number of leaf agents: 50
max movement of leaf: 4
number of steps in an episode of training: 16
monitor unit range: 0.5 to 2.5
Reward 1 ratio: 1
Reward 2 ratio: 2
Reward 3 ratio: 2
Reward 4 ratio: 1
Reward 5 ratio: 1
#-------------------------------- Parameters for Loss Functions -----------------------#
discount factor gamma: 0.99
GAE lambda: 0.95
toggles advantages normalization: True
surrogate clipping coefficient: 0.2
clip value loss: True
entropy coefficient: 0.01
maximum norm for the gradient clipping: 0.5
#-------------------------------- Parameters for Optimizer ---------------------------#
learning rate: 1e-4
weigth decay: 1e-4
optimizer: AdamW
optimizer scheduler: CosineAnnealingLR
18MARLMeetsLeafSequencinginRT
D.DetailsofNetworkStructures
LeafActor:
----------------------------------------------------------------
Layer type Output Shape Param #
================================================================
Input [-1, 205] 0
Linear-1 [-1, 512] 105472
ELU-1 [-1, 512] 0
Linear-2 [-1, 512] 262656
ELU-2 [-1, 512] 0
Linear-3 [-1, 512] 262656
ELU-3 [-1, 512] 0
Linear-4 [-1, 512] 262656
ELU-4 [-1, 512] 0
Linear-5 [-1, 18] 9234
ELU-5 [-1, 18] 0
================================================================
Total params: 902674
Trainable params: 902674
----------------------------------------------------------------
MUActor:
----------------------------------------------------------------
Layer type Output Shape Param #
================================================================
Input [-1, 205] 0
Linear-1 [-1, 512] 105472
ELU-1 [-1, 512] 0
Linear-2 [-1, 512] 262656
ELU-2 [-1, 512] 0
Linear-3 [-1, 512] 262656
ELU-3 [-1, 512] 0
Linear-4 [-1, 2] 1026
ELU-4 [-1, 2] 0
================================================================
Total params: 631810
Trainable params: 631810
----------------------------------------------------------------
Critic:
----------------------------------------------------------------
Layer type Output Shape Param #
================================================================
Input [-1, 205] 0
Linear-1 [-1, 512] 105472
ELU-1 [-1, 512] 0
Linear-2 [-1, 512] 262656
ELU-2 [-1, 512] 0
Linear-3 [-1, 512] 262656
ELU-3 [-1, 512] 0
Linear-4 [-1, 512] 262656
ELU-4 [-1, 512] 0
Linear-5 [-1, 1] 513
ELU-5 [-1, 1] 0
================================================================
Total params: 893953
Trainable params: 893953
----------------------------------------------------------------
19MARLMeetsLeafSequencinginRT
E.TheFull-AIEnd-to-end(E2E)Pipeline
E.1.IntroductionofOtherModules
DosePrediction. Dosepredictionwithdeeplearningisarelativelywell-studiedtopic. Itcanbeconsideredanextensionof
planningobjectivespredictioncomparedtothedotobjectivesinconventionaloptimizationorlineobjectivesinRapidPlan.
Inmostliterature,theinputofthismoduleincludestheCTandmasksofPTV/OARs(alongwithotherauxiliaryconditions),
andtheoutputistheestimated3Ddoserequiredforcancertreatment.
Inthiswork,thedosepredictionmoduleistrainedinaconditionalGANframework,inspiredbyGaoetal.(2023);Kearney
etal.(2020). Theadversarialtrainingistomakethepredicted3Ddoserealistic. Intheend-to-endAIpipeline,thisdose
predictionmoduleservesasthedoseobjectivesdefinitionasinFigure1.
FluencePrediction. Afterobtainingthe3Ddose,wepredictthisfluencemapofeachbeamangleasa2Dintensitymap.
ThismoduleismotivatedbyWangetal.(2020)andwehavemadesignificantchangestoextendthefluencemapprediction
forVMAT.Thefluencepredictionmodulepredictsallfluencemapsjointly,whoseinputisprojectionsofthe3Ddosemap
tothebeam’seyeviewofgantryangles. Intheend-to-endAIpipeline,thisdosepredictionmoduleservesastheoptimal
fluencepredictionasinFigure1. FollowingasimilarsettinginPORIxthatmultiplecontrolpointscontributetoeachfluence,
theresolutionoftargetfluencesintheVMATcontextiseightcontrolpointsperfluenceexceptthebeginningandending
fluencesisninecontrolpoints(asinbottomofTable3). Afullarchas178controlpointsintotal,whichhasbeendivided
into22sectorsforleafsequencing.
The primary difference between this full-AI pipeline and frequently used optimization methods lies in its ability to be
executedinasingle(orfew)iteration(s),thustheformercanpotentiallyacceleratetheplanningprocesssignificantly. It
isimportanttonotethatthisfull-AIpipelineiscurrentlyinthepreliminarystageandmayyieldlowerqualityplansthan
commercialoptimizationplatforms. Also,somedetailedclinicalsettingsmaybesimplifiedinthisAIpipeline. Despitethese
considerations,weseethefull-AIpipelineasavaluabletestbed,particularlysincethisstudymainlyfocusesonevaluating
theleafsequencingmodule.
E.2.ConsiderationofTable3
TherationalebehindutilizingthedosepredictionrecordpresentedinTable3istoassesstheerrorscaleofourmodelby
comparingittoanextensivelystudiedtask(i.e.,doseprediction)inafull-AIend-to-endpipeline. Agoodmatchbetween
thetargetandpredictionindicatespromisingperformanceofRLSinthisend-to-endpipeline. Notably,thereiscurrentlyno
establishedreferenceintheliteratureforadirectcomparisonwithourmodelinsuchapipeline. Thedecisiontoreferto
theOpenKBPrecordisbasedonitsstatusasthemostwidelyrecognizedopenchallengeinradiotherapy,withresearchers
consistentlyupdatingandimprovingthetop-performingmodelsthroughopen-sourcedevaluations. Weacknowledgethose
two(i.e.,doseprediction(upperpartofTable3)andevaluationfluencepredictionin3Ddoseperspective(lowerpartof
Table3)4arenotthesametaskandshowtheirsimilarityanddifferencesbelow:
Similarity: boththosetwotasksareevaluatedbythedifferencebetweentwo3Ddosemapsbasedmodulesinradiotherapy
planworkflow.
Differences: asmentionedabove,theoutcomeindosepredictionisa3Destimationofdosedistribution,andthereisno
guaranteethatthemachinecanachievethepredicteddose. Contrastively,thetwodosesfromthesecondtaskareobtained
bythesamedosecalculationmethod(i.e.,AcurosXBofEclipse5)andthetarget/predictionfluences. Fundamentally,thisis
forevaluatingtheperformanceofleafsequencingbutusinganauxiliaryway. Thepredicteddoseofthismoduleismachine
executable.
4Thenumberoftestpatientsforend-to-endpipelineis64sincetreatmentconfigurationsofsomepatientsarenotapplicableto
dose/fluencepredictionmodules.
5https://www.varian.com/products/radiotherapy/treatment-planning/eclipse
20MARLMeetsLeafSequencinginRT
F.Details/Pseudo-CodeofRewards
ThissectionprovidessupplementaryinformationforrewardsinSection4.1. Thetrade-offbetweenreconstructionaccuracy
andotherclinicallyrelevantfactorsiscarefullyconsideredinthedesignofrewards. Specifically,Reward1and2areto
guideagentstoreconstructthetargetfluence,andReward3,4,and5takeintoaccountvariousclinicalconsiderations.
Reward1. AsdepictedinFigure13c,thegreenpartsindicatetheReward1,whichpushesthecumulativefluencecloserto
targetfluence.
Reward2. AsdepictedinFigure13c,theredpartsindicateReward2,whichpunishesagentsiftheintensityofcumulative
fluenceexceedsthatoftargetfluence.
Reward3: avoidingcrossleaves. Thisrewardcomponentistoencouragetheagenttoavoidpredictionswhereleft-and
right-leafpositionsintersect,whichviolatesthephysicallaws. Inadditiontothis,theenvironmentenforcesthatthefinal
leafpositionsdonotintersectanddonotextendbeyondtheradiationfields.
Reward 4: smoothness of actions (Leaf/MU change between control-points). Ensuring smooth change in leaf / MU
configurationisnecessaryassignificantorsuddenchangesinleafpositionsmaycausemachineinstability. Wedemonstrated
thatbytuningtheweightofthereward(Figure11),ourmodelallowsuserstobalancebetweenthemaximumleafspeed
(machine-dependentparameter)andthereconstructionperformance.
Reward5: apertureshaperegularizationmotivatedfromYoungeetal.(2012). AccordingtoYoungeetal.,volumetric
modulatedarctherapy(VMAT)planningoftenyieldssmall,irregularapertureshapes,leadingtodosimetricinaccuracies
duringdelivery. WeincludedthisregularizationasR5=areaofaperture/perimeterofaperturefollowingYoungeetal.
(2012).
BelowshowsthePytorch-stylepseudocodeoftherewards:
# MU: monitor unit, mask: unit fluence
# y_tail: leaf position of leaf A_x (i.e., the left leaf or the tail leaf)
# y_front: leaf position of leaf B_x (i.e., the right leaf or the front leaf)
rw1 = MU * torch.sum((tar_fluence - cumu_fluence >= MU) * mask, axis = 1)
cumu_fluence += mask * MU
rw2 = - torch.sum((tar_fluence - cumu_fluence < 0) * mask, axis=1)
rw3 = (y_front - y_tail > 0) - (y_front - y_tail < 0)
rw4 = 3 - sigmoid(delta_front) - sigmoid(delta_tail) - sigmoid(delta_MU)
rw5 = Aperture(y_front, y_tail)
21MARLMeetsLeafSequencinginRT
G.DatasetDescription
ThedatasetdistributionisdescribedinTable7. UnliketasksinotherAIfields(e.g.,computervisionornaturallanguage
processingtasksareusuallyeasytogetthousands,millions,orevenbillionsofdatasamples),RTplanningdataforresearch
useisrelativelylimited. MostRTPresearchrelatedtodeeplearningtypicallyinvolvesfewerthan500patients. Forexample,
thewell-studiedOpenKBPchallengeincludesonly340patients. Ourstudyisconductedonrelativelylarger-scaledata
resourceswithmorepatients.
DatasetName CancerSite #Patientafterfiltering train/val/test Availability
Datawillnotbepublicavailabledue
HNd head-and-neck 493 370/10/113
todataregularization
Public: www.cancerimagingarchive
HNe1 head-and-neck 31 0/0/31
.net/collection/hnscc-3dct-rt
Public: www.cancerimagingarchive
HNe2 head-and-neck 140 0/0/140
.net/collection/hnscc
Public with permission required (Seibold
Pros Prostate 555 471/10/84
etal.,2019)
Pros(e) thesamesetasPros,buttestresultsarereportedwhenmodeltrainedbyhead-and-necksite.
Table7.Thedescriptionofdatasetsusedinourexperiments.Notethatourexperimentisconductedatfluencelevel.Eachpatienthas
upto525targetfluences(within100iterationsoptimizationinPORIx).Comparedtooriginaldataset,somepatientsarefiltereddueto
missingdata,qualityissue,andincompatibilitywithenvironment/software.
Theexperimentsandevaluationsondifferentdatasets/sites/scenarios(e.g.,Table1and2)indicatethegeneralizabilityof
ourmodel. Furthermore,leafsequencingisexecutedatthefluence-level,encompassingasamplesizethatishundredsof
timeslargerthanthenumberofpatients. Ourmodelcanhaveareasonablygoodperformanceevenwhenthetrainingsizeis
smaller,asinTable8.
Model MNSE(↓)
PORIx 0.219
RLS(trainedwith50patients) 0.158
RLS(trainedwith100patients) 0.152
RLS(trainedwith370patients) 0.149
Table8. ThereconstructionerrorMNSEofdifferentnumberoftrainingpatients.
H.SupplementaryExamplesofCroppingAblations
AsshowninFigure15,thecroppingstrategyhelpedtheoptimizationintermsoffasterconvergence. Overall,ourRLScan
achievesmallererrorandfasterconvergenceespeciallyinearlyiterationsduringtheoptimization.
I.AdditionalExamplesIllustratingReconstructionErrors
ContinuedwithFigure7,wesupplementmoreanddetailedillustrationsoffluencereconstructioninFigure16. Figure16ato
Figure16hrepresentsexamplesfromeightdifferentpatients,where(a)-(f)arehead-and-neckcancercases,and(g)-(h)are
fromprostatecancersite. Foreachcase,thefivefiguresrepresenttargetfluence,predictedfluencefromRLS,difference
betweenRLSpredictionandtarget,predictedfluencefromPORIx,differencebetweenPORIxpredictionandtarget,
fromuptodown. Thereconstructionerrorisshownatrightbottom. RLSachievessmallererrorinthemajorityofcases.
22MARLMeetsLeafSequencinginRT
Figure15.Ablationstudywithvs.withoutcropping.ThemainoptimizationcostisfromcallbackofPORIxplanningenvironment.ours
1
denotesthatourRLShasreplacedtheleafsequencingoptimizerofPORIx.
Restricted © Siemens
Healthineers, 2024
23MARLMeetsLeafSequencinginRT
te
g
r
a
T
.d
e
r
P
S
L
R
NSE: .06 NSE: .04 NSE: .05 NSE: .07
.ffiD
S
L
R
.ffiD
x
IR
O
P
NSE: .20 NSE: .10 NSE: .10 NSE: .14
.d
e
r
P
x
IR
O
P
(a) (b) (c) (d)
te
g
r
a
T
.d
e
r
P
S
L
R
NSE: .02 NSE: .014 NSE: .023 NSE: .07
.ffiD
S
L
R
.d
e
r
P
x
IR
O
P NSE: .01 NSE: .018 NSE: .018 NSE: .04
.ffiD
x
IR
O
P
(e) (f) (g) (h)
Figure16.SupplementexamplesofFigure7inthemaintext.Weprovidedifferencemapsbetweenpredictedandtargetfluenceshere.
24